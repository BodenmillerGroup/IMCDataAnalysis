## An end-to-end workflow for multiplexed image processing and analysis

This folder of the repository contains the code to reproduce the analysis presented in the following paper:

```
TODO upon acceptance
```

### System requirements

To run the workflow, a computer with a recent version of a Windows, Mac, or Linux operating system (OS) is required. 
With increasing dataset size, more memory is required and we recommend at least 8 GB RAM to analyse the provided dataset. 
Alternatively, a high performance computer (e.g. cluster) can be used, provided Docker can be installed (see below). 
For this manuscript, the workflow was run on MacOS Big Sur (11.7.3), 2.7 GHz Quad-Core Intel Core i7, 16 GB 2133 MHz LPDDR3.

### Reproducing the analysis

**1. Obtain the code**

To access the code you can clone the repository via

```
git clone https://github.com/BodenmillerGroup/IMCDataAnalysis.git
```

or you can click the `Code` > `Download ZIP` button.

Navigate to the `IMCDataAnalysis/publication/` folder and open the 
`publication.Rproj` file in RStudio. 

**2. Obtain the example data**

To obtain the example data, open the [protocol.Rmd](protocol.Rmd) file in RStudio
and execute the first code chunk under `Example data`.

**3. Perform image processing**

Image processing is performed outside of R/RStudio. To process the example
data stored in `publication/data/steinbock`, open a terminal and execute the 
following commands:

```
# setup steinbock alias
alias steinbock="docker run -v /path/to/data/steinbock:/data -u $(id -u):$(id -g) ghcr.io/bodenmillergroup/steinbock:0.16.0"

# image pre-processing
steinbock preprocess imc images --hpf 50

# image segmentation
steinbock segment deepcell --minmax

# intensity measurement
steinbock measure intensities

# regionprops measurement
steinbock measure regionprops

# spatial cell graph construction
steinbock measure neighbors --type expansion --dmax 4
```

In the command above the `/path/to/data/steinbock` needs to be adapted and 
replaced by the anticipated working directory. 

To obtain more detailed installation instructions, please refer to the 
[steinbock documentation](https://bodenmillergroup.github.io/steinbock/latest/install-docker/).

A shell script for automatic execution of the commands can be seen at [steinbock.sh](steinbock.sh).

**4. Option A: Install R packages**

The workflow highlights the use of a number of R packages.
All packages can be installed as follows:

```
if (!requireNamespace("BiocManager", quietly = TRUE))
install.packages("BiocManager")

BiocManager::install(c("pheatmap", "viridis",
                       "tiff", "distill", "ggrepel", "patchwork",
                       "mclust", "RColorBrewer", "uwot", "Rtsne", "caret",                                                
                       "randomForest", "ggridges", "gridGraphics", "scales", 
                       "CATALYST", "scuttle", "scater", "dittoSeq", 
                       "tidyverse", "batchelor", "bluster","scran", "cytomapper", 
                       "imcRtools"))
```

To install the required software around 1-2 hours need to be taken into account.
When the workflow was written, we used R v4.2.2 installed and Bioconductor 
release version 3.16. 

Please see [protocol.md](protocol.md#session-information) for the exact versions of the software
packages.

**4. Option B: Obtain docker container**

We provide a Docker container that can be used to exactly reproduce the 
analysis performed in the protocol. To obtain the Docker container execute the
following call in the terminal:

```
docker pull ghcr.io/bodenmillergroup/imcdataanalysis:2023-02-11
```

After obtaining the Docker container, start it by calling:

```
docker run -v /path/to/IMCDataAnalysis/publication:/home/rstudio/publication \
	-e PASSWORD=bioc -p 8787:8787  \
	ghcr.io/bodenmillergroup/imcdataanalysis:2023-02-11
```

Please make sure to adapt the `/path/to/IMCDataAnalysis/publication` to the correct working directory.
An RStudio server session can be accessed via a browser at `localhost:8787` using `Username: rstudio` and` Password: bioc`.

**5. Execute the workflow**

Open RStudio, navigate to `publication` and open the `publication.Rproj` file.
The `protocol.Rmd` file contains all relevant code to reproduce the analysis.
When `knitting` the `protocol.Rmd` you will be asked to update the `markdown`
package. Accept the pop up and the workflow will run.

Applying the workflow to the provided dataset takes roughly 30 minutes and 
provides the raw data files, data generated by the `steinbock` toolkit 
and a `SpatialExperiment` object storing all analysis results.

### Software used for the entire protocol

* **napari & napari-imc (IMC-specific):** The multi-dimensional image viewer napari  (https://napari.org) together with the napari-imc plugin for loading imaging mass cytometry files (https://github.com/BodenmillerGroup/napari-imc) were used to visualize and inspect raw multiplexed imaging data. Python 3.9.12 (https://www.python.org), napari 0.4.16, and napari-imc 0.6.5 were installed into a fresh conda (https://conda.io) environment; see below for installation instructions.
* **steinbock Docker container:** The multi-channel image processing toolkit steinbock  (https://bodenmillergroup.github.io/steinbock) was used to pre-process multiplexed imaging data, perform image segmentation, and extract single-cell data. The steinbock Docker container v0.16.0 was pulled from the GitHub container registry using Docker Desktop 4.9.0 for Mac; see below for installation instructions.
* **Ilastik/CellProfiler-based segmentation pipeline:** Multiplexed image processing using random forest-based pixel classification and watershed-based cell segmentation was performed using the Ilastik/CellProfiler-based segmentation pipeline v3.4 (https://bodenmillergroup.github.io/ImcSegmentationPipeline/); see below for installation instructions.

In addition, in order to use the pipeline, the following software need to be installed:
* **Ilastik:** The Ilastik software is used for pixel-classification prior to cell segmentation and can be installed from https://www.ilastik.org/download.html. The version used for this workflow is v1.3.3post3.
* **CellProfiler:** The CellProfiler software is used to segment individual cells. The tool can be installed from https://cellprofiler.org/previous-releases on Windows (64-bit) and MacOS (10.14+). The version used in this workflow is v4.2.1.
* **R setup:** Downstream analysis after image processing is conducted using the statistical programming language R, which can be installed from https://cran.r-project.org/ following the OS-specific instructions. The version used in this workflow is v4.2.2. 
* The RStudio software offers an easy-to-use GUI for data analysis in R. It can be installed from https://www.rstudio.com/products/rstudio/download/.

### Installation instructions

* **napari & napari-imc:** Install the conda package manager according to the instructions at https://docs.conda.io/projects/conda/en/latest/user-guide/install/ 
Create a new conda environment with Python 3.9:
```
conda create -n napari-imc python=3.9
```
Activate the conda environment and install napari & napari-imc:
```
conda activate napari-imc
pip install “napari[all]==0.4.16” napari-imc==0.6.5
```
* **steinbock:** Instructions to install the dockerized steinbock toolkit can be found at https://bodenmillergroup.github.io/steinbock/v0.16.0/install-docker/. In particular, to run the steinbock container, Docker needs to be installed first (see online instructions). For this manuscript, we run steinbock using the following alias:
```
alias steinbock="docker run -v /path/to/data/steinbock:/data -u $(id -u):$(id -g) ghcr.io/bodenmillergroup/steinbock:0.16.0"
```
CRITICAL: In the command above the `/path/to/data/steinbock` needs to be adapted and replaced by the anticipated working directory. 

* **Ilastik/CellProfiler-based segmentation pipeline:** the pre-processing steps of the pipeline are performed in Python using a custom script. To setup the pre-processing script, the following steps need to be performed:

Install conda from https://docs.conda.io/projects/conda/en/latest/user-guide/install/

Clone the repository
```
git clone --recursive https://github.com/BodenmillerGroup/ImcSegmentationPipeline.git
```
Setup the imcsegpipe conda environment:
```
cd ImcSegmentationPipeline
conda env create -f environment.yml
```

Configure CellProfiler to use the required plugins by opening the CellProfiler GUI, selecting Preferences and setting the CellProfiler plugins directory to `path/to/ImcSegmentationPipeline/resources/ImcPluginsCP/plugins` and restart CellProfiler. 
