# Batch effect correction {#batch-effects}

In Section \@ref(cell-quality) we observed staining/expression differences
between the individual samples. This can arise due to technical (e.g.,
differences in sample processing) as well as biological (e.g. differential
expression between patients/indications) reasons. However, the combination of these effects
hinders cell phenotyping via clustering as highlighted in Section \@ref(clustering).

To integrate cells across samples, we can use computational
strategies developed for correcting batch effects in single-cell RNA sequencing
data. In the following sections, we will use functions of the
[batchelor](https://www.bioconductor.org/packages/release/bioc/html/batchelor.html),
[harmony](https://github.com/immunogenomics/harmony) and
[Seurat](https://satijalab.org/seurat/articles/integration_introduction.html)
packages to correct for such batch effects.

Of note: the correction approaches presented here aim at removing any
differences between samples. This will also remove biological differences
between the patients/indications. Nevertheless, integrating cells across samples
can facilitate the detection of cell phenotypes via clustering.

First, we will read in the `SpatialExperiment` object containing the single-cell
data.

```{r read-data-batch-correction, message=FALSE}
spe <- readRDS("data/spe.rds")
```

## fastMNN correction

The `batchelor` package provides the `mnnCorrect` and `fastMNN` functions to
correct for differences between samples/batches. Both functions build up on
finding mutual nearest neighbors (MNN) among the cells of different samples and
correct expression differences between the cells [@Haghverdi2018]. The `mnnCorrect` function 
returns corrected expression counts while the `fastMNN` functions performs the 
correction in reduced dimension space. As such, `fastMNN` returns integrated
cells in form of a low dimensional embedding.

Paper: [Batch effects in single-cell RNA-sequencing data are corrected by matching mutual nearest neighbors](https://www.nature.com/articles/nbt.4091)  
Documentation: [batchelor](https://www.bioconductor.org/packages/release/bioc/vignettes/batchelor/inst/doc/correction.html)

### Perform sample correction

Here, we apply the `fastMNN` function to integrate cells between 
patients. By setting `auto.merge = TRUE` the function estimates the best 
batch merging order by maximizing the number of MNN pairs at each merging step. 
This is more time consuming than merging sequentially based on how batches appear in the 
dataset (default). We again select the markers defined in Section \@ref(cell-processing)
for sample correction.

The function returns a `SingleCellExperiment` object which contains corrected
low-dimensional coordinates for each cell in the `reducedDim(out, "corrected")`
slot. This low-dimensional embedding can be further used for clustering and
non-linear dimensionality reduction. We transfer the corrected coordinates
to the main `SpatialExperiment` object.

```{r, echo=FALSE}
start_time <- Sys.time()
```

```{r batch-correction-fastMNN, message=FALSE, warning=FALSE}
library(batchelor)
set.seed(220228)
out <- fastMNN(spe, batch = spe$patient_id,
               auto.merge = TRUE,
               subset.row = rowData(spe)$use_channel,
               assay.type = "exprs")

# Transfer the correction results to the main spe object
reducedDim(spe, "fastMNN") <- reducedDim(out, "corrected")
```

```{r, echo=FALSE}
end_time <- Sys.time()
```

The computational time of the `fastMNN` function call is 
`r round(as.numeric(difftime(end_time, start_time, units = "mins")), digits = 2)` minutes.

### Quality control of correction results

The `fastMNN` function further returns outputs that can be used to assess the
quality of the batch correction. The `metadata(out)$merge.info` entry collects
diagnostics for each individual merging step. Here, the `batch.size` and
`lost.var` entries are important. The `batch.size` entry reports the relative
magnitude of the batch effect and the `lost.var` entry represents the percentage
of lost variance per merging step. A large `batch.size` and low `lost.var`
indicate sufficient batch correction.

```{r batch-correction-fastMNN-QC, message=FALSE}
merge_info <- metadata(out)$merge.info 

DataFrame(left = merge_info$left,
          right = merge_info$right,
          batch.size = merge_info$batch.size,
          max_lost_var = rowMax(merge_info$lost.var))
```

We observe that Patient4 and Patient2 are most similar with a low batch effect. 
Merging cells of Patient3 into the combined batch of Patient1,
Patient2 and Patient4 resulted in the highest percentage of lost variance and
the detection of the largest batch effect. In the next paragraph we can
visualize the correction results.

### Visualization

The simplest option to check if the sample effects were corrected is by using
non-linear dimensionality reduction techniques and observe mixing of cells across
samples. We will recompute the UMAP embedding using the corrected
low-dimensional coordinates for each cell.

```{r dimred-batch-correction-fastMNN, message=FALSE, warning=FALSE}
library(scater)

set.seed(220228)
spe <- runUMAP(spe, dimred= "fastMNN", name = "UMAP_mnnCorrected") 
```

Next, we visualize the corrected UMAP while overlaying patient IDs.

```{r visualizing-batch-correction-fastMNN-1, message=FALSE, warning=FALSE, fig.height=3}
library(cowplot)
library(dittoSeq)
library(viridis)

# visualize patient id 
p1 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP before correction")
p2 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP_mnnCorrected", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP after correction")

plot_grid(p1, p2)
```

We observe an imperfect merging of Patient3 into all other samples. This
was already seen when displaying the merging information above.
We now also visualize the expression of selected markers across all cells 
before and after batch correction.

```{r visualizing-batch-correction-fastMNN-2, warning=FALSE, message=FALSE, fig.height=8}
markers <- c("Ecad", "CD45RO", "CD20", "CD3", "FOXP3", "CD206", "MPO", "SMA", "Ki67")

# Before correction
plot_list <- multi_dittoDimPlot(spe, var = markers, reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2, list.out = TRUE) 
plot_list <- lapply(plot_list, function(x) x + scale_color_viridis())
plot_grid(plotlist = plot_list) 

# After correction
plot_list <- multi_dittoDimPlot(spe, var = markers, reduction.use = "UMAP_mnnCorrected", 
                   assay = "exprs", size = 0.2, list.out = TRUE) 
plot_list <- lapply(plot_list, function(x) x + scale_color_viridis())
plot_grid(plotlist = plot_list) 
```

We observe that immune cells across patients are merged after batch correction 
using `fastMNN`. However, the tumor cells of different patients still cluster
separately.

## harmony correction

The `harmony` algorithm performs batch correction by iteratively clustering
and correcting the positions of cells in PCA space [@Korsunsky2019]. It
requires a matrix of transformed expression counts and internally performs
PCA before kmeans clustering. We will first create the expression matrix and
call the `HarmonyMatrix` function to perform the correction. 

Paper: [Fast, sensitive and accurate integration of single-cell data with Harmony](https://www.nature.com/articles/s41592-019-0619-0)  
Documentation: [harmony](https://portals.broadinstitute.org/harmony/index.html)

Similar to the `fastMNN` function, `harmony` returns the corrected
low-dimensional coordinates for each cell. These can be saved in the
`reducedDim` slot of the original `SpatialExperiment` object.

```{r, echo=FALSE}
start_time <- Sys.time()
```

```{r batch-correction-harmony, message=FALSE, warning=FALSE}
library(harmony)

mat <- t(assay(spe, "exprs")[rowData(spe)$use_channel,])

harmony_emb <- HarmonyMatrix(mat, spe$patient_id, do_pca = TRUE)

reducedDim(spe, "harmony") <- harmony_emb
```

```{r, echo=FALSE}
end_time <- Sys.time()
```

The computational time of the `HarmonyMatrix` function call is 
`r round(as.numeric(difftime(end_time, start_time, units = "mins")), digits = 2)` minutes.

### Visualization

We will now again visualize the cells in low dimensions after UMAP embedding.

```{r dimred-batch-correction-harmony, message=FALSE}
set.seed(220228)
spe <- runUMAP(spe, dimred = "harmony", name = "UMAP_harmony") 
```

```{r visualizing-batch-correction-harmony-1, message=FALSE, warning=FALSE, fig.height=3}
# visualize patient id 
p1 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP before correction")
p2 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP_harmony", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP after correction")

plot_grid(p1, p2)
```

And we visualize selected marker expression as defined above.

```{r visualizing-batch-correction-harmony-2, warning=FALSE, message=FALSE, fig.height=8}
# Before correction
plot_list <- multi_dittoDimPlot(spe, var = markers, reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2, list.out = TRUE) 
plot_list <- lapply(plot_list, function(x) x + scale_color_viridis())
plot_grid(plotlist = plot_list) 

# After correction
plot_list <- multi_dittoDimPlot(spe, var = markers, reduction.use = "UMAP_harmony", 
                   assay = "exprs", size = 0.2, list.out = TRUE) 
plot_list <- lapply(plot_list, function(x) x + scale_color_viridis())
plot_grid(plotlist = plot_list) 
```

We observe a more aggressive merging of cells from different patients compared
to the results after `fastMNN` correction. Important immune cell and epithelial
markers are expressed in distinct regions of the UMAP. 

## Seurat correction

The `Seurat` package provides a number of functionalities to analyze single-cell
data. As such it also allows the integration of cells across different samples.
Conceptually, `Seurat` performs batch correction similarly to `fastMNN` by
finding mutual nearest neighbors (MNN) in low dimensional space before
correcting the expression values of cells [@Stuart2019].

Paper: [Comprehensive Integration of Single-Cell Data](https://www.cell.com/cell/fulltext/S0092-8674(19)30559-8)  
Documentation: [Seurat](https://satijalab.org/seurat/index.html)

To use `Seurat`, we will first create a `Seurat` object from the `SpatialExperiment`
object and add relevant metadata. The object also needs to be split by patient
prior to integration.

```{r prepare-seurat, message=FALSE, warning=FALSE}
library(Seurat)
library(SeuratObject)
seurat_obj <- as.Seurat(spe, counts = "counts", data = "exprs")
seurat_obj <- AddMetaData(seurat_obj, as.data.frame(colData(spe)))

seurat.list <- SplitObject(seurat_obj, split.by = "patient_id")
```

To avoid long run times, we will use an approach that relies on reciprocal PCA
instead of canonical correlation analysis for dimensionality reduction and
initial alignment. For an extended tutorial on how to use `Seurat` for data
integration, please refer to their
[vignette](https://satijalab.org/seurat/articles/integration_rpca.html).

We will first define the features used for integration and perform PCA on cells
of each patient individually. The `FindIntegrationAnchors` function detects MNNs between
cells of different patients and the `IntegrateData` function corrects the
expression values of cells. We slightly increase the number of neighbors to be
considered for MNN detection (the `k.anchor` parameter). This increases the integration
strength.

```{r, echo=FALSE}
start_time <- Sys.time()
```

```{r seurat-correction, message=FALSE, warning=FALSE}
features <- rownames(spe)[rowData(spe)$use_channel]
seurat.list <- lapply(X = seurat.list, FUN = function(x) {
    x <- ScaleData(x, features = features, verbose = FALSE)
    x <- RunPCA(x, features = features, verbose = FALSE)
    return(x)
})

anchors <- FindIntegrationAnchors(object.list = seurat.list, 
                                  anchor.features = features,
                                  reduction = "rpca", 
                                  k.anchor = 20)

combined <- IntegrateData(anchorset = anchors)
```

```{r, echo=FALSE}
end_time <- Sys.time()
```

We now select the `integrated` assay and perform PCA dimensionality reduction.
The cell coordinates in PCA reduced space can then be transferred to the 
original `SpatialExperiment` object.

```{r message=FALSE, warning=FALSE}
DefaultAssay(combined) <- "integrated"

combined <- ScaleData(combined, verbose = FALSE)
combined <- RunPCA(combined, npcs = 30, verbose = FALSE)

reducedDim(spe, "seurat") <- combined@reductions$pca@cell.embeddings
```

The computational time of the `Seurat` function calls is 
`r round(as.numeric(difftime(end_time, start_time, units = "mins")), digits = 2)` minutes.

### Visualization

As above, we recompute the UMAP embeddings based on `Seurat` integrated results
and visualize the embedding.

```{r umap-seurat, message=FALSE, warning=FALSE}
set.seed(220228)
spe <- runUMAP(spe, dimred = "seurat", name = "UMAP_seurat") 
```

Visualize patient IDs.

```{r visualizing-batch-correction-seurat-1, message=FALSE, warning=FALSE, fig.height=3}
# visualize patient id 
p1 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP before correction")
p2 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP_seurat", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP after correction")

plot_grid(p1, p2)
```

Visualization of marker expression.

```{r visualizing-batch-correction-seurat-2, warning=FALSE, message=FALSE, fig.height=8}
# Before correction
plot_list <- multi_dittoDimPlot(spe, var = markers, reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2, list.out = TRUE) 
plot_list <- lapply(plot_list, function(x) x + scale_color_viridis())
plot_grid(plotlist = plot_list) 

# After correction
plot_list <- multi_dittoDimPlot(spe, var = markers, reduction.use = "UMAP_seurat", 
                   assay = "exprs", size = 0.2, list.out = TRUE) 
plot_list <- lapply(plot_list, function(x) x + scale_color_viridis())
plot_grid(plotlist = plot_list) 
```

Similar to the methods presented above, `Seurat` integrates immune cells correctly.
When visualizing the patient IDs, slight patient-to-patient differences within tumor
cells can be detected. 

Choosing the correct integration approach is challenging without having ground truth
cell labels available. It is recommended to compare different techniques and different
parameter settings. Please refer to the documentation of the individual tools
to become familiar with the possible parameter choices. Furthermore, in the following
section, we will discuss clustering and classification approaches in light of
expression differences between samples.

In general, it appears that MNN-based approaches are less conservative in terms
of merging compared to `harmony`. On the other hand, `harmony` could well merge
cells in a way that regresses out biological signals. 

## Save objects

The modified `SpatialExperiment` object is saved for further downstream analysis.

```{r save-objects-batch-correction}
saveRDS(spe, "data/spe.rds")
```

```{r testing, include=FALSE}
library(testthat)

expect_equal(reducedDimNames(spe), c("UMAP", "TSNE", "fastMNN", "UMAP_mnnCorrected", 
                                     "harmony", 
"UMAP_harmony", "seurat", "UMAP_seurat"))

expect_equal(dim(reducedDim(spe, "fastMNN")), c(47794L, 36L))

expect_equal(reducedDim(spe, "fastMNN")[100:130,], 
             structure(c(0.0555066864233038, -0.376685579206133, -0.252739525524294, 
-0.494775249273823, -0.356174222705103, 0.0943526799704246, -0.258244125426128, 
0.17733053556045, -0.193591777441388, -0.34414213194167, -0.278188983413437, 
-0.219325589487363, -0.311352297948213, -0.3071347511404, -0.319592525280579, 
0.0727360528269935, -0.115121987746013, 0.131544710131599, -0.19197259782372, 
0.207466113820364, -0.448757984064418, -0.142093142041906, 0.0397820688856459, 
-0.00946103924086473, -0.335140380527219, -0.137059173990885, 
-0.209314533911836, 0.083328345736069, 0.269113975452294, 0.25934754389491, 
-0.0494071609458677, -0.03277757992914, -0.00714236858566639, 
-0.0588414685784066, -0.118665902512576, -0.119851878685114, 
-0.0863547811818214, -0.0436730080653825, 0.119310255213287, 
0.0344314754388538, 0.00295489342559382, -0.0621008160301841, 
-0.0213738009363049, -0.187183083078128, -0.00846018088839704, 
-0.0862602215620694, 0.156584959494637, 0.010845738672516, -0.0102979194336108, 
0.0110015129443185, 0.107582520847604, -0.115195268992972, -0.0308356052430776, 
0.169365180946331, 0.126988452933187, -0.084679619756287, 0.109445225536363, 
-0.0476200624368492, 0.129103076065945, -0.0113683795780978, 
-0.0434178070823924, 0.135561871641459, -0.0693506631634602, 
-0.032745089179702, 0.0803698636945966, 0.0623667475566499, 0.0395667803556831, 
-0.0499985045005847, -0.000466990752991132, 0.103259894446939, 
0.0679063543439688, -0.0278518013124741, 0.13995295609706, 0.0165502865812364, 
-0.0215319720561734, 0.0304932570053306, 0.119499888589694, -0.0370986377014453, 
-0.035254217969479, 0.00334412016834993, 0.109454826560382, 0.111674491002359, 
0.11274808918986, 0.102601365181284, -0.0302005047150443, 0.124642616468368, 
0.082213736081858, 0.00742478169132453, -0.00413257966238543, 
-0.0870787166940583, -0.0441880191431006, 0.0145475686944579, 
0.0114743348719297, 0.156597106252765, 0.236094684929595, 0.0624306467014818, 
0.35222928404991, 0.221021392736712, 0.139925622826314, 0.176471539208473, 
0.0881778441632775, 0.165534657384001, 0.264827893851502, 0.0698299895575052, 
0.219548102979185, 0.26172471291336, 0.245748599685158, 0.0901808634048369, 
0.236597633611586, 0.145783611167993, -0.00265297083726961, 0.145254486227536, 
0.0377288399022407, 0.279687936807312, 0.0571158940434882, 0.188187501821003, 
0.0778106255994319, 0.155628012177307, 0.210823526048042, 0.203523838054161, 
0.275752688020208, 0.0195502386275715, 0.0317864714878125, 0.1742197523856, 
-0.0668470146477817, -0.232160629584981, -0.0239720559219636, 
-0.0447975063350989, -0.0753358624426747, -0.105904863902055, 
-0.147474038336105, -0.119224101386352, -0.110874147520981, -0.142206264168913, 
0.110009041331691, -0.0983318116165221, -0.0924303415617785, 
-0.136546265646411, -0.0776925782009158, -0.084288405153996, 
-0.156391421177066, 0.028809336380959, -0.180219792096697, 0.0408043560411387, 
0.0119228049862136, -0.0579981368021693, -0.18708123612231, -0.0152919413151484, 
-0.166885828550715, -0.141355653363779, -0.105349500485991, -0.129761199280287, 
0.034063636173466, 0.00620239392069386, -0.126074953403176, -0.154985253485034, 
0.0369843363332248, -0.114487228493788, 0.0489713934695954, -0.00352662161841694, 
-0.109461597800024, 0.00456622782079119, -0.0552997075380628, 
-0.0346161459717165, 0.0281913410460979, -0.122208157594649, 
0.0115774126039181, -0.0681433642016198, 0.0212631600460621, 
-0.0705445540842416, -0.00165198561308702, -0.0607366339393913, 
-0.0432681782467413, 0.0362397316916987, 0.17250333711553, 0.0227780056950953, 
-0.0417481747824128, -0.00928477714425667, -0.0685187496449616, 
-0.0252058105452113, 0.000989503381729828, 0.00193612240802368, 
-0.00770784814221706, 0.0843554729248644, 0.0924659277067344, 
-0.0331345581372428, 0.0228585731785492, -0.041659488806423, 
-0.113887686134824, -0.0268392129406744, -0.0187294686865063, 
0.0808791113636212, -0.0299244333912685, 0.0664903993758257, 
-0.0277622651615953, -0.0529582396028165, -0.157227427809114, 
-0.0116268003696154, 0.0151851108939859, -0.0263652525164598, 
-0.0839239610023141, -0.00116649528582346, -0.0388720309416186, 
-0.032100965262416, -0.0172384525131985, 0.0243456561698103, 
-0.0395818089239438, -0.0734473915773683, 0.00606533880850486, 
-0.0599786811546157, -0.0416836545077964, -0.00116627989320214, 
-0.0265780184739223, 0.0601217772050697, 0.0436982570882296, 
0.053996675478647, -0.0189362911432374, 0.0834014980758257, -0.0478390804031063, 
-0.022073171325216, 0.0464572450012615, -9.7018966106695e-05, 
0.08779463460023, -0.00786677438725836, 0.00156736249623647, 
-0.0277291631977698, -0.000518765713637069, 0.0197400894502881, 
0.0479480594058101, -0.0753295359198686, -0.0103612049012751, 
-0.0534208985196757, 0.00858059248724442, -0.0358827766818394, 
0.0331559924775585, 0.0353573280281194, -0.0967507889134125, 
0.0452225926391192, -0.0582218830798245, -0.0222010871467587, 
-0.0190691183540197, -0.0526995363617217, 0.00315511521691578, 
0.0190605445647278, 0.0718953652934983, -0.0174418513000796, 
-0.00284063087017703, -0.0203417384931714, -0.0998451684266217, 
-0.000302508984284219, -0.0274717671858856, -0.022638202927896, 
-0.0371074658381412, -0.0354593417703786, -0.00357006000803617, 
-0.0386871684122033, 0.00707047550651796, 0.0145288890636187, 
-9.2797390098051e-05, 0.034377686237492, 0.00872364092702175, 
0.00335050562466857, -0.0794627019788204, 0.00514437597898332, 
-0.0138561017776936, -0.0019711082381591, 0.0736689210499807, 
-0.0757897159336349, -0.0217091303284682, 0.0174304835434319, 
-0.0371528542301994, -0.0389338000989553, -0.0423080051318528, 
0.0300768817174605, 0.0414648922528544, -0.0160791054359554, 
-0.0244082440847644, -0.131572066530686, -0.0398751677647535, 
0.0186253777191777, 0.0207748642504333, 0.0460874943539005, -0.0321498110324417, 
-0.00083757582787888, 0.0606720164887457, 0.0319899145382058, 
-0.0108320613732278, 0.0290381113070736, 0.0555758111761573, 
0.0451503087749361, 0.0209707741182488, -0.0203450104309492, 
0.0107904583068999, -0.00848271783272349, -0.0308434381024664, 
0.0459375846997304, 0.0096692991760811, 0.0635695434110586, 0.0297989478568422, 
-0.0144335328679042, 0.00567969479114464, -0.0304347098084063, 
0.00595739949349468, -0.0158117351389341, 0.0552673078613484, 
0.0112873855130604, 0.00346522886637578, 0.0365445610679632, 
0.0318776558288788, 0.0136878168508317, 0.0596396634875325, 0.0423798373545362, 
0.0998519170885331, -0.0512762616348026, 0.0454852042685571, 
0.0326341537666389, 0.0666835746427936, 0.0309792414791656, 0.0424338943207334, 
0.0278651182223769, 0.0825793600777591, 0.0485401761343436, 0.0178582279971468, 
0.019524668748276, 0.0616202929184885, -0.0521813154221655, 0.0329639305710469, 
0.136356343890164, 0.0587557746017994, 0.0136696443931022, 0.0243013681780632, 
0.0705748479131586, 0.000818697718328871, 0.0491750312959397, 
0.0307726386747925, 0.0284943832909222, 0.0176256204231324, -0.0395038755282271, 
0.0469124374530145, 0.0472231808236455, 0.0304706744806539, -0.0804519559508666, 
-0.0346403916721901, -0.00190002808192576, -0.0424993503581432, 
0.0265912162968915, -0.0939154954313599, 0.0277151021241185, 
-0.146277512223971, 0.0823620937592942, -0.0514311230787555, 
0.00554837427513822, -0.00251849074097227, 0.00949452160226678, 
0.0184608915589338, 0.0456605761095476, -0.0641158864392111, 
0.0059020137097486, -0.0212527703506536, -0.0732886420297583, 
-0.00246580198923179, -0.0169686802370458, 0.0461984616038038, 
-0.0836317574481866, 0.0475429549961599, 0.01217095574193, -0.0224602738618356, 
-0.013794954379662, -0.0608249822373653, -0.0565999199018659, 
-0.0538059199813161, 0.0346608524569782, 0.0132035924558619, 
0.0113499300101056, -0.0100509290335426, 0.00265701325945823, 
-0.0191865211762341, -0.00387116190467118, -0.0235566471329012, 
-0.0263360628861927, 0.00154836593438238, 0.0396865544299496, 
-0.000546754335278082, -0.0409795906206383, 0.0264713610065181, 
0.0152075749797429, -0.0400279349784048, -0.0285525913513718, 
-0.0347148105458839, -0.0844982173363219, 0.00677834883010643, 
0.007877106486878, -0.0162958391677022, -0.0166599147033003, 
0.00825080531507678, -0.0632367464287504, -0.0437847366717434, 
-0.0237535317435515, -0.0115170659221016, 0.000145025938433574, 
-0.0678882250127282, 0.0550509065037359, -0.034156189386493, 
-0.0412617152245401, -0.0503552079963607, -0.0184258429951935, 
-0.0261554435127875, -0.0775250852000726, -0.0274241281816299, 
-0.0569326872107634, -0.00206711810081869, -0.0293071611961013, 
-0.0358983916376749, 0.0223471658896166, -0.0171634137667768, 
-0.0473127542602672, -0.0592976385051174, 0.0085843049740294, 
-0.0331028664688512, 0.0148438015833757, -0.0731466458995961, 
-0.00252903724261979, -0.138245240687187, -0.0471908993832589, 
-0.0360005533749079, -0.0315702736703698, 0.00239513033671427, 
-0.0290441748979688, -0.0339350946259489, -0.0383842341234909, 
-0.0419592095437476, -0.129681884024482, -0.131915649703635, 
0.0275565761770411, 0.0247807687853456, 0.00936721220362736, 
0.0277304366808384, 0.019038333879238, 0.0162222213466985, -0.0391693446771304, 
0.0215798946870189, 0.0397807665576879, 0.0368161796503369, 0.00946034326151793, 
0.0455725026973105, -0.017235507418111, -0.0354532262944672, 
0.0151117123960857, 0.0671361340173787, 0.049081299553695, 0.00820492088687019, 
0.0215929327701692, -0.0103769496518796, 0.0956095421858602, 
0.0367685751976918, 0.0210812119125552, 0.0729898775685947, 0.0527640795851082, 
0.0106405290905445, 0.0211337813835954, 0.0127472105738796, -0.0303223215707382, 
0.0233493911462695, 0.0588028419663927, 0.0240079771858197, -0.045758037130375, 
-0.0137316997334748, -0.00405508769899686, -0.0569181709791417, 
-0.0366997506453058, -0.0648754343506708, -0.0692898379933922, 
-0.103369363961021, -0.0505515605906322, -0.0242426503401023, 
-0.0227287200393422, -0.034055915740675, -0.110639248719907, 
-0.0671429647037652, 8.02594482686149e-05, -0.0121415773427503, 
-0.0508526404066454, 0.139067586253886, 0.0159170137854744, -0.00975659999997862, 
-0.0323124137342291, -0.0403050089675511, 0.00281432472252896, 
-0.0556452508972107, -0.0121344557393099, -0.0450849012426623, 
-0.0699775768775877, -0.00597734711174648, 0.131732422240258, 
-0.0634074476275571, -0.0293343297282783, -0.06236343136581, 
0.0460551549646182, 0.0395877951201954, 0.101074569281505, 0.0681248770917546, 
-0.00564513505875083, 0.0235683308695016, -0.00872538207228777, 
0.0960003289387822, 0.0570689567683163, 0.0300817627332899, 0.0703960405548329, 
0.0800855954280975, 0.113013159790279, 0.0653059600660093, -0.028919607797486, 
0.0277104351359838, 0.0470109113731958, 0.0356468505562621, -0.012212867852874, 
0.092168657469063, 0.0992785934963541, -0.0149402781957106, 0.0313271210105437, 
0.0767194246135465, 0.0340156935945232, 0.0395319536552004, 0.0278851222322548, 
0.0510652729428085, -0.0307875794910027, -0.00990067294108477, 
-0.0436334255925507, -0.00212328384686408, -0.00957276291566766, 
-0.0141952622884649, -0.0334094926942365, -0.00524598353538165, 
-0.0110970169603098, 0.00156198126944838, -0.0249327216141199, 
0.0499789029683961, -0.0312192974960066, -0.000931683378221744, 
0.00241434971476228, 0.00182024525638679, 0.00423840851608594, 
0.027068012626964, 0.0264149134210946, -0.0488526163091212, 0.0432888657337988, 
0.0229965867509908, -0.0287969633889307, -0.0451792762874712, 
-0.0010673436140975, -0.00896311648587267, 0.0216992897688836, 
-0.00419284713191313, 0.0311732264706246, 0.0173345987661811, 
0.014661002345171, 0.00208785274787653, 0.0171596113572134, 0.0232407399838332, 
0.0967138141634801, 0.0773031694414149, 0.109604884975015, 0.170807417921416, 
0.0136122241864096, 0.0905913365296531, 0.0180082201811174, 0.134356661585014, 
0.0852939272886331, 0.0717144740177297, 0.0933240088238288, 0.0984706238901597, 
0.109536695650011, 0.0799999691475819, 0.0419994728027626, 0.0302162997984298, 
0.118994003147856, 0.0168909657313235, -0.0153460754019851, 0.0752441079497833, 
0.109677977740471, 0.0260245206348197, 0.0464765708330131, 0.0693930404143719, 
0.0348808605279546, 0.0882894300941713, 0.0673309771963399, 0.138840731143575, 
-0.0697757266860703, 0.0491397693732513, -0.0504879807979589, 
-0.00795804655599848, -0.0652405957854482, -0.0103038850060917, 
0.00346653578384349, -0.0761803930501705, -0.00909577741990224, 
-0.0647652872189785, -0.0179531614648817, 0.00126635143508706, 
-0.0641732817427116, -0.0446038651269163, -0.0223899943122422, 
0.00569907401168007, -0.0224087853921559, -0.0488922613900476, 
-0.0137651692255525, -0.182689983341938, 0.0060242319940035, 
-0.0866584964510033, -0.0298585540924032, -0.0396285278568802, 
-0.045168905959083, -0.018939884815844, 0.0106415658936569, -0.0200070831677965, 
0.00713503341311012, -0.0508952404436831, -0.160035177340574, 
-0.141368875131918, -0.0369701680266785, -0.0364652904404649, 
-0.0439321901126697, -0.0350248887275105, -0.02926684425429, 
-0.0280183079733653, -0.0518808085449657, -0.016849724175075, 
0.021531065235759, 0.00933318481807167, -0.0315057576483215, 
-0.00638453343763019, -0.0136138023338966, -0.017252915686628, 
-0.0123551073327426, -0.0359391422777969, 0.010801341288118, 
-0.0256711840700668, -0.0444620330807015, 0.0518354602112138, 
-0.0125388850497304, -0.0175441701619563, -0.00404596100516721, 
-0.0511810693286466, -0.00614065930421445, -0.0462660545496608, 
-0.0345925557812811, -0.031099068105681, -0.00757090560430429, 
-0.0635922222083434, -0.0814688911109724, 0.000678042804396821, 
-0.0231929005555352, -0.0196147594061895, 0.00120524484972293, 
-0.0118000263856709, -0.00377807225880808, 0.00140878096305526, 
-0.00602256157023241, 0.0224088883191999, -0.00308333122142194, 
-0.00434847012161323, -0.00896421169234818, -0.0305900539861529, 
0.00714623759194503, -0.00241892243343811, -0.0319900494628582, 
-0.0189579212339804, -0.0236256758852529, 0.0284091300846875, 
-0.0372818736607955, -0.0288991424312325, -0.00338220858947192, 
0.0106877017725444, -0.00583121559834767, 0.00710044479017798, 
-0.0194824568827904, -0.00738631173056712, -0.00205755624083358, 
-0.00952792207696742, -0.0106329026155038, -0.0536021275691272, 
-0.0318972785229269, -0.0597804119861749, -0.0866487504818878, 
-0.0881453190816904, -0.0262438059480478, 0.0404219499930264, 
-0.0812793891566819, -0.0973452489732215, -0.0126405119038033, 
0.0436248931189693, -0.0760779183093096, -0.0805082101019518, 
-0.0729717508407267, -0.0121011274621393, 0.0397402442843995, 
-0.089566696654187, -0.0243146536069093, -0.0795022489125829, 
-0.0586201583100731, -0.0757143472425078, -0.0389762237250941, 
-0.0525276236059127, 0.00322834577319885, -0.0863040821973154, 
-0.0190917889252833, -0.104512913449721, -0.0702969695172201, 
-0.0940031140372857, -0.0496673305348158, -0.0515942786154181, 
-0.0316596669372589, -0.0715159884111181, -0.0179171119505207, 
-0.0144879979127849, 0.0150028550241692, 0.00430446571016509, 
-0.0107952907615773, 0.0013778484370882, 0.00508508355930232, 
0.000603930077711735, -0.00278936882156355, -0.0150402585964442, 
-0.010322379876455, 0.0148294042110426, -0.014602829343842, 0.019968564693104, 
0.000861755175855934, -0.00421733039554234, -0.004165403461519, 
0.022222481379199, -0.0256475905699279, -0.00958289902387661, 
0.00101829484718519, -0.00439374223670735, -0.0107780186679141, 
-0.00539651719390808, 0.0226029710082486, -0.0334531908931234, 
-0.0231928749526598, -0.0296253575901516, 0.0197802047589992, 
0.0188415750990631, -0.0200993456678186, -0.00553167908054907, 
-0.0654069568987639, -0.0311976277942542, -0.108775695786941, 
-0.0944919179147901, 0.0123207562103083, -0.0244395623355871, 
0.005167544808714, -0.103157204942326, -0.0398852164363253, -0.0852372080379808, 
-0.0138854100756485, -0.0568565406057031, -0.107607532841566, 
-0.0452580193288564, -0.0219380882087462, -0.0239166885640934, 
0.00709737149080869, -0.0207862693463322, -0.0568521746639672, 
-0.0622889763428043, -0.0674916765895445, -0.00429059306133588, 
-0.0542682555895737, -0.0295235568531425, -0.00880752811761609, 
-0.0528861065544001, -0.00530905285488847, -0.00576384199643331, 
-0.0604913819767533, -0.0632705965486795, -0.038025267175872, 
0.0297514226958225, 0.0135464946621047, -0.0571882884416514, 
-0.0233341370934648, -0.0307122250503267, -0.00800673046040789, 
-0.0113950981489072, -0.0120826833246241, -0.00170825581959635, 
-0.0196854797637415, -0.0298295009795797, 0.00300461290794602, 
-0.0263792386536349, -0.00597581852294209, 0.00660538385512802, 
-0.0103615131889102, -0.0288682845457846, 0.00397991969026545, 
0.0466800191985446, -0.0152953808050258, 0.00529381352901096, 
0.0247734213283353, -0.0198584596391639, -0.0103889025221828, 
-0.00867702423044407, -0.0149608002755117, 0.0274959243303685, 
-0.00715461025174485, -0.0116582590687526, -0.0151767945585549, 
-0.00482116890685517, 0.0164096932078885, 0.0086524277397163, 
-0.0347816661194306, -0.0222402346456313, -0.0225701018113002, 
0.00762099360075862, 0.015449525743925, -0.0063192437564176, 
0.0278191712088167, 0.00483264209868818, -0.0197643114788222, 
-0.0181415805982659, -0.00541559503590887, 0.0250153672805712, 
-0.012053256154928, -0.0287768644789304, 0.0176068799196575, 
-0.00604278456942355, -0.0287215728210206, -0.0201869544610251, 
-0.00305242289634565, 0.0147570433403817, -0.0170130259073007, 
-0.00389423146687411, -0.00469897497053449, 0.0258552729816336, 
-0.0304025977865418, 0.0121720338409439, 0.00788645846784646, 
-0.0193208987262925, 0.026338425447463, 0.042662254036181, 0.00374810691082465, 
0.031988381220566, 0.0282610110597242, 0.00869816176262712, 0.0175576327744815, 
0.0314116283923484, 0.0301011818503946, 0.0136718795391635, 0.039159522526968, 
0.0435622579213385, 0.0662646987299607, 0.0514759806002909, 0.034950717494526, 
0.00666096252230877, 0.023690461048286, 0.00792326342920724, 
0.00688992424122038, 0.00690371891274478, 0.00880920944584953, 
0.0266197270237101, 0.0298924205494653, 0.0078857141873374, 0.0195634206814723, 
0.03300777696046, 0.04882281590363, 0.0266256441206, -0.00381560689028191, 
-0.014781135458107, 0.026697261925861, 0.043547974796274, -0.0170076132781098, 
0.0128979853273008, -0.0269242347241099, 0.0264676523600367, 
0.0192825491213537, 0.0129511765257251, 0.0116335249136945, 0.0312589548982473, 
0.0157257401650374, 0.0152693984682456, 0.0132222839580896, 0.0101571731273024, 
0.0204845937209334, 0.0253256687540563, 0.0330722725904348, 0.0307862810446646, 
0.0119529661590302, 0.021452974561674, -0.00934530184183301, 
-0.0376017402293352, 0.029963246250171, 0.028329368593897, 0.0321968336272378, 
0.0195453561184564, 0.0192506816066273, 0.0398266019401636, 0.0158716831780898, 
0.00143827244407292, 0.0279726846729382, 0.0408640166564555, 
-0.0303046696438786, -0.0118464467046805, -0.0449837374872013, 
-0.0521406846406862, -0.0566744155073519, -0.0223615340302106, 
0.0202249497364447, -0.0163033954387997, -0.0182255123774822, 
-0.0372041790500442, -0.0446597446903206, 0.00421475590762584, 
-0.0298152416505027, -0.0380107570379849, -0.0259022940645085, 
-0.0143739108919437, 0.0123963746368888, -0.0227060329204358, 
-0.0457376189416944, -0.0629810007767594, -0.0370234860278113, 
-0.0424308239350971, 0.0067255534666693, -0.0295636594566859, 
-0.000528916656975591, 0.00190178477654549, -0.0189869433020297, 
-0.0301690611269917, -0.0342826761366061, -0.0444854837891296, 
-0.00308182736180272, 0.00573963295128183, -0.000652156594486268, 
-0.0186534217738655, -0.0315234474210482, -0.0122586010655244, 
0.0270705211561492, 0.00275496828161204, 0.0217953708241616, 
0.00286530300142745, -0.00846933114060107, -0.00659065810851045, 
0.0119951315519276, -0.0341253880721138, -0.00680610775319248, 
-0.0247684951502294, -0.0162771285793824, -0.0388162752323607, 
-0.0308504115874145, -0.0118050844022552, 0.0154789734893238, 
-0.0314024514008184, 0.00911961239298949, 0.0311357880473879, 
0.0106462251242996, -0.00549980787602631, 0.00130969558764541, 
0.0105594204182022, -0.0421209875220264, -0.0243335049509747, 
-0.0209500045720292, -0.0193000967018489, 0.00607489710830055, 
-0.0136398502608404, -0.0249134564273836, -0.0103941509327084, 
-0.0147288002389314, 0.00186659684058219, -0.0259559035577256, 
0.00766044155972133, -0.0180974245585084, -0.00622653335848782, 
-0.0583416994857912, -0.0125260140504875, -0.0135885536980681, 
-0.011009197438024, -0.0199049310459931, 0.00526314617002692, 
-0.0167779685661224, -0.0235411662207848, 0.000897011489441737, 
-0.0397239671080689, 0.00645419243841898, -0.0312171456562541, 
0.0152125654442555, -0.00887861086928319, -0.0183522532959703, 
-0.00603159208356862, -0.0242925744376018, -0.00547958964038307, 
0.00138377843407358, -0.0270126126747692, -0.000969657596926425, 
0.0379146018919463, 0.00583494186407394, 0.00451626800150819, 
0.0355077574506467, 0.0427566640151112, 0.00166960530211747, 
0.0210121712624584, 0.0198555928644923, -0.00127015410178233, 
-0.00136761105645324, -0.0214887293615992, 0.00979604368817606, 
0.0298095438542159, 0.0221976927399178, -0.000841222394545411, 
-0.00863243862603562, 0.0224384077882816, -0.00564312942662892, 
0.0012668876892019, 0.0803064091863522, 0.0326992547930253, -0.0161086554974444, 
-0.00359577711400509, 0.00812442237952756, 0.011984601239053, 
0.00777392718715813, 0.0195153427002146, 0.0203825945874371, 
0.0370667305618387, 0.0531229738209578, 0.00591162017419581, 
-0.0064076004171144, -0.00406220037479002, -0.0020790029375998, 
-0.0456890861182113, -0.0247471155635123, 0.0149345304716686, 
0.0212243485675991, 0.00587678345075354, -0.0128021899575923, 
0.00352970022816323, -0.00231239080378346, 0.0080832558872423, 
-0.0194060820308355, -0.0123621412140397, 0.0108047211160025, 
0.0133676511551605, 0.0200230899508759, -0.00465962299421811, 
-0.00325629262163087, -0.00329368285117114, -0.0299708555071238, 
0.000532884001919872, 0.0139637643973467, 0.0178993910371106, 
0.0229920764461104, -0.00379558973424023, -0.00793135416443497, 
-0.0153155570162656, -0.00910418417549251, -0.0175373625124727, 
0.0107541277922864, 0.000987013247938569, 0.0311656570534982, 
-0.0065653001585232, 0.00558855182026529, 0.0305101154193497, 
0.00332134093234566, -0.002157506508166, 0.0256666976118251, 
0.00480696809861865, 0.0122974488011053, -0.00696620081460668, 
-0.000464028747424469, 0.0043630659900591, 0.0167168519304581, 
-0.00119011399808628, -0.0133665873365822, 0.0365547394461804, 
-0.0215823506305918, -0.032889362252967, 0.00153269996077543, 
-0.0151713383049619, 0.00836718183579368, 0.00426485500989501, 
0.00688842482667243, 0.0072076789396911, -0.00217474623370363, 
-0.0217161778791355, 0.0325823563171028, 0.00900436383557702, 
0.0473908881782204, 0.00893388166135431, 0.0323314912429901, 
0.0372886991728166, 0.0247824133076006, 0.028930407028257, 0.0562785276829645, 
-0.000348704018586737, 0.0415209419731384, -0.0216398396038901, 
0.0309788694616046, 0.0288067054212418, 0.0297618014146456, 0.0075433173956564, 
0.0282234024973718, 0.0381189370601305, 0.0288888300381952, 0.0185625677682896, 
0.00216221074142378, 0.00697991626614366, 0.0281204059280493, 
0.015103247589956, 0.0297025612501721, 0.00643331711245034, 0.0137763989303247, 
0.0240209798048121, 0.0179672407353937, 0.0106252564024965, -0.0573828466227135, 
0.0222254706313389, -0.0125462722215209, 0.0133278228456821, 
0.0134537509151651), dim = c(31L, 36L), dimnames = list(c("Patient1_001_100", 
"Patient1_001_101", "Patient1_001_102", "Patient1_001_103", "Patient1_001_104", 
"Patient1_001_105", "Patient1_001_106", "Patient1_001_107", "Patient1_001_108", 
"Patient1_001_109", "Patient1_001_110", "Patient1_001_111", "Patient1_001_112", 
"Patient1_001_113", "Patient1_001_114", "Patient1_001_115", "Patient1_001_116", 
"Patient1_001_117", "Patient1_001_118", "Patient1_001_119", "Patient1_001_120", 
"Patient1_001_121", "Patient1_001_122", "Patient1_001_123", "Patient1_001_124", 
"Patient1_001_125", "Patient1_001_126", "Patient1_001_127", "Patient1_001_128", 
"Patient1_001_129", "Patient1_001_130"), NULL)))

expect_equal(dim(reducedDim(spe, "UMAP_mnnCorrected")), c(47794L, 2L))

expect_equal(head(reducedDim(spe, "UMAP_mnnCorrected"), n = 10), 
             structure(c(5.67267055680692, 4.03424973657071, 3.9206513898605, 
-0.508073614335662, 6.9223148362869, 6.34068460633695, 2.29260368516385, 
-1.5501361353165, 8.88078422715604, 5.376410676741, -0.213644159252981, 
-0.412231487448552, -0.372023415978292, 1.40369625646319, 1.60662980634417, 
1.08581383783068, 0.340684520785472, 4.69103439408984, 1.89356060582843, 
0.808958190266749), dim = c(10L, 2L), dimnames = list(c("Patient1_001_1", 
"Patient1_001_2", "Patient1_001_3", "Patient1_001_4", "Patient1_001_5", 
"Patient1_001_6", "Patient1_001_7", "Patient1_001_8", "Patient1_001_9", 
"Patient1_001_10"), NULL)))

expect_equal(reducedDim(spe, "UMAP_mnnCorrected")[100:130,], 
             structure(c(0.675230695509308, 6.64876289536893, 6.52465934922635, 
8.36890812089383, 4.91855735948026, 0.70431353022992, 5.80429716279447, 
-2.91450767347873, 5.13740177323758, 6.02838154008328, 7.40888567140042, 
5.48751182725369, 6.59788341691434, 5.00779457261502, 7.25073595216214, 
2.50151152779996, 4.02865166833341, -3.75947193930209, 4.39529485871732, 
-5.25539617369235, 8.63422031571805, 5.37770004441678, 2.58374543359219, 
1.0687672631973, 6.7548663156265, 4.22827739884793, 5.47255630662381, 
2.5525524156326, -4.11789111921847, -4.18013934919894, 3.4472536580795, 
-2.17699162405286, -1.26782123487745, 1.05396791059222, -1.02001939457212, 
1.29472418386187, -2.43432871740613, -0.445249331410268, 2.24732239801135, 
0.683660047833583, -0.872036797221044, 1.44164462644305, -0.39221004884992, 
-0.174553145881036, 0.817651587311885, 0.724565940682551, -1.00211666267667, 
-0.379715484793523, -2.00368587415967, -0.713502806837896, -0.628553015406469, 
-0.188084637041429, 0.879473703686854, -0.906017941649297, 2.14709241944995, 
-0.346048367436269, -0.449229968006948, -0.28080978732858, -1.11004571359907, 
-1.85770527761731, -1.59709803503309, -0.251448956544736), dim = c(31L, 
2L), dimnames = list(c("Patient1_001_100", "Patient1_001_101", 
"Patient1_001_102", "Patient1_001_103", "Patient1_001_104", "Patient1_001_105", 
"Patient1_001_106", "Patient1_001_107", "Patient1_001_108", "Patient1_001_109", 
"Patient1_001_110", "Patient1_001_111", "Patient1_001_112", "Patient1_001_113", 
"Patient1_001_114", "Patient1_001_115", "Patient1_001_116", "Patient1_001_117", 
"Patient1_001_118", "Patient1_001_119", "Patient1_001_120", "Patient1_001_121", 
"Patient1_001_122", "Patient1_001_123", "Patient1_001_124", "Patient1_001_125", 
"Patient1_001_126", "Patient1_001_127", "Patient1_001_128", "Patient1_001_129", 
"Patient1_001_130"), NULL)))

expect_equal(dim(reducedDim(spe, "harmony")), c(47794L, 20L))

expect_equal(head(reducedDim(spe, "harmony"), n = 10), 
             structure(c(-0.725164975278711, -0.965331791927471, -0.908784201352981, 
-1.82049983107581, -0.0538803044104358, -0.252144160938694, -1.10334781975255, 
0.262763547287345, -0.243925616235335, -0.298337151136736, -0.580209069796674, 
-0.611296292558372, -0.563907674272879, -0.213190954577455, -0.536879723137758, 
-0.572432976104312, -0.116728214391992, 0.151589751278287, -0.751639997222491, 
-0.806645955919954, -0.140228084611129, -0.277801514023615, -0.267761946543994, 
-0.445565314885376, -0.0542239670499323, -0.0449677819763761, 
-0.279144460933116, -0.00512577939402845, -0.195243567705471, 
-0.17132356670027, 0.0602489753753048, -0.133237741236298, 0.0322471571023791, 
-0.128219759902253, -0.0199033918486354, 0.033395976901221, -0.251607592581166, 
0.394192968679656, -0.107517184100202, 0.0935686372969265, 0.056496869314292, 
-0.140485172032097, -0.020606584937903, -0.258032052199242, 0.0977605678598198, 
-0.150947293109361, -0.225440623056504, -0.452717883545621, 0.0830916737986596, 
-0.034160797039594, 0.174955742087924, -0.0757448462798559, -0.221725990451886, 
0.0544859710469248, 0.148216802319301, 0.0136312305630748, -0.136133037509135, 
0.506271939076344, 0.177952873489654, -0.0397379461053208, 0.0159905593299292, 
0.00445329960832104, -0.0986841555845646, -0.0303467241902566, 
-0.0237256167139122, 0.0982247626373686, -0.100177523443094, 
0.22351835211857, 0.0511513119791715, -0.0320306444229295, -0.227418499759634, 
-0.219495760887538, -0.0823319368278995, -0.144200951624713, 
-0.0693270656314386, -0.0808145097662223, -0.0271961557552282, 
-0.53387436341321, 0.0593966262563202, -0.0787393370256936, -0.0858715494760809, 
0.00148494313728232, 0.138334060620357, 0.358481573281175, 0.0735319431232327, 
0.103176865894253, -0.122613954135113, -0.0574326014333653, 0.146240142613697, 
0.00682775880342045, 0.204460941657553, 0.278683085316916, 0.202755775042366, 
0.0533014303335532, -0.216938225169806, -0.0666049413177785, 
0.0904676607188266, -0.000979211427459814, 0.0171302560669043, 
0.0690173269664291, -0.0388461047892036, 0.0962150150391444, 
0.0139594980069666, 0.0846648947349131, 0.213987891095932, -0.013053771226875, 
0.143209806925059, 0.233411297913241, 0.563890928632058, 0.106490088541555, 
0.0847587477228521, 0.239214756361463, 0.218941356141092, 0.157063173603447, 
-0.0754618423507319, 0.0459795562746183, 0.130768049586729, 0.193107738524444, 
-0.014909262571313, 0.228292541467578, -0.227655733840724, -0.0218464976746586, 
-0.15369399486021, 0.0392162644890174, 0.100740948547252, 0.138213994135911, 
0.118036690646994, 0.070644933136523, 0.0414260773239575, -0.0430359441655912, 
0.0149294456331085, 0.0504284026875335, -0.0624614746305408, 
-0.0242302248753925, 0.053874031342033, -0.087650530211453, -0.200490790505169, 
0.0361655416227182, -0.128072049303514, 0.0249464874296746, 0.0971421076940644, 
-0.219054463602622, -0.0310557103656459, -0.2196932876866, 0.0463610748500875, 
-0.150811542886448, -0.0737579070107018, -0.395864286094529, 
0.167103207200876, 0.056780439191864, 0.146348470918823, -0.147625086418943, 
-0.0726315508143825, 0.0901219843622123, -0.182670482155375, 
-0.0933438008496464, 0.105708528672806, -0.132098701797939, -0.0372794645897184, 
-0.119474461822858, -0.080241604180671, 0.0638876376915812, 0.0250162399282589, 
0.0128960852601737, 0.0405584055305978, 0.0760521423038002, 0.201139020553291, 
0.0653730507496793, 0.0147674691309151, -0.156238035098424, 0.260554338709666, 
-0.147052469430042, -0.292319593954431, -0.0229780964989842, 
0.181476160650377, 0.100495722956689, 0.0681742409125164, 0.121818819456584, 
0.166585072017604, -0.220131231472651, -0.240979082680086, -0.285793392619656, 
-0.16058681315188, -0.0980642957901932, -0.0886771122705335, 
0.227756675072361, 0.00286688074507344, 0.0456858168004442, -0.000835450826078675, 
-0.118416480958411, -0.0538101720060302, -0.215990458739847, 
-0.0812330796103323, 0.0894885664581465, -0.268076682018998, 
-0.165237248758724, -0.0924065499949867, -0.090014138101171, 
-0.0400048821814504, -0.109910845332325), dim = c(10L, 20L), dimnames = list(
    c("Patient1_001_1", "Patient1_001_2", "Patient1_001_3", "Patient1_001_4", 
    "Patient1_001_5", "Patient1_001_6", "Patient1_001_7", "Patient1_001_8", 
    "Patient1_001_9", "Patient1_001_10"), NULL)))

expect_equal(reducedDim(spe, "harmony")[100:130,], 
             structure(c(-0.650103026879025, 0.609964682384916, 0.451110141619566, 
0.413675042578943, 0.231306319567309, -1.0644632708137, 0.00511246379560988, 
0.242777533230911, -0.0617687278224983, 0.282022373027457, 0.273181333672271, 
0.027323426671643, 0.0321138438568003, 0.170828893900295, 0.802729180728664, 
-1.09902679734509, 0.195893220025453, -0.198691155400324, 0.433873727754273, 
-0.180686326157752, 0.445299316445161, -0.131010786108676, 0.104713305471798, 
-0.123020983374954, 0.797648837724648, -0.131001742992896, -0.938784786443222, 
-0.864423630029916, -0.647319939159858, -0.527110081304278, -0.236641377773437, 
-0.182416212218697, -0.303958775039885, -0.337899803665645, -0.628883372966231, 
-0.541839310904242, -0.27609460735297, -0.491520861605221, 0.229413842493327, 
-0.339402855588006, -0.412826308738556, -0.489589016679435, -0.417603924906178, 
-0.645177379147937, -0.510895996545934, -0.0814946626290526, 
-0.0283379455704236, -0.214217882197102, 0.186079816753721, -0.0104228799819749, 
0.205187823344259, -0.510879505174514, -0.424561545527937, 0.257995776949864, 
0.106854864331194, -0.0775966509303646, 0.0772753829158076, -1.19274673209744, 
-0.0175303730975953, 0.290671241344359, 0.12389571531874, 0.156350700865954, 
-0.00208158929709012, -0.095599897200019, -0.00664560016929227, 
-0.0729092157457872, -0.144912924846129, 0.163502074271342, -0.0928442089508311, 
-0.104870652107434, -0.374368888779384, -0.180793477482634, -0.107744375373902, 
-0.116941776921302, 0.0126493978079926, -0.247739884163298, 0.0878978295137868, 
-0.633202698940787, -0.0451360744018377, -0.0528851083577466, 
-0.0738173975088977, -0.207341881090765, -0.0874765420889408, 
-0.231920365211374, -0.351183633917486, -0.417785693670411, 0.102760943309802, 
-0.328698743559511, -0.158788166015738, -0.341823050818744, 0.101530881630841, 
0.201873537507313, -0.425474822738988, -0.607783872070207, -0.013230605307377, 
0.00487452110152504, -0.107715124876698, -0.0227476304102974, 
-0.330478582336424, -0.0304955247426536, -0.00819094858255522, 
0.0178036157643763, -0.11470000086844, -0.11482079847946, -0.0953606318368464, 
-0.19647348216875, -0.0381608112852546, 0.0546931525617379, -0.303884459210852, 
-0.127671600455003, 0.0257086317591835, -0.0562930779528677, 
0.738652166249892, 0.0488126281303973, 0.179821025974708, -0.0565030880956007, 
0.0450635737815718, 0.0642014371993187, -0.0371292120143311, 
0.0813318916351455, -0.357116692698389, 0.484754688287444, 0.514584784884684, 
-0.204103328807882, -0.338126111599212, 0.0752117830526076, -0.0488748011877625, 
0.153968286170966, 0.140627077141381, -0.534037417963647, 0.0922540611897057, 
-0.384560566360971, 0.00199484414320515, 0.138672309567376, 0.0954815422204916, 
0.0678104755863256, 0.000171825068528056, 0.0649597900673058, 
-0.10043403104128, -0.0723796260789648, -0.0186625760714066, 
-0.0543199170520939, -0.195753475708902, 0.156008901900461, 0.128209606302181, 
-0.0291464545574652, -0.143566737348756, -0.0697064507776748, 
-0.139542683126962, -0.031472685545242, -0.268731800732215, -0.216648945329246, 
0.0743900924796181, -0.189959786470234, -0.0495501712584012, 
-0.115058953544636, -0.191775176178796, -0.0413076877161593, 
-0.0248701123979701, -0.147451436094613, 0.112287708651773, 0.00598429587011493, 
0.0151799398440594, -0.208623440645932, -0.106897779753652, 0.105953631000551, 
-0.00239564920253872, -0.048835859529196, -0.161566265884991, 
-0.0547774151492747, -0.341563264254859, -0.171160911166322, 
-0.033991896986209, -0.0492296397180995, 0.00556417857178822, 
0.0737512597303277, -0.0847255063371913, -0.277824339211244, 
-0.207457321618008, -0.0564381887043615, -0.177998106428226, 
-0.127062174056706, -0.288692522843706, 0.0442728489719759, 0.119227839723751, 
-0.348012543480734, -0.129190392005573, -0.0596261462459657, 
-0.0817580570717986, 0.0270025990274939, -0.105333006293611, 
-0.171783948993096, -0.00860022158926952, -0.0395653812585148, 
-0.0804129104621907, -0.0612278622440003, -0.00414401963591843, 
0.0270199431229327, -0.165702219161963, -0.0857240392794773, 
0.00380069473057894, -0.0159885373980281, -0.135355795699317, 
0.0358950941820441, 0.0563820515358242, -0.297611314334503, 0.0645892783549071, 
-0.07949605615988, -0.051925015294778, -0.0781895910614406, 0.00307781192543534, 
-0.0607285125554578, 0.217561913018039, -0.0845814015866057, 
-0.24426090748762, -0.309418843481891, -0.0628292526850144, 0.137200554743518, 
-0.035174897672255, 0.114207997960405, -0.0777662104621029, -0.155602580019025, 
-0.0580445645331158, -0.105288399565398, -0.0947440347962212, 
-0.135593618065508, -0.0360227924355082, 0.0833036156849215, 
-0.0866484224127325, -0.0900430765458994, -0.0949393514602423, 
0.0538710842927896, -0.178332782732147, 0.0716214060721563, -0.0932108360766955, 
-0.357860502941925, 0.106608085978216, 0.0559206338288389, -0.093546673840526, 
0.0721279640811552, 0.0174606936790381, -0.0294184556545393, 
-0.0751752410625535, -0.0796666057449856, -0.014103381881913, 
0.0147812149261911, 0.284618101721914, -0.0614459600662289, -0.322887256571193, 
-0.0284017386845243, 0.0826292598100284, -0.0418156451094567, 
-0.0730321852059723, -0.275147848866385, -0.0426035329326159, 
-0.031944655650118, -0.00830158739698599, -0.0516642829268016, 
0.0652512988714174, -0.0804637244171654, 0.113185572191137, -0.0428179831274392, 
0.0104728552116594, 0.091200698957426, 0.00856782176994458, 0.0304314580549722, 
-0.184013592430379, -0.198659558782222, 0.0327209684686433, 0.144988533426504, 
-0.00128499294891605, 0.0431694303929459, 0.0255167478788204, 
-0.112548045300251, 0.258344006436, -0.156021361209918, -0.0831169537522652, 
-0.526141309999406, -0.0804381790650153, 0.104894796162437, 0.0128866094309845, 
-0.0896624967290101, 0.152867248474945, 0.0349653640081207, 0.171574434157352, 
-0.012937788358972, 0.0882763981556672, 0.0599121997698902, 0.0300557302687604, 
-0.120954516715488, 0.0777963380787806, 0.13485302762456, 0.1299192383831, 
-0.00376270170974627, 0.0344578617783287, -0.0393064831651849, 
0.209822749800395, 0.0947279236671197, 0.0801398543943091, 0.0810682066640609, 
0.0596558241553466, 0.0758620098834995, -0.00845121523133512, 
0.0485697566328402, 0.0820950226014923, 0.0327336324402535, 0.146777102154544, 
0.178796397921783, 0.258830421412442, 0.0516376599394884, 0.137363044197095, 
0.0273020073483618, 0.119849090829191, 0.0276952070838445, 0.0263163726857621, 
0.181386422771611, -0.0161440362055691, 0.198882194006364, -0.10665439220633, 
0.108000141873643, 0.176930592557049, 0.102116093345919, -0.0226920801418849, 
-0.0445361678296776, -0.0362118368980819, 0.0545256828642071, 
0.057740671682165, 0.137435499147577, 0.0779492697427447, 0.0869961578470198, 
0.00786637401740961, 0.000569295750668759, 0.0126991932396308, 
-0.037753034483296, -0.0206803607989172, -0.0854531835981227, 
0.0449279590220148, -0.0261174093996737, 0.208858571225724, 0.203108918932414, 
-0.0469646122615855, -0.112979937427416, 0.0556403444646074, 
0.0533280623970302, -0.0315611263341909, 0.202779976835549, -0.207663986634023, 
0.044673709867311, -0.208584949167575, 0.290819092027323, 0.0873274026094574, 
0.122090504304428, -0.031359107942171, 0.0444353167231599, 0.203071331560601, 
0.0600596988216191, -0.02923370521675, -0.0453938541648737, -0.0635036815879167, 
0.267944911925836, -0.126470904657601, -0.0945954895381513, 0.138034720358243, 
-0.0931767968817427, -6.67864083284815e-05, -0.00665573706480256, 
-0.0988592781134448, -0.0936031989066688, 0.0486341429819151, 
-0.147514943958864, -0.359729114249558, 0.0115642981067173, 0.0901078188170777, 
0.0410757930581929, 0.0658455180762378, -0.232533343659439, -0.125973689824593, 
0.11821125002795, 0.0093300206206371, -0.119012230038594, -0.106285398853299, 
0.0488028497153167, 0.0353410463263072, -0.088275565583343, 0.0345337936349273, 
-0.142875658659385, -0.0475351072151291, -0.146555276889332, 
0.0353381665581735, -0.155185186215362, -0.0272454234259205, 
-0.0201781482529551, -0.117794982368767, 0.104553522984308, 0.0499615914168408, 
-0.0451506768612419, -0.0340057666782786, 0.0347159421451922, 
0.480552586048728, -0.0712824400930574, -0.218458017911784, 0.0633907665217948, 
0.0180699915693222, 0.14748945742089, -0.0119674758888636, 0.0521369816063522, 
0.0827896474191614, 0.178903109272467, 0.137529619923361, 0.122754730510917, 
0.021186189164884, 0.0335373066043322, 0.0132740815676082, -0.0141609295356783, 
-0.0344375276760907, 0.0775257020723846, 0.0801761181551992, 
-0.104220785541767, 0.0302830496422114, -0.0199740000330681, 
-0.136764719655114, -0.0690087741579006, -0.0811538516770578, 
0.0479451141416223, 0.0486950461445607, 0.0209433275140378, 0.0578714737094684, 
-0.0373168077987841, 0.0391382822328762, -0.273984445845778, 
0.0240060530080151, -0.258173505999906, 0.144963637686371, -0.0805588592790127, 
-0.0711849466859962, -0.0625533383555059, 0.0159514772498934, 
-0.000449678698948103, 0.200682269522841, -0.0273053294030944, 
-0.055119210730909, 0.114513352743275, 0.159290420296549, -0.160254760870106, 
0.172790982513078, 0.0705467369738953, 0.0317799550965737, 0.137409013421613, 
-0.03050836828804, -0.332609279890327, 0.0620571284722787, 0.195893124124028, 
-0.190976649536106, 0.0409254974064585, -0.0874442884400221, 
0.0355684951175558, -0.0718129745354786, 0.0716379024883368, 
-0.108555536547221, -0.0408140409690959, -0.980039575171723, 
-0.162494051794453, 0.104645964101552, 0.160518812057409, -0.106881019881774, 
-0.11310142059246, 0.00534308360780368, -0.0647418220047609, 
0.0825093827410298, -0.177897651666331, 0.120568841640736, -0.0838687172042355, 
0.0821720485943601, -0.165973290712014, 0.00916173397375773, 
-0.0100727780553111, 0.0360847437913337, 0.0246199298154803, 
-0.117652490107197, -0.0482987070452125, 0.0569852766407809, 
-0.0167937961806408, -0.196393408835955, 0.0800232720854752, 
0.0715583306454931, 0.0208242346012676, -0.0943274009783895, 
-0.0108003168152743, -0.17191765768854, -0.039277816798139, 0.0746885136524031, 
-0.0336081962595445, 0.104526824395371, -0.0894933073934393, 
0.0139508815191428, -0.0424510837353467, 0.163632385283745, 0.042127929216756, 
-0.0114848110946477, -0.0302857093899206, -0.00930186371549469, 
-0.166746017044076, -0.0133253283049025, -0.193526933474925, 
-0.0883533358714371, -0.0389023392300685, 0.103553471723269, 
-0.0369151743886148, -0.0231753094086244, -0.0489841312971526, 
0.100190884932068, 0.141818834030672, 0.0121387887266483, -0.0544301545270416, 
0.0185934279635365, 0.204423360756754, -0.119422820801794, -0.151835655852826, 
0.15245172023263, -0.0385529554583349, 0.0683783422908719, -0.058831153168492, 
-0.39551431423809, 0.0285888528270924, -0.000499987565861159, 
0.218605086954097, 0.0782281229026753, 0.0730330598614604, -0.010521425612595, 
0.032322956198634, -0.0959527788933806, -0.0881575886321316, 
-0.023836874812362, 0.0943209420127893, -0.0582898835318166, 
-0.10092011462258, -0.0474948488310516, 0.18589531518416, 0.0662738463097962, 
-0.0380324398198248, -0.149337659019882, 0.0665670875786862, 
-0.253133006159946, 0.0916359468054182, 0.0272851481146377, 0.0523942698934338, 
-0.171589389180426, -0.0794471160587404, 0.0279174397308915, 
0.0278315544508139, -0.0273349759882337, -0.0020192280103109, 
-0.0242799690980471, -0.642702500765099, -0.0030545329847491, 
-0.163929980019392, -0.28950460409774, 0.00371842840954995, 0.147668854127149, 
0.0501318996976401, 0.0510687093082266, -0.0528185962639903, 
-0.0584769643474651, 0.147942742198452, 0.00418686492138188, 
-0.0726641971833689, -0.0488812473218851, 0.00691054754982525, 
0.0696704312135163, -0.00220565195580986, -0.192454015572411, 
-0.179412279363584, -0.0211288570631382, 0.0216548268586395, 
-0.117235448319871, 0.329375835472116, 0.0549514682957342, -0.0254635194396442, 
0.0267518869664411, -0.0113971404328805, -0.0204048172058652, 
0.0253773326249471, -0.0351746644409668, 0.075596714180859, 0.399192094596895, 
0.0637810579697504, 0.283969245985241, 0.0620036461111145, 0.128196420334924, 
-0.232906599549528, -0.0302714832228957, -0.0220866099393654, 
-0.0202850442139242, -0.0657497289931103, -0.038616680449075, 
-0.082401679177188, -0.142816496215658, -0.0678793833691087, 
0.0105977794321601, -0.133338599307172, 0.0510717897275652, -0.0298554966975914, 
-0.0209083533037306, -0.0643627061989979, -0.189013210395087, 
0.0869075926738975, 0.142088704131827, 0.0568864036872442, -0.0160433112967647, 
-0.0234229384932584, -0.0535626547423659, -0.109334699753208, 
-0.0994899385092124, 0.0465383889394325, -0.0374400470621066, 
-0.148409760500553, 0.141130251196379, 0.268300223545851, -0.101963710931511, 
-0.0878801650232642), dim = c(31L, 20L), dimnames = list(c("Patient1_001_100", 
"Patient1_001_101", "Patient1_001_102", "Patient1_001_103", "Patient1_001_104", 
"Patient1_001_105", "Patient1_001_106", "Patient1_001_107", "Patient1_001_108", 
"Patient1_001_109", "Patient1_001_110", "Patient1_001_111", "Patient1_001_112", 
"Patient1_001_113", "Patient1_001_114", "Patient1_001_115", "Patient1_001_116", 
"Patient1_001_117", "Patient1_001_118", "Patient1_001_119", "Patient1_001_120", 
"Patient1_001_121", "Patient1_001_122", "Patient1_001_123", "Patient1_001_124", 
"Patient1_001_125", "Patient1_001_126", "Patient1_001_127", "Patient1_001_128", 
"Patient1_001_129", "Patient1_001_130"), NULL)))

expect_equal(dim(reducedDim(spe, "UMAP_harmony")), c(47794L, 2L))

expect_equal(head(reducedDim(spe, "UMAP_harmony"), n = 10), 
             structure(c(1.24802121699447, 1.26433709443206, 1.39121797860259, 
1.07490882456893, -7.23053201853638, -7.00979742228394, 1.19638893187637, 
3.28932395756835, -7.20823511301881, -6.4178412836731, 2.58995480968536, 
2.5494486851889, 2.52178783847869, 2.2600245042044, 2.16483970119537, 
2.59362931682647, 2.27075667812408, -4.65818457172333, 2.44530077411712, 
2.09372563793243), dim = c(10L, 2L), dimnames = list(c("Patient1_001_1", 
"Patient1_001_2", "Patient1_001_3", "Patient1_001_4", "Patient1_001_5", 
"Patient1_001_6", "Patient1_001_7", "Patient1_001_8", "Patient1_001_9", 
"Patient1_001_10"), NULL)))

expect_equal(reducedDim(spe, "UMAP_harmony")[100:130,], 
             structure(c(3.14649000943298, -9.3523476999939, -8.25927957713013, 
-9.29686197459107, -5.84773430048829, 3.47217765629882, -7.08814319788819, 
1.39920810044402, -5.69336160838013, -8.23024114786988, -7.93044885813599, 
-7.6904996317566, -7.28147443949586, -5.8664701861084, 0.198487909442132, 
0.542950482970422, -7.36825641810303, 3.09106031239623, 2.90712037861938, 
5.0810371953308, -9.14829191386109, -6.84348425089722, 0.188254097408002, 
0.00886452377433106, 0.902418347006982, -0.495135156506354, -4.36138185679322, 
1.14731082499618, 5.18568149388427, 3.11751857579345, -0.32450064837342, 
4.19059129192413, -0.0790304528278044, -0.321262283782356, 1.19664962722839, 
0.975933150787957, 3.92638988925994, 2.1065284772116, -2.29247502849519, 
1.3804440064627, 1.17123384906829, 0.432895646830208, 1.99836535884917, 
1.9979360861975, 1.40401764347137, -5.29013018176972, 1.29655523731292, 
0.585225657959587, -0.0141649866205385, -4.69913391635834, -1.27351836727082, 
0.80691136552871, 2.18247409298003, -1.47022156284272, -0.709345741729133, 
-5.71865849063813, 1.0149969024855, 6.0076937241751, 2.13397546245635, 
-0.36976106331765, 4.13112922145904, 0.666811363239891), dim = c(31L, 
2L), dimnames = list(c("Patient1_001_100", "Patient1_001_101", 
"Patient1_001_102", "Patient1_001_103", "Patient1_001_104", "Patient1_001_105", 
"Patient1_001_106", "Patient1_001_107", "Patient1_001_108", "Patient1_001_109", 
"Patient1_001_110", "Patient1_001_111", "Patient1_001_112", "Patient1_001_113", 
"Patient1_001_114", "Patient1_001_115", "Patient1_001_116", "Patient1_001_117", 
"Patient1_001_118", "Patient1_001_119", "Patient1_001_120", "Patient1_001_121", 
"Patient1_001_122", "Patient1_001_123", "Patient1_001_124", "Patient1_001_125", 
"Patient1_001_126", "Patient1_001_127", "Patient1_001_128", "Patient1_001_129", 
"Patient1_001_130"), NULL)))

expect_equal(dim(reducedDim(spe, "seurat")), c(47794L, 30L))

expect_equal(head(reducedDim(spe, "seurat"), n = 10), 
             structure(c(0.135423463926155, 2.59439551114222, 1.5521704466468, 
10.3272633680663, -2.07270337960298, -0.531044907251332, 7.76989698536855, 
-3.49245265941473, -0.955815687193515, -0.743598499792307, -5.78607169470845, 
-6.46500962626159, -6.23611804754052, -2.45153927423685, -3.48053599747058, 
-3.36130472103661, -1.11482196986588, 2.74190425497261, -5.34731686801934, 
-6.59996612356813, -2.82174630726728, -3.74025794447697, -3.61059621188722, 
-4.84718021183568, -0.91932177163574, -1.91232734373528, -3.03770252408593, 
0.421240479320726, -2.39951226844914, -2.19483091865886, -0.184529599535715, 
1.23044092092127, -0.0303308595407593, 0.633619044634939, 0.458924117045747, 
0.466010477020448, 1.87411900441425, -1.13639633472246, 0.712810227666844, 
0.0911250233631596, 0.9019350270802, -0.499588690935015, -1.35429762640925, 
1.07869195433323, -0.0574588000404615, -0.304155770698152, 0.547392602932772, 
2.40184999925013, 0.0743938486960218, -0.310233169439618, -0.36702929726676, 
-1.35930298536675, -0.732517974442702, -0.729421270112263, 0.164668876534383, 
-0.675945061397355, -1.25999471835617, -1.20190002538929, 0.307187122720541, 
-0.86124804749874, 1.06131566855623, 0.473741473728833, 0.881010716574065, 
2.01900152309085, -0.202039845793293, 0.0699561495683815, -0.206576668392305, 
-0.340661850426726, 0.460244917004792, -0.0970934910882248, -1.04594444984395, 
-1.89028027605931, -0.641976395578083, -2.55196829106684, -0.951102458771968, 
-1.72301562319116, -0.726669810049731, -2.92792894935627, -0.310900667414158, 
-0.942987130721772, -1.77805035336497, -2.6559973047644, -1.49523979015317, 
-1.29283101242078, 0.184105218650569, -0.0906814314210672, -1.78630138674947, 
-2.12073476007617, -1.25174026140471, -1.54806387479235, -1.87432524502995, 
0.296511413611302, 0.39053904351495, 0.744375028597142, -0.611381769301806, 
1.23376611243074, -0.28524111234399, -0.143473304562386, -0.217014014553574, 
0.811685937485726, -1.51785452859171, 0.83809267061736, 0.967260340629369, 
0.0301398596232279, 0.98881818860944, 1.24699706537735, 1.33437808409867, 
1.51480187889645, 0.646244405503692, 1.05980347550408, 2.66370917656527, 
0.613104528849576, 0.0700235629200042, 1.17293489350299, 1.271525668143, 
0.179578927591705, 1.56874515884603, -0.16000052022942, 1.34477312347521, 
-0.0208609597507697, -0.799150310590397, -0.956994593363012, 
-1.13955595552927, -1.40482425685276, 1.43855387515359, 0.540604492418284, 
-0.567447799048773, 0.0915821635075083, 0.937631428550485, -1.08163465563171, 
0.18047386610564, 1.71475292165117, 1.26103385331926, 0.54355114018166, 
-0.355427421192861, 0.0265382453517627, -0.794804098507854, 1.13925732728717, 
-0.299104890798725, 1.16543111460906, 0.897865924015211, 1.55000857640961, 
1.37900191131828, 0.0680217759105296, 1.31565686839947, -0.36139668680445, 
-0.440853401923826, -0.37772437556537, 1.01738158297583, 1.4584417639073, 
1.43828472315106, -1.0808086021824, -0.425813623022143, -0.244657115949246, 
0.32877428048433, 0.0591898194131913, -0.665514196841128, -1.68319093351446, 
0.835184934464817, 0.526253366582091, -0.595343598861439, -0.443709771733154, 
-1.1979718444472, -0.611100535870327, 0.447874812166473, -0.824919315539267, 
0.230268801198173, 1.00422604174895, -0.0186682360161025, -1.77842742306111, 
-0.329271408573346, -0.0545534851218782, 0.257504051526927, 0.946462001846943, 
-0.940025909791018, -2.66729529431513, -1.34408309531463, -0.0124161786287208, 
-0.33374988117796, 0.386239248363972, -1.27351877218128, -0.0628844996553024, 
2.08493027198937, 0.227714297171268, -0.861445401371914, -0.554950166583441, 
0.357539112088028, -1.20232872815857, 1.36460023885732, 1.12855200524558, 
0.018845678396016, -1.73314771383374, -1.16562655075015, 0.740675136052757, 
0.0694344677347699, 1.00733490568381, 0.507273370461341, 0.760483487972828, 
1.31815969757142, -1.31655290404678, -1.42081207795063, 1.0196989348172, 
0.691841260975398, -0.396189350575636, -0.672811136665387, -0.790890273754193, 
0.570768583484287, -0.754511254766539, -0.748803258757, 0.401464519045673, 
0.48001289962681, -1.02862467404003, -0.923709414357237, 0.596309985082809, 
0.319200396353644, -0.279184801113226, -0.40745314797125, 0.354627764048213, 
0.0621922620045904, -0.885643822275812, -0.219911584247376, -0.430229884830744, 
-0.545770820170006, -1.08661302197363, 1.0047845171945, -0.291423245829803, 
0.118618174950983, 0.0453834662124666, 0.705591254829358, -0.0397130647433678, 
0.15117171903091, 0.237889338439583, 0.31843233911581, -0.817960529780782, 
0.229920090869964, 0.308154558948311, -0.472342251331538, 0.121613885911195, 
-0.301110209337095, 0.91133725568188, -0.0164503042479319, -1.30586999153909, 
-0.837281033007199, 0.279085873254147, 0.582218709900882, 0.48517956136104, 
0.326926706556456, -0.18452888570721, -0.211040210982371, -1.06237597009174, 
0.0373720689884832, 0.285781326612439, -0.907908034014712, -0.0456679948550426, 
0.554882487980796, 0.143192686724759, 0.68246587985461, 0.312431106608153, 
-0.0605776655499496, 0.0580579611450857, -0.524967015080052, 
-0.235896264869698, -0.11286599949211, -0.45401161686409, 0.944381721884506, 
0.204327009773401, -0.226485393048222, -0.29836917185701, 0.447504014134897, 
0.734561004205366, -0.255974569764991, 0.232668981454958, -0.831654944693769, 
-0.822300718956988, -0.418457976329106, 0.21437795940898, 0.349817743033667, 
0.189065774203939, -0.134889350752034, 0.0821142161615419, 0.0735727157331714, 
0.174159292662574, 0.295663384923708, -0.210332711206199, 0.143548003113923, 
-0.430829424035679, 0.606016679385783, -0.195104679410619, 0.540844287754411, 
0.893738356591449, -0.0576136424885561, 0.295241871639825, -0.0933633027830987, 
-0.81399459295217, -0.283278510774329, -1.00803655250852, 0.127169044280674, 
0.509326352771215, -0.253903470343577, -0.446421387506054), dim = c(10L, 
30L), dimnames = list(c("Patient1_001_1", "Patient1_001_2", "Patient1_001_3", 
"Patient1_001_4", "Patient1_001_5", "Patient1_001_6", "Patient1_001_7", 
"Patient1_001_8", "Patient1_001_9", "Patient1_001_10"), c("PC_1", 
"PC_2", "PC_3", "PC_4", "PC_5", "PC_6", "PC_7", "PC_8", "PC_9", 
"PC_10", "PC_11", "PC_12", "PC_13", "PC_14", "PC_15", "PC_16", 
"PC_17", "PC_18", "PC_19", "PC_20", "PC_21", "PC_22", "PC_23", 
"PC_24", "PC_25", "PC_26", "PC_27", "PC_28", "PC_29", "PC_30"
))))

expect_equal(reducedDim(spe, "seurat")[100:130,], 
             structure(c(5.04654864102843, -4.83974105582113, -4.83792084683942, 
-3.19281461604588, -2.83494172181428, 5.75370827461294, -1.61914374844299, 
-1.94086231671198, -1.59130673014825, -3.22098837757992, -2.66417604796107, 
-2.02177287739454, -1.8563298476874, -2.44599906894232, -5.86300555945164, 
6.93732946382652, -2.05160662821545, 2.85665758417903, -3.12839479669237, 
1.72522909910716, -3.70335862916182, -1.40933932680542, -0.0734019805968285, 
-0.415833437031171, -5.70265134038722, -0.533231692731551, 1.23061953584771, 
5.43714596850267, 3.57237202093186, 3.42935426753214, 0.936329002735307, 
-0.954796651851834, 1.06975951898562, 0.490424333036458, -4.45007318857532, 
-4.5956993690225, -1.8950166734287, -3.54289618779503, 2.09080818685482, 
-4.64769141052871, -3.27592249851064, -3.30047439428301, -3.5248244496539, 
-4.5562425633601, -4.47530950146628, 1.8085072453167, 0.887829313171055, 
0.857221282647366, 0.711415806197518, 1.2075811467308, 0.203578811795131, 
-2.32233018990139, -3.88017621519538, 3.79327497075669, 0.349500835197965, 
2.09596454649826, 0.47026447038472, -6.81796369408276, 0.298579477582663, 
0.970958101121943, -0.259714484609285, 2.91298818463858, 1.39322374008885, 
0.557504542598893, 1.44572363961422, -0.840019623366662, -0.951612713762802, 
1.45231786885596, -1.31387907477498, -0.0450592767970866, -2.32021600650191, 
-1.18057373695252, -0.979627692377017, -0.835339206006669, -0.246963312015012, 
-1.23728175300701, 1.76571393636548, -5.15521096104735, 0.783191501828311, 
-0.000789661877095359, 0.538201517887345, -2.21359694921704, 
-0.640340417320324, -1.90020519593682, -1.71177781140251, -2.59050973510229, 
1.86652434085875, -1.75551675162325, -2.58202757097173, -1.75099265193661, 
-0.0271977541016101, 0.334237839689874, -3.30137440186331, 4.46048971027888, 
0.210636776439275, 0.271707754677447, 0.567012134340115, 0.0709099014312133, 
3.20878460826918, 0.495332758766662, 1.0334316340448, 0.0625507516780954, 
0.975464379479812, 0.66310239898286, 0.928389026278881, 1.30891831952088, 
0.238197459570994, 0.24746307981515, 1.77029815155847, 0.943166997095137, 
-0.731491039364701, 0.575176326354986, -4.41617566584411, -0.328535198764836, 
-0.705508655028195, 1.08741748000101, 0.193079197000556, 0.0860292534004973, 
0.630629151960268, 0.236888858306952, 2.17109259716636, -2.8833892519717, 
-2.12567295726857, 1.74910898240762, 0.990297747407891, -1.10917367851972, 
-0.144178949159188, -1.02289072616556, -1.43485056278955, 2.18283848683818, 
-1.01483656721891, 0.0659587762110745, -1.25651527791067, -1.63437234050948, 
-0.170734922160125, -0.992297653073651, -1.16729507510477, -1.29407408931265, 
-0.21271847760951, -1.23547445221528, -0.685285690952942, -0.557307166562619, 
0.282263477891351, 0.358498156845029, -0.311496214190627, -0.901945421367976, 
-0.719396486369453, -1.03537982789502, -0.0832719892657412, -0.968328217377821, 
-0.281223111231437, -0.275564295592723, -0.00641284939617758, 
1.74298780799579, -1.79014542232538, -1.709950975661, 0.00689525599882228, 
-0.0500177145502659, 0.0711838347974989, -0.655030525242669, 
-2.75264462962916, -0.459831944368866, -0.893740290367262, -0.860356859968871, 
-0.296875535372695, 0.625346261169757, -0.201871749329745, -0.876449777139245, 
-0.671981338328171, 0.536921209364423, -0.568193982830807, -0.287778631115984, 
0.267754449232864, -0.796556685865996, -1.78237564490419, 0.367217054232045, 
-1.13700598140959, -0.736553960873113, -0.97767160687832, 0.0721226545972085, 
-0.975697244819172, -0.702879901262082, -1.346667716986, -0.842000936776333, 
-3.13695669152873, -0.819837882681791, -1.57858467470969, -0.166213934157747, 
-0.110567476581246, -0.226732644784808, -0.859955726137522, -1.19627035751588, 
-0.457038216365981, 0.297737541331589, 0.0504761293950625, -0.170181898862813, 
-0.203062543561319, -0.209249399612472, 1.33343529699759, -0.0639618484411127, 
0.159979368873168, 0.224602955379792, 0.480729886599388, 0.343980107332912, 
-0.609042767006452, -0.456310966807104, -0.124839219112646, 0.862544210716728, 
0.707372427448195, 0.29564731170416, 0.388975139604406, -0.0673914132426363, 
-0.108359166389498, -0.847946801866106, -0.241637696602411, -2.29696495707422, 
0.103187594182388, 1.02997180347212, 0.20848488460314, 0.175038990116798, 
0.254140432790044, 0.32456169850623, -1.28884816721711, -0.25305999448958, 
-0.280435549069439, 0.129783111729081, 0.696505581886862, 0.195810550750233, 
0.237704039951901, -0.0201150599950721, 0.311171508257207, 0.431893100490909, 
-1.05385834641944, 0.56196544756312, 0.0872542465614776, -1.37703674799056, 
2.14388282294859, 0.324144283712167, -0.742011652568218, 0.602687267961598, 
0.637979881784594, -0.273045016708006, 0.340225011315831, -3.79625168988103, 
0.328076398010847, 1.71126596320773, 2.58301153134219, 0.609459224478087, 
-0.828695926366751, 0.318652991439485, 0.259982449329463, -0.467366087712774, 
-0.211271179027982, -1.59946512375403, 0.134144710605575, -0.537708326991624, 
-0.805937333061094, -0.264353478620012, 0.182614231257469, -0.826028947421264, 
-0.590976932538424, -0.792996096636649, 0.32556100634226, 0.340198052604618, 
0.523398504303264, -0.497831859634394, -1.36158013341006, -0.501554137090991, 
0.0528292947396859, -1.08618540681363, -0.641062620330916, 0.255212671452933, 
-0.115611335796418, -0.420107623998173, -0.809620722211968, -0.328128294263706, 
-0.800492966686664, -1.96505419915995, -0.272704874848973, 1.15970208880062, 
-0.124450730429146, 1.03840257564293, -1.02884596591733, -1.36790384547293, 
1.50190580250741, -0.637476799590091, -0.0172742165822647, -0.629521597669725, 
-0.420727528357511, -0.826215601730892, -1.25330179583314, -0.423191372236422, 
-0.956559126403924, 0.407848136136287, 0.605177684233067, 0.105872166130875, 
-0.969192560580504, -1.37725657917985, -0.108646304515915, 0.777481985207881, 
0.503104767678416, 0.75521694634317, 0.560814307380883, 0.793019509317984, 
0.148153963086554, 6.60118360738271, -0.0824635476256306, -0.815458559554441, 
1.39935507955406, 0.319754431106318, -0.539577451197754, 0.147785313725286, 
0.315667837096094, -1.4576626903524, -0.0468013185211717, -0.880729003994074, 
-0.479034426502694, -0.467051894707999, 0.582508045099538, 0.169120477727666, 
0.735556777540892, -0.783694803940236, -0.758553927494905, -0.413250365905157, 
0.255940820450197, 0.268748567243305, -0.40074588608161, 0.402718421642757, 
1.03923547021603, 0.260988344233306, -0.407322921874327, 0.786078241823542, 
0.0382607869771464, 0.347427125930006, -0.0172980839588269, -0.69868060545236, 
2.84243914858375, -0.32429286954035, 0.796290674007005, -0.790069475437796, 
0.691152316382251, -0.458018571342325, -0.523688831336298, 0.218805243721539, 
-1.44004958324982, -1.07902767848311, -0.618802831764821, -0.9183136639241, 
0.106316500022063, -0.355120271124794, -1.51293090068513, 0.827021033328316, 
-0.431247077614235, -0.124631895358076, -0.767575211750192, 0.794180549195124, 
-1.50295610748919, 1.15855541569815, -0.907370211592907, -1.05526482095774, 
0.604572637512151, -1.59710082765156, 0.480849127835892, 0.794643435320013, 
-0.0560599410658284, 0.52779797713629, -1.04953364827234, -3.13817687133177, 
-1.26734113309967, -0.338263382262322, 0.478134408292091, -1.09093480175224, 
1.37152322639699, -0.132870425678881, 0.392492585052935, -1.10360251969818, 
1.18882467249005, 0.232379001344615, 0.507025038430699, -0.38469609513254, 
0.195149061897995, -0.448011977171219, 1.14198517738627, -0.501414980568675, 
-0.782634379825391, -0.370179901534337, -0.222327742136712, -1.3536826010702, 
-0.246886594613117, 1.01112286441224, -0.726449984852604, -0.0611834401175167, 
-0.675231746561064, 0.170120304260185, 0.368952957937275, 0.856071297582813, 
-0.264913008474678, -0.0160199896829018, -2.96428027845884, -1.06272036960959, 
-0.352122659323441, 0.729572201838782, 0.109541677611228, -0.279573099762489, 
-0.339881089947169, 0.260347901841315, 1.08036992121439, 1.96676447026276, 
-1.82484375889471, 0.504095121243404, -0.8502494025728, 1.93601126289733, 
0.0165554544763009, 0.267125284146003, -0.267524981924074, 0.512385254092628, 
1.65565644900156, 0.64929730116425, 0.370775652573972, -0.670205668208603, 
-0.678565750589002, 0.901284787370084, -1.89680042490088, 0.539784003463239, 
0.941817464289688, -0.184816690248423, 0.648302966992784, 0.486608124460192, 
-0.847206832470949, -1.72515752627397, 0.510947171903677, -2.00460476998889, 
-2.3994795185389, -0.0197889197232414, 0.426068527115076, -0.772389695534714, 
-0.576061481424365, 1.02410612250901, 0.347436920384341, 0.658204711606257, 
-0.395756493777368, 1.30232355605189, 0.303583472245486, -0.505195397530453, 
-0.220323816963634, 0.0491823850015176, -0.276689291531125, 0.561345923581222, 
-0.257699669395681, 1.76884616071314, -0.363215963404029, -0.269762076451423, 
-1.05394804430397, 0.0883677466585698, 0.55886428120105, 0.120147967176446, 
0.237268790836769, 0.552279424678967, -0.174842075507832, -0.646140652329637, 
0.264934394190199, -1.15191478248286, 0.099507312570469, 0.875894330109875, 
-0.254770954998676, -0.921811381432715, -0.731310413018836, -0.328976538865806, 
0.0194957797674813, -0.358502759897048, 1.27092607975028, -0.553673711616297, 
1.53526551536689, 0.136840047848921, -0.864068099028248, 0.249053648963219, 
0.396588778114839, -0.302691932216557, -0.0599146600241084, -0.814051780057418, 
-1.6230493617312, 0.0458530165543, 0.886546144563031, -0.882601178732401, 
-1.07910598865803, 0.565926965816616, 1.00795933621653, -1.10482510311603, 
0.244000774479965, -1.15724371935242, 0.291160543262948, -0.314611573812718, 
-0.190096665977712, 0.631903925524347, -0.719335708835192, -0.659652527002105, 
1.64385718627782, 0.652086803590363, 0.284289891333107, -0.346171618070349, 
-1.00850971705945, 0.40569396206752, 0.825360710795192, 0.35923767506778, 
-1.85531522199514, 0.298160985731822, 0.44425322048872, -0.312581873139339, 
-0.14800910809319, -1.16665884242131, 0.237953056109148, 1.10536235889127, 
0.198970297926926, -0.620634548308864, 1.10487668313101, 0.651484817379012, 
0.00238829791943544, -1.54571387334633, 1.12810917573986, -0.476654241672722, 
0.191673443926402, 0.545502646760812, -0.558269495056837, 0.592905025223653, 
-0.823921065080229, 0.548696362920764, -0.00267692482216809, 
-1.05446279512231, 0.190781853380945, 0.0895322702724061, 0.199515237381846, 
0.69282159327095, -0.131588210767658, -0.686723120082972, 0.118887462035302, 
-0.592312586961902, 0.665877950226347, -1.41062108866906, -0.22125568048553, 
0.161427142367568, 0.218679113983672, -0.184185676337977, -0.642042450606699, 
0.262491120719989, -0.156934323184031, -0.232918073338774, 0.229614314486438, 
-0.0219476870044123, -0.154175696045431, -0.34632122476075, -0.722763491544961, 
0.548315973713004, -0.219615996945168, -0.542112764150423, 0.610531944899577, 
0.565187714689063, -0.431170527789386, -1.33588340785937, -0.147161790906104, 
-0.519708056817981, 0.529630121933655, 1.34752038567393, 0.921084934655193, 
-0.0570239748858183, -1.70280714573984, 0.119968972855896, 0.558853600849176, 
-1.09873627415545, 0.215438837058433, -0.376793577723133, -0.231230388601387, 
0.466514917310657, 0.352019071805851, 0.536777781933581, -0.684587721065969, 
0.622825987696115, -0.382308773244143, 0.92608651667811, 0.869997920511722, 
0.486203077105157, -0.928167714723587, -0.00779161215502142, 
-0.00915177559049145, -0.836954648225757, -0.00223579664039067, 
0.244253559496281, 0.617290250142504, 1.10071531237658, -0.241118802165202, 
-0.554892257323693, -0.796059035979014, -0.023784929738313, -0.579229248869575, 
-1.67129265764308, 0.25999928753661, 0.141065973972062, -0.53820657951709, 
-0.882002616984352, -0.439971867853484, 0.0789346667949166, 0.59799409491324, 
-0.991950971458392, -1.21248376428144, 0.101914731093988, 0.232025307546994, 
0.873059583655794, 1.42936529903276, 0.961679315269169, 0.152809094121932, 
-0.00126153478999699, -0.465239250365343, -0.750762009180822, 
0.336168417316775, 0.58280346262837, -0.0730249914167863, -0.17226679700712, 
-0.0552857357907649, 0.948256033488825, -0.154916920560201, 1.41957188749216, 
-0.11434129968027, 0.103729486785036, -0.0610108835888605, 0.137872184418458, 
0.345960761424211, -0.676886255707371, 0.518957896705093, -0.0379803584951798, 
1.01869466132609, -0.140995092423392, -0.341250483236883, -0.104579514306063, 
1.2913721857042, 0.875835547000151, 0.00695780047803045, -0.322196958546278, 
1.04483787415538, -1.17988290656379, -0.233723571956317, 0.312003482005781, 
0.256499818178193, 0.729690895230712, -0.510019855555037, 1.14632867090362, 
-0.0915427598986568, 0.77780201177402, -0.267340913130169, -0.0446585664674901, 
-1.84556070617476, 0.443735036120243, 1.19869387977597, -1.05656750304718, 
-0.510074023398749, -0.221018556875269, -0.338182691837937, -0.739172064384015, 
-1.01091017778779, 0.0898212020599672, -0.570673560860919, -0.359892676101825, 
-0.14143394820603, -0.0719111173896114, 0.154195500696112, 0.134095875688697, 
-0.349027862786231, -0.241948419805251, 0.577187227539186, 0.0589518529125435, 
-1.1326983779399, 0.681985167782098, 0.0247676759133782, 0.338449175141686, 
-0.235912033198447, -0.66629435194503, 0.234609016926292, -0.276015719631951, 
0.0184164051327495, -0.52862951976089, -0.62448655211702, -0.625205462425434, 
0.0308129821589224, 0.169832356867071, -0.0675439962020257, -0.335156265719873, 
0.289939499363527, 0.216492691185883, -0.185052296627275, 0.0390466223234263, 
-0.43629418334977, -0.0678560677421222, 0.0324673344256579, -0.106756433810707, 
0.669388615171237, -0.593480434486094, -0.84489863572575, -0.273441819321971, 
-0.118239450404089, -0.35516784258004, -0.314773274415866, -0.0744111486012812, 
-0.418263180412545, 0.291280558363797, 0.336052111188905, 0.0412929838147446, 
0.127410152975004, 0.0372287828456799, -0.443394655566975, -0.1448464413968, 
-0.251417883806116, -0.240082178719452, 0.0256651331465712, 0.0501323819302274, 
0.280220852866136, -0.431090118329461, 0.278032434565356, 0.00476355003466865, 
-0.324898387040998, 1.06156249614212, -0.267396369770362, -0.288451149232832, 
0.481974345400434, 0.3835778194991, -0.276820282911064, 0.341971131408471, 
-0.18737623895179, 0.543229481597797, 0.158269791239548, -0.33270044295346, 
0.005113987797434, 0.0610629945619674, 0.870759815105951, -0.939857212890046, 
0.693447648469837, -0.21564364060758, 0.818690644538987, -0.495100817059638, 
0.0801999935683685, -0.414117652856797, -0.262068767380006, -0.460987563219475, 
0.516985392705028, 1.08845877141607, 0.699634117885304, -0.113864811340874, 
-0.34811059775043, 0.277677947417469, 0.32582494575082, -1.0608524006745, 
-0.606829278370588, 0.706750570911386, 0.861543555873043, 0.266021504739545, 
-0.245944097474157, 0.432731169609639, 0.245782936442221, 0.246636193383968, 
-0.132240539986943, -0.383041488481162, -0.269209565457833, 0.447608777502058, 
1.39646945843244, -0.323029136416617, 0.0683788811669906, 0.410235173401285, 
-0.654845220166021, 0.182270610327847, 0.179336855133541, 0.286480135022125, 
-0.0618034188002801, 0.196526617956784, 0.0742617012718445, 0.628804868493663, 
0.330623045111066, 0.424965862753105, 0.673334967836224, 0.329039536846715, 
0.364568694462626, 0.0326392281180162, 0.288466709631247, 0.204461168441012, 
-0.15273973676781, -0.212298396622321, 0.301204052156776, 0.232389205383389, 
0.429818035474654, -0.109368532536639, 0.0232526081739801, 0.292780643589682, 
-0.078171679100864, 0.485486293601713, 0.916565383285362, 0.504434969099229, 
0.102384047941835, -0.252231330120092, -0.677725085214196, 0.1788225573619, 
-0.527566851301186, 0.367065925175855, -0.454802464929815, 0.397487360831877, 
-0.105431782512502, -0.481010507328565, 1.97796162716075, 0.199860583429319, 
0.900903089853859, 0.0954596715751582, -0.0709847445888762, -0.103631004676828, 
-0.258667255055793, 0.509262238267035, 0.190947955773206, -0.511950374337568, 
-0.0253338278451185, -0.918145800756503, -0.220009903530167, 
-0.417432334270558, 0.202555585848551, -0.0683749915699407, 0.0274492645959934, 
0.142167109574362, -0.353040291704636, -1.25284291320824, 0.30428449867194, 
-0.167917819413442, -0.259470788515803, -0.625626874093935, 0.120344940698641, 
-0.0340423234331675, -0.35974698411582, -0.177320544519348, -0.154514566094951, 
-0.163595569762964, -0.375722812759753, 0.393842408583064, -0.411267158055632, 
-0.763041429514844, -0.723582595449693, 0.156284671456111, -0.0154910162160114, 
-0.135468517926807, -0.0857453683724594, -0.413464837717191, 
0.86173762016535, -0.291624728946925, 0.719786119344301, -0.689291733962854, 
0.211833765696179, -0.311784551850024, -0.327736015645687, 0.453142842612771, 
-0.174886235639468, -0.111013224899452, -1.28738904247458, 0.515399075814421, 
-0.1084995369537, -0.263462695961533, 0.347213170887788, -0.600955601076876, 
-0.288524299246509, 0.0255214668530895, -0.0980822281412639, 
0.168126243262674, -0.124085931340922, 0.275267227054985, 0.426384242248704, 
0.561907990342681, 0.747671005738357, -0.13797768562242, -0.359842799779519, 
0.064039972082396, -0.322524232676675, 0.463063641946574, 0.382721001313865, 
-0.299915630020924, -0.426691293822961, 0.108818833521793, 0.426085971711555, 
0.0809145024983514, -0.0431242582401196, -0.33383051757239, -0.266798517826194, 
0.384304117605508, -0.251335076016278, 0.291404080832676, 0.0526393119282687, 
-2.09160325778169, 0.538858644174423, 0.135812306432832, 0.108650707676527, 
-0.0488390259073511, -0.272016690054201, 0.274555854192153, -0.315663302592538, 
0.581423853257172, 0.0828937703183155, 0.0746371280722724, -1.73811032077302, 
-0.343063606446311, 0.390506532704342, 0.214473994879572, 0.135775496280746, 
0.133647865030934, -0.234029791347452, -0.363835725463231, -0.126992633485697, 
-0.467855779173853, 0.40229316353996, 0.0295997374795588, -0.00399969188361794, 
-0.465865152078246, 0.0274301459557879, -0.151337380029726, 0.0736936082945455, 
-0.396558120638469, -0.271257141528674, -0.356720863212037, 1.6371753435722, 
0.191964926105405, 0.0694552388865626, -0.010945498072259, -0.431976839059388, 
-0.0870958547405871, -0.0385676229515488, -0.395502306108774, 
0.345325728156928, -0.107250012229614, -0.0767716938339696, 1.80285871830355, 
0.372394468866632, -0.0062557144192642), dim = 31:30, dimnames = list(
    c("Patient1_001_100", "Patient1_001_101", "Patient1_001_102", 
    "Patient1_001_103", "Patient1_001_104", "Patient1_001_105", 
    "Patient1_001_106", "Patient1_001_107", "Patient1_001_108", 
    "Patient1_001_109", "Patient1_001_110", "Patient1_001_111", 
    "Patient1_001_112", "Patient1_001_113", "Patient1_001_114", 
    "Patient1_001_115", "Patient1_001_116", "Patient1_001_117", 
    "Patient1_001_118", "Patient1_001_119", "Patient1_001_120", 
    "Patient1_001_121", "Patient1_001_122", "Patient1_001_123", 
    "Patient1_001_124", "Patient1_001_125", "Patient1_001_126", 
    "Patient1_001_127", "Patient1_001_128", "Patient1_001_129", 
    "Patient1_001_130"), c("PC_1", "PC_2", "PC_3", "PC_4", "PC_5", 
    "PC_6", "PC_7", "PC_8", "PC_9", "PC_10", "PC_11", "PC_12", 
    "PC_13", "PC_14", "PC_15", "PC_16", "PC_17", "PC_18", "PC_19", 
    "PC_20", "PC_21", "PC_22", "PC_23", "PC_24", "PC_25", "PC_26", 
    "PC_27", "PC_28", "PC_29", "PC_30"))))

expect_equal(dim(reducedDim(spe, "UMAP_seurat")), c(47794L, 2L))

expect_equal(head(reducedDim(spe, "UMAP_seurat"), n = 10), 
             structure(c(5.61402617652043, 5.61535512168034, 5.7323981400214, 
-3.1560033683099, 5.6084295387946, 5.26012955863102, -3.15791477005855, 
1.03990446288212, 6.28714429099186, 5.81284772116764, 1.67653884378058, 
2.30859806027991, 2.43733384099585, -0.132113408178268, 0.416477058201852, 
1.18953498092276, -0.0820669940413812, -5.05728362116235, 1.36943008390051, 
2.48833229032141), dim = c(10L, 2L), dimnames = list(c("Patient1_001_1", 
"Patient1_001_2", "Patient1_001_3", "Patient1_001_4", "Patient1_001_5", 
"Patient1_001_6", "Patient1_001_7", "Patient1_001_8", "Patient1_001_9", 
"Patient1_001_10"), NULL)))

expect_equal(reducedDim(spe, "UMAP_seurat")[100:130,], 
             structure(c(-5.16074265282528, 4.2796941872321, 4.21496258933171, 
6.91017781455143, 5.98549376685246, -5.14885891716854, 7.02924309928044, 
0.251185375042994, 5.83660851676091, 7.61615954596623, 5.68015681464299, 
7.33678208548649, 7.28252898413761, 6.32665692526921, 3.72227417189701, 
-2.87850607674495, 3.28136144835575, -2.10206283371822, 1.09851633269413, 
-5.46949280541317, 7.46542559821232, 5.5700708504401, -1.01656867306606, 
3.37602339942082, 3.34781490523442, 0.619009303637583, 4.03461753089054, 
-3.66415251534359, -4.88862122338192, -5.56093014519588, -1.75899328034298, 
5.36805798497778, -3.00281141313928, -3.37213871988672, 1.85130931821448, 
2.35960151639563, 5.28469302144629, 1.0286635347901, -2.95392964395898, 
2.36999442067725, 0.596180755764069, 0.288799625009122, 0.803500611454072, 
1.58475794282538, 2.18358423200232, -4.62931845697778, -0.575338106483398, 
-1.86515758547205, 2.6895511337815, -4.48088334116357, -1.52226839575189, 
-0.477241616577087, 2.01954056707007, -2.55743239435571, -0.549355368942199, 
-4.9771969130935, -1.26375446829217, 3.08724214521033, 1.04131414380652, 
-1.15450559172052, -1.13911829504388, -2.14402649912256), dim = c(31L, 
2L), dimnames = list(c("Patient1_001_100", "Patient1_001_101", 
"Patient1_001_102", "Patient1_001_103", "Patient1_001_104", "Patient1_001_105", 
"Patient1_001_106", "Patient1_001_107", "Patient1_001_108", "Patient1_001_109", 
"Patient1_001_110", "Patient1_001_111", "Patient1_001_112", "Patient1_001_113", 
"Patient1_001_114", "Patient1_001_115", "Patient1_001_116", "Patient1_001_117", 
"Patient1_001_118", "Patient1_001_119", "Patient1_001_120", "Patient1_001_121", 
"Patient1_001_122", "Patient1_001_123", "Patient1_001_124", "Patient1_001_125", 
"Patient1_001_126", "Patient1_001_127", "Patient1_001_128", "Patient1_001_129", 
"Patient1_001_130"), NULL)))
```

## Session Info

<details>
   <summary>SessionInfo</summary>
   
```{r, echo = FALSE}
sessionInfo()
```
</details>