# Batch effect correction {#batch-effects}

In Section \@ref(cell-quality) we observed staining/expression differences
between the individual samples. This can arise due to technical (e.g.,
differences in sample processing) as well as biological (e.g., differential
expression between patients/indications) effects. However, the combination of these effects
hinders cell phenotyping via clustering as highlighted in Section \@ref(clustering).

To integrate cells across samples, we can use computational
strategies developed for correcting batch effects in single-cell RNA sequencing
data. In the following sections, we will use functions of the
[batchelor](https://www.bioconductor.org/packages/release/bioc/html/batchelor.html),
[harmony](https://github.com/immunogenomics/harmony) and
[Seurat](https://satijalab.org/seurat/articles/integration_introduction.html)
packages to correct for such batch effects.

Of note: the correction approaches presented here aim at removing any
differences between samples. This will also remove biological differences
between the patients/indications. Nevertheless, integrating cells across samples
can facilitate the detection of cell phenotypes via clustering.

First, we will read in the `SpatialExperiment` object containing the single-cell
data.

```{r read-data-batch-correction, message=FALSE}
spe <- readRDS("data/spe.rds")
```

## fastMNN correction

The `batchelor` package provides the `mnnCorrect` and `fastMNN` functions to
correct for differences between samples/batches. Both functions build up on
finding mutual nearest neighbors (MNN) among the cells of different samples and
correct expression differences between the batches [@Haghverdi2018]. The `mnnCorrect` function 
returns corrected expression counts while the `fastMNN` functions performs the 
correction in reduced dimension space. As such, `fastMNN` returns integrated
cells in form of a low dimensional embedding.

Paper: [Batch effects in single-cell RNA-sequencing data are corrected by matching mutual nearest neighbors](https://www.nature.com/articles/nbt.4091)  
Documentation: [batchelor](https://www.bioconductor.org/packages/release/bioc/vignettes/batchelor/inst/doc/correction.html)

### Perform sample correction

Here, we apply the `fastMNN` function to integrate cells between 
patients. By setting `auto.merge = TRUE` the function estimates the best 
batch merging order by maximizing the number of MNN pairs at each merging step. 
This is more time consuming than merging sequentially based on how batches appear in the 
dataset (default). We again select the markers defined in Section \@ref(cell-processing)
for sample correction.

The function returns a `SingleCellExperiment` object which contains corrected
low-dimensional coordinates for each cell in the `reducedDim(out, "corrected")`
slot. This low-dimensional embedding can be further used for clustering and
non-linear dimensionality reduction. We check that the order of cells is the
same between the input and output object and then transfer the corrected
coordinates to the main `SpatialExperiment` object.

```{r, echo=FALSE}
start_time <- Sys.time()
```

```{r batch-correction-fastMNN, message=FALSE, warning=FALSE}
library(batchelor)
set.seed(220228)
out <- fastMNN(spe, batch = spe$patient_id,
               auto.merge = TRUE,
               subset.row = rowData(spe)$use_channel,
               assay.type = "exprs")

# Check that order of cells is the same
stopifnot(all.equal(colnames(spe), colnames(out)))

# Transfer the correction results to the main spe object
reducedDim(spe, "fastMNN") <- reducedDim(out, "corrected")
```

```{r, echo=FALSE}
end_time <- Sys.time()
```

The computational time of the `fastMNN` function call is 
`r round(as.numeric(difftime(end_time, start_time, units = "mins")), digits = 2)` minutes.

Of note, the warnings that the `fastMNN` function produces can be avoided as follows:

1. The following warning can be avoided by setting `BSPARAM = BiocSingular::ExactParam()`

```
Warning in (function (A, nv = 5, nu = nv, maxit = 1000, work = nv + 7, reorth = TRUE,  :
  You're computing too large a percentage of total singular values, use a standard svd instead.
```

2. The following warning can be avoided by requesting fewer singular values by setting `d = 30`

```
In check_numbers(k = k, nu = nu, nv = nv, limit = min(dim(x)) -  :
  more singular values/vectors requested than available
```

### Quality control of correction results

The `fastMNN` function further returns outputs that can be used to assess the
quality of the batch correction. The `metadata(out)$merge.info` entry collects
diagnostics for each individual merging step. Here, the `batch.size` and
`lost.var` entries are important. The `batch.size` entry reports the relative
magnitude of the batch effect and the `lost.var` entry represents the percentage
of lost variance per merging step. A large `batch.size` and low `lost.var`
indicate sufficient batch correction.

```{r batch-correction-fastMNN-QC, message=FALSE}
merge_info <- metadata(out)$merge.info 

merge_info[,c("left", "right", "batch.size")]

merge_info$lost.var
```

We observe that Patient4 and Patient2 are most similar with a low batch effect. 
Merging cells of Patient3 into the combined batch of Patient1,
Patient2 and Patient4 resulted in the highest percentage of lost variance and
the detection of the largest batch effect. In the next paragraph we can
visualize the correction results.

### Visualization

The simplest option to check if the sample effects were corrected is by using
non-linear dimensionality reduction techniques and observe mixing of cells across
samples. We will recompute the UMAP embedding using the corrected
low-dimensional coordinates for each cell.

```{r dimred-batch-correction-fastMNN, message=FALSE, warning=FALSE}
library(scater)

set.seed(220228)
spe <- runUMAP(spe, dimred= "fastMNN", name = "UMAP_mnnCorrected") 
```

Next, we visualize the corrected UMAP while overlaying patient IDs.

```{r visualizing-batch-correction-fastMNN-1, message=FALSE, warning=FALSE, fig.height=3}
library(cowplot)
library(dittoSeq)
library(viridis)

# visualize patient id 
p1 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP before correction")
p2 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP_mnnCorrected", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP after correction")

plot_grid(p1, p2)
```

We observe an imperfect merging of Patient3 into all other samples. This
was already seen when displaying the merging information above.
We now also visualize the expression of selected markers across all cells 
before and after batch correction.

```{r visualizing-batch-correction-fastMNN-2, warning=FALSE, message=FALSE, fig.height=8}
markers <- c("Ecad", "CD45RO", "CD20", "CD3", "FOXP3", "CD206", "MPO", "SMA", "Ki67")

# Before correction
plot_list <- multi_dittoDimPlot(spe, var = markers, reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2, list.out = TRUE) 
plot_list <- lapply(plot_list, function(x) x + scale_color_viridis())
plot_grid(plotlist = plot_list) 

# After correction
plot_list <- multi_dittoDimPlot(spe, var = markers, reduction.use = "UMAP_mnnCorrected", 
                   assay = "exprs", size = 0.2, list.out = TRUE) 
plot_list <- lapply(plot_list, function(x) x + scale_color_viridis())
plot_grid(plotlist = plot_list) 
```

We observe that immune cells across patients are merged after batch correction 
using `fastMNN`. However, the tumor cells of different patients still cluster
separately.

## harmony correction

The `harmony` algorithm performs batch correction by iteratively clustering and
correcting the positions of cells in PCA space [@Korsunsky2019]. We will first
perform PCA on the asinh-transformed counts and then call the `RunHarmony`
function to perform data integration.

Paper: [Fast, sensitive and accurate integration of single-cell data with Harmony](https://www.nature.com/articles/s41592-019-0619-0)  
Documentation: [harmony](https://portals.broadinstitute.org/harmony/index.html)

Similar to the `fastMNN` function, `harmony` returns the corrected
low-dimensional coordinates for each cell. These can be transfered to the
`reducedDim` slot of the original `SpatialExperiment` object.

```{r, echo=FALSE}
start_time <- Sys.time()
```

```{r batch-correction-harmony, message=FALSE, warning=FALSE}
library(harmony)
library(BiocSingular)

spe <- runPCA(spe, 
              subset_row = rowData(spe)$use_channel, 
              exprs_values = "exprs", 
              ncomponents = 30,
              BSPARAM = ExactParam())

set.seed(230616)
out <- RunHarmony(spe, group.by.vars = "patient_id")

# Check that order of cells is the same
stopifnot(all.equal(colnames(spe), colnames(out)))

reducedDim(spe, "harmony") <- reducedDim(out, "HARMONY")
```

```{r, echo=FALSE}
end_time <- Sys.time()
```

The computational time of the `HarmonyMatrix` function call is 
`r round(as.numeric(difftime(end_time, start_time, units = "mins")), digits = 2)` minutes.

### Visualization

We will now again visualize the cells in low dimensions after UMAP embedding.

```{r dimred-batch-correction-harmony, message=FALSE}
set.seed(220228)
spe <- runUMAP(spe, dimred = "harmony", name = "UMAP_harmony") 
```

```{r visualizing-batch-correction-harmony-1, message=FALSE, warning=FALSE, fig.height=3}
# visualize patient id 
p1 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP before correction")
p2 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP_harmony", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP after correction")

plot_grid(p1, p2)
```

And we visualize selected marker expression as defined above.

```{r visualizing-batch-correction-harmony-2, warning=FALSE, message=FALSE, fig.height=8}
# Before correction
plot_list <- multi_dittoDimPlot(spe, var = markers, reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2, list.out = TRUE) 
plot_list <- lapply(plot_list, function(x) x + scale_color_viridis())
plot_grid(plotlist = plot_list) 

# After correction
plot_list <- multi_dittoDimPlot(spe, var = markers, reduction.use = "UMAP_harmony", 
                   assay = "exprs", size = 0.2, list.out = TRUE) 
plot_list <- lapply(plot_list, function(x) x + scale_color_viridis())
plot_grid(plotlist = plot_list) 
```

We observe a more aggressive merging of cells from different patients compared
to the results after `fastMNN` correction. Importantly, immune cell and epithelial
markers are expressed in distinct regions of the UMAP. 

## Seurat correction

The `Seurat` package provides a number of functionalities to analyze single-cell
data. As such it also allows the integration of cells across different samples.
Conceptually, `Seurat` performs batch correction similarly to `fastMNN` by
finding mutual nearest neighbors (MNN) in low dimensional space before
correcting the expression values of cells [@Stuart2019].

Paper: [Comprehensive Integration of Single-Cell Data](https://www.cell.com/cell/fulltext/S0092-8674(19)30559-8)  
Documentation: [Seurat](https://satijalab.org/seurat/index.html)

To use `Seurat`, we will first create a `Seurat` object from the `SpatialExperiment`
object and add relevant metadata. The object also needs to be split by patient
prior to integration. 

```{r prepare-seurat, message=FALSE, warning=FALSE}
library(Seurat)
library(SeuratObject)
seurat_obj <- as.Seurat(spe, counts = "counts", data = "exprs")
seurat_obj <- AddMetaData(seurat_obj, as.data.frame(colData(spe)))

seurat.list <- SplitObject(seurat_obj, split.by = "patient_id")
```

To avoid long run times, we will use an approach that relies on reciprocal PCA
instead of canonical correlation analysis for dimensionality reduction and
initial alignment. For an extended tutorial on how to use `Seurat` for data
integration, please refer to their
[vignette](https://satijalab.org/seurat/articles/integration_rpca.html).

We will first define the features used for integration and perform PCA on cells
of each patient individually. The `FindIntegrationAnchors` function detects MNNs between
cells of different patients and the `IntegrateData` function corrects the
expression values of cells. We slightly increase the number of neighbors to be
considered for MNN detection (the `k.anchor` parameter). This increases the integration
strength.

```{r, echo=FALSE}
start_time <- Sys.time()
```

```{r seurat-correction, message=FALSE, warning=FALSE}
features <- rownames(spe)[rowData(spe)$use_channel]
seurat.list <- lapply(X = seurat.list, FUN = function(x) {
    x <- ScaleData(x, features = features, verbose = FALSE)
    x <- RunPCA(x, features = features, verbose = FALSE)
    return(x)
})

anchors <- FindIntegrationAnchors(object.list = seurat.list, 
                                  anchor.features = features,
                                  reduction = "rpca", 
                                  k.anchor = 20)

combined <- IntegrateData(anchorset = anchors)
```

```{r, echo=FALSE}
end_time <- Sys.time()
```

We now select the `integrated` assay and perform PCA dimensionality reduction.
The cell coordinates in PCA reduced space can then be transferred to the
original `SpatialExperiment` object. **Of note:** by splitting the object into
individual batch-specific objects, the ordering of cells in the integrated
object might not match the ordering of cells in the input object. In this case,
columns will need to be reordered. Here, we test if the ordering of cells in the
integrated `Seurat` object matches the ordering of cells in the main
`SpatialExperiment` object.

```{r message=FALSE, warning=FALSE}
DefaultAssay(combined) <- "integrated"

combined <- ScaleData(combined, verbose = FALSE)
combined <- RunPCA(combined, npcs = 30, verbose = FALSE)

# Check that order of cells is the same
stopifnot(all.equal(colnames(spe), colnames(combined)))

reducedDim(spe, "seurat") <- Embeddings(combined, reduction = "pca")
```

The computational time of the `Seurat` function calls is 
`r round(as.numeric(difftime(end_time, start_time, units = "mins")), digits = 2)` minutes.

### Visualization

As above, we recompute the UMAP embeddings based on `Seurat` integrated results
and visualize the embedding.

```{r umap-seurat, message=FALSE, warning=FALSE}
set.seed(220228)
spe <- runUMAP(spe, dimred = "seurat", name = "UMAP_seurat") 
```

Visualize patient IDs.

```{r visualizing-batch-correction-seurat-1, message=FALSE, warning=FALSE, fig.height=3}
# visualize patient id 
p1 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP before correction")
p2 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP_seurat", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP after correction")

plot_grid(p1, p2)
```

Visualization of marker expression.

```{r visualizing-batch-correction-seurat-2, warning=FALSE, message=FALSE, fig.height=8}
# Before correction
plot_list <- multi_dittoDimPlot(spe, var = markers, reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2, list.out = TRUE) 
plot_list <- lapply(plot_list, function(x) x + scale_color_viridis())
plot_grid(plotlist = plot_list) 

# After correction
plot_list <- multi_dittoDimPlot(spe, var = markers, reduction.use = "UMAP_seurat", 
                   assay = "exprs", size = 0.2, list.out = TRUE) 
plot_list <- lapply(plot_list, function(x) x + scale_color_viridis())
plot_grid(plotlist = plot_list) 
```

Similar to the methods presented above, `Seurat` integrates immune cells correctly.
When visualizing the patient IDs, slight patient-to-patient differences within tumor
cells can be detected. 

Choosing the correct integration approach is challenging without having ground truth
cell labels available. It is recommended to compare different techniques and different
parameter settings. Please refer to the documentation of the individual tools
to become familiar with the possible parameter choices. Furthermore, in the following
section, we will discuss clustering and classification approaches in light of
expression differences between samples.

In general, it appears that MNN-based approaches are less conservative in terms
of merging compared to `harmony`. On the other hand, `harmony` could well merge
cells in a way that regresses out biological signals. 

## Save objects

The modified `SpatialExperiment` object is saved for further downstream analysis.

```{r save-objects-batch-correction}
saveRDS(spe, "data/spe.rds")
```

```{r testing-1, include=FALSE}
library(testthat)

test_that("fastMNN is reproducible", {
    # For some reason the fastMNN results are different between local and CI
    skip_on_ci()
    
    expect_equal(reducedDim(spe, "fastMNN")[100:130,],
             structure(c(0.0555066864233039, -0.376685579206132, -0.252739525524294, 
-0.494775249273822, -0.356174222705102, 0.0943526799704248, -0.258244125426127, 
0.17733053556045, -0.193591777441387, -0.344142131941669, -0.278188983413437, 
-0.219325589487363, -0.311352297948212, -0.307134751140399, -0.319592525280579, 
0.0727360528269941, -0.115121987746013, 0.131544710131599, -0.191972597823719, 
0.207466113820364, -0.448757984064417, -0.142093142041906, 0.0397820688856466, 
-0.00946103924086451, -0.335140380527218, -0.137059173990884, 
-0.209314533911835, 0.0833283457360696, 0.269113975452294, 0.25934754389491, 
-0.0494071609458672, -0.0327775799291401, -0.00714236858566566, 
-0.0588414685784061, -0.118665902512575, -0.119851878685113, 
-0.0863547811818214, -0.0436730080653819, 0.119310255213287, 
0.0344314754388543, 0.00295489342559455, -0.0621008160301834, 
-0.0213738009363044, -0.187183083078127, -0.00846018088839628, 
-0.0862602215620686, 0.156584959494637, 0.0108457386725162, -0.0102979194336111, 
0.0110015129443188, 0.107582520847604, -0.115195268992971, -0.0308356052430772, 
0.169365180946331, 0.126988452933187, -0.0846796197562863, 0.109445225536363, 
-0.0476200624368486, 0.129103076065945, -0.0113683795780981, 
-0.0434178070823923, 0.135561871641459, 0.0693506631634604, 0.0327450891797031, 
-0.0803698636945959, -0.0623667475566475, -0.0395667803556818, 
0.0499985045005842, 0.000466990752991746, -0.10325989444694, 
-0.0679063543439679, 0.0278518013124757, -0.139952956097058, 
-0.0165502865812351, 0.0215319720561742, -0.0304932570053294, 
-0.119499888589694, 0.0370986377014467, 0.0352542179694793, -0.00334412016834903, 
-0.109454826560381, -0.111674491002359, -0.112748089189858, -0.102601365181284, 
0.030200504715045, -0.124642616468368, -0.0822137360818573, -0.00742478169132346, 
0.00413257966238621, 0.0870787166940596, 0.0441880191431011, 
-0.0145475686944586, -0.0114743348719288, -0.156597106252763, 
-0.236094684929595, -0.0624306467014826, -0.352229284049912, 
-0.221021392736712, -0.139925622826313, -0.176471539208473, -0.0881778441632775, 
-0.165534657384002, -0.264827893851503, -0.069829989557507, -0.219548102979185, 
-0.261724712913361, -0.245748599685159, -0.090180863404838, -0.236597633611585, 
-0.145783611167993, 0.00265297083727064, -0.145254486227536, 
-0.0377288399022407, -0.279687936807314, -0.0571158940434893, 
-0.188187501821002, -0.0778106255994327, -0.155628012177308, 
-0.210823526048042, -0.203523838054162, -0.275752688020206, -0.0195502386275699, 
-0.0317864714878119, -0.174219752385599, 0.0668470146477796, 
0.232160629584983, 0.0239720559219634, 0.0447975063351009, 0.0753358624426755, 
0.105904863902053, 0.147474038336105, 0.119224101386351, 0.110874147520982, 
0.142206264168915, -0.110009041331691, 0.098331811616523, 0.0924303415617775, 
0.136546265646412, 0.0776925782009161, 0.0842884051539965, 0.156391421177066, 
-0.028809336380959, 0.180219792096698, -0.0408043560411371, -0.0119228049862121, 
0.0579981368021695, 0.18708123612231, 0.0152919413151482, 0.166885828550716, 
0.14135565336378, 0.105349500485991, 0.129761199280287, -0.0340636361734652, 
-0.00620239392069414, 0.126074953403176, -0.154985253485035, 
0.0369843363332208, -0.114487228493789, 0.0489713934695946, -0.00352662161841868, 
-0.109461597800026, 0.00456622782078878, -0.0552997075380645, 
-0.0346161459717188, 0.0281913410460953, -0.122208157594647, 
0.0115774126039165, -0.0681433642016216, 0.0212631600460597, 
-0.0705445540842436, -0.00165198561308853, -0.0607366339393942, 
-0.0432681782467414, 0.0362397316916961, 0.17250333711553, 0.0227780056950953, 
-0.041748174782414, -0.00928477714425987, -0.0685187496449622, 
-0.0252058105452144, 0.000989503381727364, 0.00193612240802238, 
-0.00770784814221957, 0.0843554729248641, 0.0924659277067343, 
-0.0331345581372456, -0.0228585731785537, 0.0416594888064206, 
0.113887686134824, 0.0268392129406701, 0.0187294686865044, -0.0808791113636265, 
0.029924433391266, -0.0664903993758273, 0.0277622651615942, 0.0529582396028129, 
0.157227427809114, 0.0116268003696106, -0.0151851108939854, 0.0263652525164572, 
0.0839239610023156, 0.00116649528582076, 0.0388720309416176, 
0.0321009652624147, 0.0172384525131936, -0.0243456561698053, 
0.0395818089239406, 0.0734473915773696, -0.00606533880850707, 
0.0599786811546165, 0.0416836545077962, 0.00116627989319901, 
0.0265780184739187, -0.0601217772050757, -0.0436982570882287, 
-0.0539966754786461, 0.0189362911432362, 0.0834014980758258, 
-0.0478390804031047, -0.0220731713252107, 0.0464572450012621, 
-9.70189661060388e-05, 0.0877946346002273, -0.00786677438725711, 
0.00156736249623454, -0.0277291631977686, -0.000518765713634728, 
0.0197400894502952, 0.0479480594058104, -0.0753295359198694, 
-0.0103612049012742, -0.053420898519672, 0.00858059248724463, 
-0.0358827766818376, 0.0331559924775603, 0.0353573280281203, 
-0.0967507889134137, 0.0452225926391208, -0.0582218830798213, 
-0.0222010871467585, -0.0190691183540168, -0.05269953636172, 
0.00315511521691603, 0.0190605445647289, 0.0718953652934959, 
-0.0174418513000815, -0.00284063087017903, -0.0203417384931704, 
0.0998451684266203, 0.000302508984282676, 0.0274717671858806, 
0.0226382029278991, 0.0371074658381416, 0.0354593417703745, 0.0035700600080338, 
0.0386871684122045, -0.00707047550652074, -0.0145288890636233, 
9.27973900927344e-05, -0.0343776862374934, -0.00872364092702, 
-0.00335050562466944, 0.0794627019788202, -0.00514437597898057, 
0.0138561017776895, 0.00197110823815825, -0.0736689210499862, 
0.075789715933634, 0.0217091303284696, -0.0174304835434333, 0.037152854230202, 
0.038933800098954, 0.0423080051318538, -0.0300768817174647, -0.0414648922528551, 
0.0160791054359561, 0.024408244084763, 0.131572066530685, 0.0398751677647523, 
-0.0186253777191856, -0.0207748642504336, -0.0460874943539027, 
0.0321498110324406, 0.000837575827876203, -0.0606720164887489, 
-0.0319899145382063, 0.0108320613732245, -0.0290381113070728, 
-0.0555758111761564, -0.045150308774936, -0.0209707741182465, 
0.0203450104309502, -0.0107904583068994, 0.00848271783271791, 
0.0308434381024673, -0.0459375846997313, -0.00966929917608214, 
-0.0635695434110534, -0.0297989478568491, 0.0144335328679027, 
-0.00567969479114323, 0.0304347098084035, -0.00595739949349746, 
0.0158117351389313, -0.0552673078613463, -0.011287385513057, 
-0.0034652288663771, -0.0365445610679661, -0.0318776558288904, 
-0.0136878168508349, -0.0596396634875313, -0.0423798373545359, 
-0.0998519170885334, 0.0512762616348029, -0.0454852042685576, 
-0.032634153766637, -0.066683574642794, -0.0309792414791641, 
-0.042433894320734, -0.0278651182223758, -0.0825793600777593, 
-0.0485401761343436, -0.0178582279971468, -0.019524668748276, 
-0.0616202929184901, 0.0521813154221659, -0.0329639305710472, 
-0.136356343890165, -0.0587557746017979, -0.0136696443931024, 
-0.0243013681780633, -0.0705748479131594, -0.000818697718328034, 
-0.0491750312959409, -0.0307726386747934, -0.0284943832909215, 
-0.0176256204231322, 0.0395038755282281, -0.0469124374530145, 
-0.0472231808236446, -0.0304706744806545, -0.0804519559508679, 
-0.0346403916721905, -0.00190002808192705, -0.0424993503581421, 
0.0265912162968909, -0.0939154954313602, 0.0277151021241177, 
-0.146277512223971, 0.082362093759294, -0.0514311230787558, 0.00554837427513713, 
-0.00251849074097219, 0.00949452160226631, 0.0184608915589337, 
0.0456605761095473, -0.0641158864392105, 0.00590201370974871, 
-0.0212527703506549, -0.0732886420297585, -0.00246580198923328, 
-0.016968680237046, 0.046198461603803, -0.0836317574481866, 0.0475429549961598, 
0.01217095574193, -0.0224602738618357, -0.0137949543796623, -0.0608249822373647, 
-0.0565999199018669, -0.0538059199813178, 0.0346608524569786, 
-0.0132035924558634, -0.0113499300101072, 0.0100509290335407, 
-0.0026570132594592, 0.0191865211762315, 0.00387116190467113, 
0.0235566471328988, 0.0263360628861923, -0.00154836593438445, 
-0.0396865544299505, 0.000546754335276384, 0.0409795906206373, 
-0.0264713610065198, -0.0152075749797449, 0.0400279349784027, 
0.0285525913513718, 0.0347148105458833, 0.0844982173363206, -0.00677834883010675, 
-0.00787710648688014, 0.0162958391677002, 0.0166599147032981, 
-0.00825080531507753, 0.0632367464287489, 0.0437847366717417, 
0.0237535317435505, 0.0115170659221002, -0.000145025938433308, 
0.0678882250127276, -0.0550509065037379, 0.0341561893864924, 
0.0412617152245407, 0.0503552079963614, 0.0184258429951948, 0.0261554435127881, 
0.0775250852000742, 0.0274241281816282, 0.0569326872107649, 0.00206711810081885, 
0.0293071611961038, 0.0358983916376745, -0.0223471658896151, 
0.0171634137667772, 0.0473127542602661, 0.0592976385051183, -0.00858430497402607, 
0.0331028664688532, -0.0148438015833746, 0.0731466458995994, 
0.0025290372426191, 0.138245240687189, 0.0471908993832605, 0.0360005533749097, 
0.0315702736703723, -0.0023951303367115, 0.0290441748979701, 
0.0339350946259503, 0.0383842341234913, 0.041959209543747, 0.129681884024485, 
0.131915649703635, -0.0275565761770391, -0.0247807687853444, 
-0.00936721220362494, -0.0277304366808384, -0.0190383338792366, 
-0.0162222213466958, 0.0391693446771318, -0.0215798946870169, 
-0.0397807665576878, -0.0368161796503357, -0.00946034326151564, 
-0.0455725026973126, 0.0172355074181117, 0.0354532262944698, 
-0.0151117123960829, -0.0671361340173793, -0.0490812995536939, 
-0.00820492088687049, -0.0215929327701684, 0.0103769496518801, 
-0.0956095421858557, -0.0367685751976901, -0.0210812119125544, 
-0.0729898775685931, -0.052764079585109, -0.0106405290905433, 
-0.0211337813835937, -0.0127472105738778, 0.0303223215707406, 
-0.0233493911462659, -0.0588028419663878, -0.024007977185821, 
0.0457580371303742, 0.0137316997334742, 0.00405508769899622, 
0.0569181709791397, 0.0366997506453044, 0.0648754343506703, 0.0692898379933917, 
0.10336936396102, 0.0505515605906313, 0.0242426503401015, 0.0227287200393402, 
0.034055915740674, 0.110639248719906, 0.0671429647037647, -8.02594482688457e-05, 
0.0121415773427495, 0.0508526404066457, -0.139067586253886, -0.0159170137854751, 
0.00975659999997822, 0.0323124137342274, 0.0403050089675505, 
-0.00281432472252924, 0.05564525089721, 0.0121344557393101, 0.0450849012426618, 
0.0699775768775871, 0.0059773471117456, -0.131732422240258, 0.0634074476275573, 
0.0293343297282773, 0.0623634313658121, -0.0460551549646148, 
-0.0395877951201933, -0.1010745692815, -0.0681248770917488, 0.00564513505875263, 
-0.0235683308694978, 0.00872538207228907, -0.0960003289387772, 
-0.057068956768314, -0.0300817627332878, -0.0703960405548294, 
-0.0800855954280931, -0.113013159790274, -0.0653059600660074, 
0.0289196077974869, -0.0277104351359822, -0.0470109113731935, 
-0.0356468505562619, 0.0122128678528725, -0.0921686574690599, 
-0.0992785934963499, 0.0149402781957114, -0.0313271210105417, 
-0.0767194246135443, -0.0340156935945212, -0.0395319536551978, 
-0.0278851222322525, -0.0510652729428072, 0.0307875794910013, 
0.00990067294108665, -0.0436334255925458, -0.00212328384685945, 
-0.00957276291566211, -0.0141952622884622, -0.0334094926942309, 
-0.00524598353537757, -0.0110970169603058, 0.00156198126945087, 
-0.0249327216141164, 0.0499789029683995, -0.0312192974960022, 
-0.000931683378218325, 0.00241434971476509, 0.00182024525638855, 
0.00423840851608946, 0.027068012626968, 0.0264149134210959, -0.0488526163091095, 
0.0432888657337982, 0.0229965867509951, -0.0287969633889284, 
-0.0451792762874676, -0.00106734361409277, -0.00896311648587119, 
0.0216992897688855, -0.00419284713191106, 0.0311732264706278, 
0.0173345987661852, 0.0146610023451836, 0.0020878527478817, 0.0171596113572166, 
-0.0232407399838341, -0.0967138141634814, -0.0773031694414168, 
-0.109604884975019, -0.170807417921418, -0.0136122241864109, 
-0.0905913365296551, -0.0180082201811178, -0.134356661585017, 
-0.0852939272886329, -0.0717144740177325, -0.0933240088238313, 
-0.0984706238901621, -0.109536695650013, -0.0799999691475837, 
-0.0419994728027613, -0.03021629979843, -0.118994003147859, -0.0168909657313222, 
0.0153460754019851, -0.0752441079497873, -0.109677977740475, 
-0.0260245206348199, -0.0464765708330147, -0.0693930404143731, 
-0.0348808605279563, -0.0882894300941724, -0.0673309771963403, 
-0.138840731143577, 0.0697757266860694, -0.0491397693732511, 
0.0504879807979603, 0.00795804655599808, 0.0652405957854477, 
0.010303885006092, -0.00346653578384348, 0.076180393050171, 0.00909577741990203, 
0.0647652872189794, 0.0179531614648816, -0.00126635143508905, 
0.0641732817427119, 0.0446038651269159, 0.0223899943122417, -0.00569907401168052, 
0.0224087853921547, 0.0488922613900467, 0.0137651692255512, 0.182689983341938, 
-0.00602423199400426, 0.086658496451002, 0.029858554092404, 0.0396285278568809, 
0.045168905959083, 0.0189398848158437, -0.0106415658936581, 0.0200070831677964, 
-0.00713503341311175, 0.0508952404436825, 0.160035177340572, 
0.141368875131917, 0.0369701680266775, 0.0364652904404659, 0.0439321901126694, 
0.0350248887275094, 0.0292668442542893, 0.0280183079733657, 0.0518808085449654, 
0.0168497241750744, -0.0215310652357583, -0.00933318481807096, 
0.0315057576483202, 0.00638453343762929, 0.0136138023338959, 
0.0172529156866275, 0.012355107332743, 0.0359391422777961, -0.0108013412881178, 
0.0256711840700659, 0.0444620330807008, -0.0518354602112145, 
0.0125388850497308, 0.0175441701619556, 0.0040459610051675, 0.0511810693286473, 
0.00614065930421417, 0.0462660545496595, 0.034592555781281, 0.0310990681056794, 
0.00757090560430376, 0.0635922222083423, 0.0814688911109739, 
-0.000678042804397318, 0.0231929005555344, 0.0196147594061883, 
-0.00120524484972441, 0.0118000263856703, 0.00377807225880795, 
-0.00140878096305648, 0.00602256157023158, -0.0224088883191995, 
0.00308333122142237, 0.00434847012161226, 0.0089642116923476, 
0.0305900539861522, -0.00714623759194553, 0.00241892243343799, 
0.0319900494628574, 0.0189579212339809, 0.0236256758852523, -0.0284091300846886, 
0.0372818736607956, 0.0288991424312324, 0.00338220858947109, 
-0.0106877017725447, 0.00583121559834676, -0.00710044479017778, 
0.019482456882789, 0.0073863117305667, 0.00205755624083278, 0.00952792207696736, 
0.0106329026155027, 0.0536021275691259, 0.0318972785229272, 0.0597804119861756, 
0.0866487504818878, 0.0881453190816903, 0.0262438059480489, -0.0404219499930261, 
0.0812793891566826, 0.0973452489732215, 0.0126405119038025, -0.0436248931189695, 
0.0760779183093093, 0.0805082101019516, 0.072971750840727, 0.0121011274621391, 
-0.0397402442843993, 0.089566696654187, 0.0243146536069093, 0.0795022489125833, 
0.0586201583100734, 0.0757143472425071, 0.0389762237250948, 0.0525276236059135, 
-0.00322834577319932, 0.0863040821973156, 0.0190917889252836, 
0.104512913449722, 0.0702969695172205, 0.0940031140372858, 0.0496673305348157, 
0.0515942786154185, 0.0316596669372608, 0.0715159884111184, -0.0179171119505199, 
-0.0144879979127845, 0.0150028550241686, 0.00430446571016739, 
-0.0107952907615753, 0.00137784843708864, 0.0050850835593025, 
0.000603930077711836, -0.00278936882156145, -0.0150402585964438, 
-0.0103223798764542, 0.0148294042110442, -0.014602829343841, 
0.0199685646931066, 0.000861755175856388, -0.00421733039554215, 
-0.0041654034615184, 0.0222224813791979, -0.0256475905699271, 
-0.00958289902387723, 0.00101829484718559, -0.00439374223670644, 
-0.0107780186679144, -0.00539651719390708, 0.0226029710082494, 
-0.0334531908931231, -0.0231928749526589, -0.0296253575901518, 
0.0197802047589982, 0.0188415750990626, -0.0200993456678173, 
0.00553167908055056, 0.0654069568987626, 0.0311976277942525, 
0.108775695786944, 0.0944919179147916, -0.0123207562103062, 0.0244395623355869, 
-0.00516754480871375, 0.103157204942326, 0.0398852164363245, 
0.0852372080379811, 0.0138854100756503, 0.0568565406057042, 0.107607532841567, 
0.0452580193288554, 0.0219380882087457, 0.0239166885640944, -0.00709737149080841, 
0.0207862693463316, 0.0568521746639652, 0.0622889763428052, 0.0674916765895444, 
0.00429059306133424, 0.0542682555895744, 0.0295235568531424, 
0.00880752811761686, 0.0528861065543999, 0.00530905285488861, 
0.00576384199643299, 0.0604913819767532, 0.0632705965486803, 
0.0380252671758709, -0.0297514226958261, -0.0135464946621068, 
0.0571882884416469, 0.0233341370934609, 0.0307122250503271, 0.00800673046040559, 
0.0113950981489067, 0.0120826833246197, 0.00170825581959382, 
0.0196854797637371, 0.0298295009795783, -0.00300461290794871, 
0.0263792386536297, 0.00597581852293875, -0.0066053838551298, 
0.0103615131889087, 0.0288682845457842, -0.00397991969026664, 
-0.0466800191985471, 0.0152953808050235, -0.00529381352901398, 
-0.0247734213283368, 0.0198584596391616, 0.0103889025221804, 
0.00867702423044339, 0.0149608002755079, -0.0274959243303686, 
0.00715461025174414, 0.0116582590687493, 0.0151767945585516, 
0.00482116890685557, -0.0164096932078882, -0.00865242773971668, 
0.0347816661194286, 0.0222402346456312, 0.0225701018113004, -0.00762099360075864, 
-0.0154495257439238, 0.00631924375641697, -0.0278191712088166, 
-0.00483264209868916, 0.0197643114788226, 0.0181415805982666, 
0.00541559503590814, -0.0250153672805714, 0.012053256154928, 
0.02877686447893, -0.0176068799196582, 0.00604278456942368, 0.0287215728210211, 
0.0201869544610238, 0.0030524228963458, -0.0147570433403804, 
0.0170130259073002, 0.00389423146687373, 0.0046989749705354, 
-0.025855272981633, 0.0304025977865429, -0.0121720338409444, 
-0.00788645846784791, 0.0193208987262917, -0.0263384254474628, 
-0.0426622540361808, -0.00374810691082424, -0.031988381220565, 
-0.0282610110597228, -0.00869816176262689, -0.017557632774482, 
-0.0314116283923484, -0.0301011818503935, -0.0136718795391639, 
-0.039159522526968, -0.0435622579213385, -0.06626469872996, -0.0514759806002895, 
-0.0349507174945262, -0.00666096252230823, -0.0236904610482856, 
-0.00792326342920758, -0.00688992424122035, -0.00690371891274296, 
-0.00880920944584887, -0.0266197270237093, -0.0298924205494648, 
-0.00788571418733675, -0.0195634206814721, -0.0330077769604602, 
-0.0488228159036305, -0.0266256441205994, 0.00381560689028226, 
0.0147811354581081, -0.0266972619258605, -0.0435479747962753, 
0.0170076132781089, -0.0128979853273021, 0.026924234724107, -0.0264676523600393, 
-0.0192825491213538, -0.0129511765257251, -0.0116335249136955, 
-0.0312589548982489, -0.0157257401650388, -0.0152693984682477, 
-0.01322228395809, -0.0101571731273043, -0.0204845937209356, 
-0.0253256687540577, -0.0330722725904352, -0.0307862810446647, 
-0.011952966159031, -0.0214529745616757, 0.00934530184183101, 
0.0376017402293333, -0.0299632462501725, -0.0283293685938966, 
-0.0321968336272391, -0.0195453561184567, -0.0192506816066278, 
-0.0398266019401645, -0.0158716831780909, -0.00143827244407394, 
-0.0279726846729399, -0.0408640166564564, 0.0303046696438775, 
0.0118464467046819, 0.0449837374872015, 0.0521406846406885, 0.0566744155073524, 
0.0223615340302092, -0.0202249497364444, 0.0163033954387992, 
0.0182255123774822, 0.0372041790500445, 0.0446597446903211, -0.00421475590762587, 
0.0298152416505037, 0.0380107570379857, 0.0259022940645092, 0.0143739108919433, 
-0.0123963746368886, 0.022706032920436, 0.0457376189416942, 0.0629810007767599, 
0.0370234860278132, 0.0424308239350969, -0.0067255534666703, 
0.0295636594566853, 0.00052891665697587, -0.00190178477654566, 
0.0189869433020292, 0.0301690611269919, 0.0342826761366065, 0.0444854837891297, 
0.00308182736180258, -0.0057396329512834, 0.000652156594485465, 
0.0186534217738638, 0.0315234474210467, 0.0122586010655217, -0.0270705211561491, 
-0.00275496828161327, -0.0217953708241621, -0.00286530300142868, 
0.00846933114060002, 0.00659065810850772, -0.011995131551928, 
0.0341253880721118, 0.00680610775319092, 0.0247684951502281, 
0.0162771285793825, 0.03881627523236, 0.0308504115874135, 0.011805084402254, 
-0.0154789734893282, 0.0314024514008173, -0.00911961239299123, 
-0.031135788047387, -0.0106462251243008, 0.00549980787602597, 
-0.00130969558764618, -0.0105594204182049, 0.0421209875220253, 
0.0243335049509736, 0.0209500045720267, 0.0193000967018484, 0.00607489710830187, 
-0.0136398502608397, -0.0249134564273842, -0.0103941509327084, 
-0.0147288002389298, 0.00186659684058298, -0.0259559035577247, 
0.00766044155972282, -0.018097424558508, -0.00622653335848791, 
-0.0583416994857919, -0.0125260140504867, -0.0135885536980681, 
-0.011009197438023, -0.0199049310459936, 0.00526314617002634, 
-0.0167779685661225, -0.0235411662207863, 0.000897011489441418, 
-0.039723967108065, 0.00645419243841864, -0.0312171456562539, 
0.0152125654442568, -0.00887861086928223, -0.0183522532959697, 
-0.00603159208356828, -0.0242925744376008, -0.00547958964038343, 
0.00138377843407418, -0.0270126126747682, -0.000969657596926501, 
-0.0379146018919459, -0.00583494186407422, -0.00451626800150919, 
-0.0355077574506491, -0.0427566640151123, -0.0016696053021161, 
-0.0210121712624585, -0.0198555928644914, 0.00127015410178151, 
0.00136761105645319, 0.0214887293615971, -0.00979604368817589, 
-0.0298095438542174, -0.0221976927399187, 0.000841222394544494, 
0.00863243862603553, -0.0224384077882825, 0.00564312942662724, 
-0.00126688768920207, -0.0803064091863531, -0.0326992547930266, 
0.0161086554974438, 0.00359577711400688, -0.00812442237952728, 
-0.0119846012390529, -0.00777392718715822, -0.0195153427002153, 
-0.0203825945874387, -0.0370667305618394, -0.0531229738209593, 
-0.00591162017419609, 0.0064076004171142, 0.00406220037479069, 
0.00207900293759924, 0.0456890861182108, 0.0247471155635124, 
-0.0149345304716684, -0.0212243485675998, -0.00587678345075267, 
0.0128021899575927, -0.00352970022816278, 0.00231239080378293, 
-0.00808325588724252, 0.0194060820308352, 0.0123621412140401, 
-0.0108047211160027, -0.0133676511551604, -0.0200230899508758, 
0.00465962299421749, 0.00325629262163034, 0.00329368285116967, 
0.0299708555071227, -0.000532884001919511, -0.0139637643973461, 
-0.0178993910371108, -0.0229920764461106, 0.00379558973424014, 
0.00793135416443388, 0.015315557016266, 0.00910418417549223, 
0.017537362512473, -0.0107541277922863, -0.000987013247938102, 
-0.0311656570534982, 0.0065653001585232, -0.0055885518202638, 
-0.0305101154193489, -0.00332134093234569, 0.00215750650816555, 
-0.0256666976118249, -0.00480696809861828, -0.0122974488011052, 
0.00696620081460667, 0.000464028747424411, -0.00436306599005847, 
-0.0167168519304575, 0.00119011399808615, 0.0133665873365825, 
-0.0365547394461806, 0.0215823506305918, 0.0328893622529672, 
-0.00153269996077489, 0.0151713383049629, -0.00836718183579373, 
-0.00426485500989503, -0.00688842482667262, -0.00720767893969143, 
0.00217474623370382, 0.0217161778791357, -0.0325823563171023, 
-0.00900436383557646, -0.0473908881782194, -0.00893388166135415, 
-0.0323314912429898, -0.037288699172816, -0.0247824133076004, 
-0.0289304070282566, -0.0562785276829641, 0.00034870401858719, 
-0.041520941973138, 0.0216398396038903, -0.0309788694616043, 
-0.0288067054212414, -0.0297618014146456, -0.0075433173956559, 
-0.0282234024973713, -0.0381189370601301, -0.028888830038195, 
-0.0185625677682893, -0.00216221074142321, -0.00697991626614388, 
-0.0281204059280488, -0.0151032475899559, -0.029702561250172, 
-0.00643331711245015, -0.0137763989303242, -0.0240209798048119, 
-0.0179672407353932, -0.0106252564024961, 0.0573828466227139, 
-0.0222254706313383, 0.0125462722215207, -0.0133278228456822, 
-0.0134537509151647), dim = c(31L, 36L), dimnames = list(c("Patient1_001_100", 
"Patient1_001_101", "Patient1_001_102", "Patient1_001_103", "Patient1_001_104", 
"Patient1_001_105", "Patient1_001_106", "Patient1_001_107", "Patient1_001_108", 
"Patient1_001_109", "Patient1_001_110", "Patient1_001_111", "Patient1_001_112", 
"Patient1_001_113", "Patient1_001_114", "Patient1_001_115", "Patient1_001_116", 
"Patient1_001_117", "Patient1_001_118", "Patient1_001_119", "Patient1_001_120", 
"Patient1_001_121", "Patient1_001_122", "Patient1_001_123", "Patient1_001_124", 
"Patient1_001_125", "Patient1_001_126", "Patient1_001_127", "Patient1_001_128", 
"Patient1_001_129", "Patient1_001_130"), NULL)))
    
    expect_equal(head(reducedDim(spe, "UMAP_mnnCorrected"), n = 10),
             structure(c(-5.68709674774978, -4.08356181084487, -3.9715031713185,
0.406542685634164, -6.86016717850539, -3.45563093125197, -2.17657152115676,
1.60496243537095, -8.83462444245193, -5.39916101395461, 0.205106232490877,
0.385086599912981, 0.343267116871217, -1.44879555312123, -1.6039677819344,
-3.13234579173054, -0.549943800840041, -4.74440729227986, -1.92871057597127,
-0.815554912957808), dim = c(10L, 2L), dimnames = list(c("Patient1_001_1",
"Patient1_001_2", "Patient1_001_3", "Patient1_001_4", "Patient1_001_5",
"Patient1_001_6", "Patient1_001_7", "Patient1_001_8", "Patient1_001_9",
"Patient1_001_10"), c("UMAP1", "UMAP2"))))

expect_equal(reducedDim(spe, "UMAP_mnnCorrected")[100:130,],
             structure(c(-0.647811624401541, -6.67081228195998, -6.47172609268996,
-8.377138289803, -4.91355768143508, -0.703490558260413, -5.82361427246902,
2.85219272673753, -5.14411512314651, -6.04714408814284, -7.35421005188796,
-5.50622049271438, -6.60668674408767, -5.00127378403518, -7.23215547501418,
-2.55905309616897, -4.06728807389113, 3.78116592467454, -4.45819106995437,
5.2097438246074, -8.6331197351155, -5.40011421143386, -2.63672533928725,
-1.10023108422134, -6.7623397439656, -4.27042451798293, -5.48645368515822,
-2.60052290856216, 4.11852201522019, 4.16747745574143, -3.51621046959731,
2.23933899792705, 1.261030439463, -1.04409896937337, 0.995997253980974,
-1.31911360827412, 2.49197137745891, 0.43796912225757, -2.26304089632954,
-0.700864668759963, 0.866950873461107, -1.44684004393544, 0.38755995425258,
0.15539345535312, -0.848683055314681, -0.735966916951796, 0.954718236055711,
0.362733010378221, 1.99401295575176, 0.660122696485857, 0.614571754064897,
0.154946778145174, -0.888410921964308, 0.858761612501482, -2.12558543292012,
0.338658664551118, 0.424750153150896, 0.279058922257761, 1.06508684548412,
1.84644365700755, 1.58234751614604, 0.228656251159051), dim = c(31L,
2L), dimnames = list(c("Patient1_001_100", "Patient1_001_101",
"Patient1_001_102", "Patient1_001_103", "Patient1_001_104", "Patient1_001_105",
"Patient1_001_106", "Patient1_001_107", "Patient1_001_108", "Patient1_001_109",
"Patient1_001_110", "Patient1_001_111", "Patient1_001_112", "Patient1_001_113",
"Patient1_001_114", "Patient1_001_115", "Patient1_001_116", "Patient1_001_117",
"Patient1_001_118", "Patient1_001_119", "Patient1_001_120", "Patient1_001_121",
"Patient1_001_122", "Patient1_001_123", "Patient1_001_124", "Patient1_001_125",
"Patient1_001_126", "Patient1_001_127", "Patient1_001_128", "Patient1_001_129",
"Patient1_001_130"), c("UMAP1", "UMAP2"))))

expect_equal(reducedDimNames(spe), c("UMAP", "TSNE", "fastMNN", "UMAP_mnnCorrected", "PCA", "harmony", 
"UMAP_harmony", "seurat", "UMAP_seurat"))

expect_equal(dim(reducedDim(spe, "fastMNN")), c(47794L, 36L))

expect_equal(dim(reducedDim(spe, "UMAP_mnnCorrected")), c(47794L, 2L))

expect_equal(dim(reducedDim(spe, "harmony")), c(47794L, 30L))

expect_equal(head(reducedDim(spe, "harmony"), n = 10),
             structure(c(-1.15998881988164, -3.39106567604373, -2.82944567391184, 
-7.61365725578412, 0.907486960901114, 0.199701464176572, -4.75013036289799, 
1.57343039720961, 0.519134010767422, 0.610932910558848, 5.09604108173292, 
4.66279855883839, 4.25593873403847, 3.49447145576111, 2.06436843261896, 
2.12877662885168, 2.60165871687915, -1.4633796500263, 3.5006413069131, 
3.60675730535935, -0.350494147714564, -0.0892559484292092, 0.224113326084467, 
0.875498560356647, -0.638007997274435, -0.724371462485355, 0.973270363302904, 
0.350629430959436, -0.349998622898803, -0.679625182699179, 0.738362676039422, 
-1.45520620619593, 0.207066109475047, 0.572070178639148, 1.90216261414724, 
2.04116335730029, 0.474253711349838, 0.852740953880013, 1.83812226606269, 
1.40461760687985, 1.11993353038686, -0.340523997772893, -0.221613231624777, 
0.510538116502968, 2.30632548037059, 0.569974814494, -0.384757186616772, 
1.32387240789402, 3.79152453092805, 1.05247289096672, -0.684821562156861, 
-0.446510430741164, -0.18623619503556, 1.06631957061612, 0.327823445364811, 
0.431140904363093, 0.791320367417151, -0.503003498596062, -0.390568958657279, 
-0.199661527415992, -1.02964421946257, -1.67649462738659, -0.720319114514527, 
0.29299877668513, 1.14914055312827, -0.0409535373872491, -0.171207558239531, 
-1.52581237878512, 1.22128601801715, -0.337404247370429, -0.108443151839034, 
0.0239255637581883, 0.811272498370517, 0.872338711118872, 0.546371087157391, 
0.229347670953821, -0.0384617210937493, -0.757705727347054, 0.0917996090005646, 
0.073739535646633, 0.534391726722732, -0.237172104579188, -0.180217471522976, 
0.779210989962219, -0.489285302046971, 0.226193813564269, -0.189226181427628, 
1.75996958088541, -0.896630528768584, -0.0500022617471234, -0.230815347553389, 
-0.824645389892454, -0.348646784600715, -0.467844370311532, 0.0127574166835001, 
-0.348690361247778, 0.0317197557100315, -0.704126529772774, -0.704549026794772, 
-0.215118029535852, -0.192478092341435, 0.290240523363791, 0.399839784626682, 
0.372496427718607, -0.99946287997833, -0.386577963049251, -0.170323247749329, 
-1.09220104344745, -0.889865866081382, 0.0267320017252748, 0.596255849938276, 
0.537826168743066, 0.126402948164382, 0.441233342988999, 0.417504192946301, 
-0.354305439323142, 0.650897166641301, 0.688878126714712, 0.916842631842611, 
0.414474065079925, -0.187240014294795, 0.453277809124187, 0.017339109166262, 
-0.574083052193849, -0.0641472395423206, -0.552683264876961, 
0.238955975993975, -0.159793111750467, -0.00935520895121081, 
-0.176259060035581, 0.306278877973865, -0.213778106651265, -0.138725752710841, 
0.0413212216476015, -0.0751096037594299, 1.02019861868901, 0.910026227031111, 
-0.166219685065859, 0.0685879845685476, 0.36001478017533, -0.0198947980052817, 
0.949350115554519, 0.329064885093393, -0.321443177934493, 0.997830423820286, 
0.113991004416195, 0.0314897317723534, 0.580408632944185, -0.181354263492702, 
0.0392441531877127, -0.0666291236169449, 0.650433992898884, 0.0131769473545568, 
-0.0315552094071054, 0.477878240760466, 0.405815298147881, 0.596579099513433, 
0.00389619991861491, -0.0795316479787468, 0.126213082681566, 
-0.354549992373095, -0.244719392011663, -0.34781440615248, -0.42721035085738, 
0.472863409677476, 0.127276397108356, 0.262238542247804, 0.173068800565048, 
0.315281500832077, -0.626821721126135, 0.161288149929905, 0.579930589980492, 
0.487756891510136, 0.189440403434554, -0.519210251914134, -0.804526346069707, 
-0.0441523031209502, -0.0400207643735324, 0.0559399145511079, 
0.285636928737658, -0.28501612119568, -1.12443450991784, -0.20652791366478, 
0.28893977351747, 0.21561780332319, 0.0485287521148911, 0.338745101728697, 
-0.502953584789587, 0.37624849532904, -0.128839495276231, 0.231795326211438, 
0.890879994491173, 0.557362755310435, 0.388998291002224, 0.688095979935856, 
0.269426435158068, -0.379104293404382, 0.289977759217442, 0.546738060650981, 
0.967588348912491, 0.298303865424916, 0.984115919713235, 0.56658956272241, 
0.00885278483482189, 0.112236192715632, 0.0753449576011975, 0.0736158971847437, 
0.0984324700078995, 0.226640608000927, 0.769833988036894, -0.0896802520490992, 
0.701302790625752, 0.785732022712254, 0.280959910509831, -0.433784421473301, 
-0.488313551972938, -0.180657975073151, 0.701462300738578, -0.183996559092517, 
0.59688472604838, 0.0165942929771203, -0.971528449390337, -1.01265478253511, 
0.0352059505210221, -0.0433216183184302, 0.617390982961843, 0.309711390021321, 
0.746887102703767, 0.178439585557561, -1.41596303360321, -0.20670332192193, 
0.315350184883516, -0.218437763642656, 0.584993669988687, 0.293689575652249, 
0.572927211947246, 0.361860162465272, 0.831143351352982, -0.216686897711864, 
-0.50833742156595, -0.46974233666884, 0.348848104597183, 0.366656062322983, 
0.246815658378999, 0.481179059128202, -0.136143948402302, 0.545035081462414, 
0.0279715334045918, 0.897541769876753, 0.179419861822079, 0.244425193581558, 
-0.853256388703351, -0.494313480680024, 0.00101689723669014, 
0.40296742566629, -0.0333826854293577, -0.918067502564957, 0.327854957042677, 
-0.090043094911341, -0.452469300634422, 0.18670690158671, 0.0522992199568274, 
0.237271449581991, 0.163517461795561, -0.172237328439345, -0.0419123913041026, 
-0.0964040867491361, -0.614255710568056, 0.542004646900877, 0.0561621725090094, 
0.049274740218738, -0.56867562397012, -0.422826551633928, 0.148759326615731, 
0.157345416015629, -0.283734353599969, -0.169980473923803, -0.19905017537625, 
-0.302598656227517, -0.55777010745564, 0.133448212413735, 0.374346882127388, 
-0.524724989099842, 0.297338678141653, 0.0274298835802952, -0.00634532373090483, 
0.0207920815894537, 0.264292734133356, -0.372225222573357, -0.0195749301634168, 
-0.159991919625601, 0.322742703618409, -0.339737115303537, 0.159606184388184, 
0.477378973014343, 0.181561005981218, 0.0833770686309567, -0.281342888341853, 
-0.303302011319233, -0.249694149391713), dim = c(10L, 30L), dimnames = list(
    c("Patient1_001_1", "Patient1_001_2", "Patient1_001_3", "Patient1_001_4", 
    "Patient1_001_5", "Patient1_001_6", "Patient1_001_7", "Patient1_001_8", 
    "Patient1_001_9", "Patient1_001_10"), c("HARMONY_1", "HARMONY_2", 
    "HARMONY_3", "HARMONY_4", "HARMONY_5", "HARMONY_6", "HARMONY_7", 
    "HARMONY_8", "HARMONY_9", "HARMONY_10", "HARMONY_11", "HARMONY_12", 
    "HARMONY_13", "HARMONY_14", "HARMONY_15", "HARMONY_16", "HARMONY_17", 
    "HARMONY_18", "HARMONY_19", "HARMONY_20", "HARMONY_21", "HARMONY_22", 
    "HARMONY_23", "HARMONY_24", "HARMONY_25", "HARMONY_26", "HARMONY_27", 
    "HARMONY_28", "HARMONY_29", "HARMONY_30"))))

expect_equal(dim(reducedDim(spe, "UMAP_harmony")), c(47794L, 2L))

expect_equal(head(reducedDim(spe, "UMAP_harmony"), n = 10),
             structure(c(-6.74963569098971, 0.983713453469065, 0.96953988617399, 
1.08088249510267, -6.80463933402559, -6.657812589946, 1.17699134891966, 
2.28156567162016, -6.88329171592257, -6.96932506019137, 1.54207256190253, 
2.71187427393867, 2.70013597361518, 2.11441674582435, -0.0655559624009031, 
0.085542333645354, 2.0906204258628, -4.69663712628411, -0.0140544498734372, 
0.9547401940055), dim = c(10L, 2L), dimnames = list(c("Patient1_001_1", 
"Patient1_001_2", "Patient1_001_3", "Patient1_001_4", "Patient1_001_5", 
"Patient1_001_6", "Patient1_001_7", "Patient1_001_8", "Patient1_001_9", 
"Patient1_001_10"), c("UMAP1", "UMAP2"))))

expect_equal(reducedDim(spe, "UMAP_harmony")[100:130,],
             structure(c(1.43729830330351, -9.3616437857773, -7.39797830039522, 
-9.12673472816012, -5.12571334296725, 1.92089450901487, -7.44227170402071, 
1.94314075058439, -6.9989409392502, -7.719739908519, -7.22660731727144, 
-7.69212674552462, -7.84372758323214, -7.85073708945772, -8.11271762305758, 
0.765295093712595, -6.25862407142183, 3.61820030754545, -6.28211926871798, 
3.30280852859953, -7.81758975440523, -6.30248927527926, 0.152186976579216, 
-0.621444756331655, -8.4613981192734, 0.34129740839937, -6.81769275123141, 
0.906501477417734, 3.98505139893034, 3.67537785118559, 0.315176119861391, 
2.83209016673041, 0.853131619615088, -1.43655500062035, 1.60533860079719, 
1.93563094489051, 2.64531281344367, 1.21191462628318, -2.44633767254876, 
0.833791998548041, 1.47491624705268, -0.911437126474847, 0.9112831627555, 
1.78390863291694, 1.20822265498115, -1.71485278256463, 2.43169811121894, 
-0.357134136038293, 0.0896467094845874, -0.213918777780999, -1.57245347149896, 
-0.0246971870236295, -0.3797564233117, 2.82522895686103, 0.709802416486274, 
-1.40615865834283, 3.04348566882087, 1.5889992987342, 2.66575219981147, 
0.748059031886588, -0.0796031380467313, 2.7937112127967), dim = c(31L, 
2L), dimnames = list(c("Patient1_001_100", "Patient1_001_101", 
"Patient1_001_102", "Patient1_001_103", "Patient1_001_104", "Patient1_001_105", 
"Patient1_001_106", "Patient1_001_107", "Patient1_001_108", "Patient1_001_109", 
"Patient1_001_110", "Patient1_001_111", "Patient1_001_112", "Patient1_001_113", 
"Patient1_001_114", "Patient1_001_115", "Patient1_001_116", "Patient1_001_117", 
"Patient1_001_118", "Patient1_001_119", "Patient1_001_120", "Patient1_001_121", 
"Patient1_001_122", "Patient1_001_123", "Patient1_001_124", "Patient1_001_125", 
"Patient1_001_126", "Patient1_001_127", "Patient1_001_128", "Patient1_001_129", 
"Patient1_001_130"), c("UMAP1", "UMAP2"))))

expect_equal(dim(reducedDim(spe, "seurat")), c(47794L, 30L))

expect_equal(head(reducedDim(spe, "seurat"), n = 10),
             structure(c(0.060088733970568, 1.60042948651932, 0.803573984151857, 
10.2745878014916, -2.08076361248073, -0.46031199331069, 7.4758907752955, 
-3.50372229784172, -0.980355915332462, -0.804498596490195, -5.76721959330858, 
-6.417039943452, -6.14310143123648, -2.37996291822592, -3.50713759144639, 
-3.32400879278511, -1.11851159147325, 2.76448539922152, -5.31368319611337, 
-6.56849667778046, -2.80914304613788, -3.41134016970554, -3.28521816026936, 
-4.97336644773486, -0.930641073737283, -2.00877216482612, -2.87153360012177, 
0.506475861368121, -2.41140706111309, -2.15825343032356, -0.0953541276756443, 
1.43334473653989, 0.153254672450149, 0.595580506001616, 0.476360062349284, 
0.448370897005963, 1.91846431211823, -1.12521848707942, 0.699890174205056, 
0.0965234605181503, 0.836913981005768, -0.527127066327292, -1.32920974447359, 
0.977447020598823, -0.0556501989003029, -0.294719868567953, 0.502277573968962, 
2.38194045025532, 0.0709353176421447, -0.364945586309787, -0.344311175797197, 
-1.3036165679206, -0.738398441609685, -0.744412756444542, 0.194841382764001, 
-0.665724747359581, -1.33351329198239, -1.21341922867248, 0.300985534858615, 
-0.860499138252836, 0.978533835300044, 0.265275970250486, 0.728979604412328, 
1.8800214961286, -0.236585642662001, 0.079211679841826, -0.214978980783293, 
-0.434114369402799, 0.448787123596697, -0.145178437330049, -1.00901667337852, 
-1.74051767548323, -0.519357028375988, -2.50628698588664, -0.954916564578131, 
-1.75547654029936, -0.7703303771739, -2.90203829190901, -0.302406923577484, 
-0.874243920693582, -1.73409262918697, -2.67269283585392, -1.40963407341205, 
-1.33075882579658, 0.200287335667595, -0.0754014442917917, -1.9123874811174, 
-2.19335527223357, -1.22799050817248, -1.52298158717127, -1.82265413662404, 
0.0673292333935146, 0.179307810485026, 0.77126277679865, -0.576681799418996, 
1.28990816273399, -0.346841267785684, -0.153215391488364, -0.185358086691647, 
0.790871801972064, -1.43975321108048, 0.704173603257415, 0.908977520953089, 
0.122162080934235, 0.979249283958866, 1.28885792849896, 1.33843154726661, 
1.49863050035382, 0.658450148534863, 1.04436152578668, 2.58976878263921, 
0.512868132086514, -0.0597010278287934, 1.05450698059518, 1.25367975242533, 
0.185728489330375, 1.43361334105554, -0.20557840410831, 1.35990672264435, 
-0.0289678694725362, -0.802974771850099, -0.915502610673259, 
-1.03605793572175, -1.36203607609192, 1.42605451634606, 0.567114660601596, 
-0.555555513506999, 0.130362984446453, 0.909760862209094, -0.965886943322733, 
0.218707462379348, 1.4344672329887, 1.05588610316612, 0.684879799486005, 
-0.38948242851999, 0.0127734766128205, -0.581013282580774, 1.15437023200721, 
-0.330521878714953, 1.21393163339094, 0.793571827566387, 1.32031978034934, 
1.14381916752757, 0.128780320333207, 1.3132352472206, -0.332389231503374, 
-0.435395581251785, -0.383144775000726, 1.01006666186628, 1.45261821075027, 
1.35367028773422, -1.10192558566614, -0.322830894637807, -0.218459138197723, 
0.300936474536297, 0.0448148227719804, -0.673318638750285, -1.72976346544118, 
0.822834014236797, 0.566796852619697, -0.583207941592818, -0.401233666804491, 
-1.16644422644891, -0.674253356906263, 0.445095206411926, -0.847202041046607, 
0.274743530302805, 0.997024297501528, -0.0658208824684036, -1.8120323426361, 
-0.290900028618544, -0.109515513826153, 0.160968335610432, 0.886807819766635, 
-0.87462929987369, -2.68503267214577, -1.33236365398833, -0.0332595933569102, 
-0.398096094252125, 0.358253438515981, -1.24714851836387, -0.215812440929738, 
1.80197663917604, 0.235146596073969, -0.854769003475151, -0.669948182838072, 
0.307254743457544, -1.20769172733138, 1.27123428363082, 1.18285843638556, 
-0.0271938717233857, -1.41283903721725, -0.733478517856014, 0.731651722888277, 
-0.0372840854054122, 0.93430888328044, 0.576737163365214, 0.691569712114377, 
1.34235799805981, -1.2849046665878, -1.32316032034682, 0.873793878617713, 
0.538570278601291, -0.411132932841131, -0.657299720105193, -0.763748693783493, 
0.572836126787377, -0.763295279065416, -0.781501343772629, 0.453153130233141, 
0.508869372941362, -0.900794550595998, -0.757524737082363, 0.628852793542247, 
0.261961091181336, -0.250745123235906, -0.35548692044234, 0.348130743822333, 
0.0437433546884397, -0.943689229197296, -0.173546673085704, -0.393398397526365, 
-0.514676174793129, -1.08597833446605, 1.05193738159926, -0.281894802749066, 
-0.050194973375207, 0.0610320797491992, 0.73053452285398, -0.151571335127623, 
0.13704530091489, 0.198440279617291, 0.266948443497781, -0.763418123800748, 
0.212959245832004, 0.313374353619344, -0.498586333258224, 0.1320638482414, 
-0.310006997628633, 0.944729067497234, 0.0159748807104525, -1.12416044320901, 
-0.679438118175875, 0.258533624488876, 0.581399505513219, 0.489550562598132, 
0.334097369228189, -0.157802309884529, -0.193816818588083, -1.07828997134014, 
-0.0173764528404712, -0.25319474240986, 0.825351591740191, 0.0756979425074739, 
-0.568165491102222, -0.152203115221591, -0.670183653180798, -0.331615058601333, 
0.0246041958793121, -0.0837004311827996, -0.525948372192933, 
-0.230726056451718, -0.126612290996127, -0.415900433034821, 0.94710201882289, 
0.189645596232435, -0.220123791130112, -0.285124243167789, 0.428242766463006, 
0.734014881722454, -0.246339250224712, 0.268865564973679, -0.748914670239877, 
-0.838716343686452, -0.438867276472898, 0.222876572916459, 0.258382538757319, 
0.170503176898631, -0.156752818773169, 0.11500020335108, 0.0723094823588518, 
0.163759091276663, 0.230506487017381, -0.244575676885061, 0.118296985874857, 
-0.442938152351508, 0.579414707864478, -0.180268199533028, 0.524401151028761, 
0.843404311602507, 0.0197768773187287, 0.201758911073765, -0.0936983907293298, 
-0.805988075775698, -0.272260235534155, -0.936044546598643, 0.226003512932313, 
0.493468518946181, -0.215517775478203, -0.447802075780917), dim = c(10L, 
30L), dimnames = list(c("Patient1_001_1", "Patient1_001_2", "Patient1_001_3", 
"Patient1_001_4", "Patient1_001_5", "Patient1_001_6", "Patient1_001_7", 
"Patient1_001_8", "Patient1_001_9", "Patient1_001_10"), c("PC_1", 
"PC_2", "PC_3", "PC_4", "PC_5", "PC_6", "PC_7", "PC_8", "PC_9", 
"PC_10", "PC_11", "PC_12", "PC_13", "PC_14", "PC_15", "PC_16", 
"PC_17", "PC_18", "PC_19", "PC_20", "PC_21", "PC_22", "PC_23", 
"PC_24", "PC_25", "PC_26", "PC_27", "PC_28", "PC_29", "PC_30"
))))

expect_equal(reducedDim(spe, "seurat")[100:130,],
             structure(c(5.06585577437499, -5.23629463310309, -4.88861103040016, 
-3.24677100771099, -2.85008678720032, 5.82310970816309, -1.70099880299313, 
-1.95672287164338, -1.48848242775987, -3.26535985779538, -2.62164298538818, 
-1.81404114337191, -1.73715578130927, -2.39878990980533, -5.8783455341065, 
6.81789823144927, -2.00430394324396, 2.79420465637516, -3.17014829592856, 
1.82238339022764, -3.67318960505547, -1.42393200449467, -0.132129499991899, 
-0.190163835595627, -5.71831665525223, -0.514549592792324, 1.64549216630647, 
5.45268571463947, 3.56689525675575, 3.42888808999637, 0.924240104613948, 
-0.870630411485584, 1.52113998420691, 0.562926001940419, -4.51789181570989, 
-4.63036959679748, -1.91254313272232, -3.44863341297905, 2.06244004923029, 
-4.66058597892608, -3.22816778635029, -3.33841200690298, -3.47361861456845, 
-4.53886990078977, -4.57367834833125, 1.89357971518759, 0.944142555334837, 
0.78962288615249, 0.739140619230551, 1.24910144423887, 0.198314945494013, 
-2.38320278797136, -3.89268255821635, 3.83254275483366, 0.7830693219618, 
2.13522113818735, 0.13970855626164, -6.56309897335099, -0.017334660336141, 
0.941717594532587, -0.292649043825905, 3.00615954576586, 1.32946141874551, 
0.763930148010387, 1.47932319596348, -0.813824683749955, -1.01730238394693, 
1.36803550527071, -1.29083892462025, -0.0353567451461414, -2.48847892255679, 
-1.15629765534815, -1.00729489210163, -0.953920582095619, -0.2452346282226, 
-1.31030978899168, 1.79908760187614, -5.0872746558217, 0.739251399465425, 
0.0267442339786786, 0.561202883097928, -2.28318885938093, -0.632343623387996, 
-1.83690503595764, -1.69271915520262, -2.70992398463274, 1.89164227346182, 
-1.91485911805458, -2.92500140818378, -1.6450298664053, -0.100467750740123, 
0.444426139481612, -3.13559895001838, 4.3732011219059, 0.336934913031933, 
0.282632757773173, 0.56318952165125, 0.0638840503010892, 3.20671759613726, 
0.499362947035496, 1.01201669279124, 0.0918754376899213, 0.975522162206627, 
0.66489598651596, 0.906465427532783, 1.25645038320404, 0.237054500310442, 
0.282965603293354, 1.6400199518421, 0.887935829263794, -0.716694685031103, 
0.607514527354989, -4.40781551526454, -0.338454600869265, -0.5968729242483, 
1.11941972769248, 0.248879092353268, 0.100103137955945, 0.706743398502688, 
0.323051933013772, 2.14726420527371, -3.00783472523933, -2.10262175701741, 
1.82498221827096, 0.928571512097015, -1.10616430781559, -0.121474932252387, 
-1.0773405573557, -1.48149846118262, 2.14410057678939, -1.04611971088319, 
0.0973789980943433, -1.31182696544731, -1.62786004587099, -0.197615472450609, 
-0.962982675584781, -1.09603873980257, -1.28076817518241, -0.19075159561465, 
-1.11836929911041, -0.773878577693657, -0.600832801036341, 0.266845756187196, 
0.367136524997003, -0.376114919883442, -0.965595953370593, -0.705066626554553, 
-1.07504108299584, -0.0637709196330042, -0.951096047000799, -0.360945517679555, 
-0.325489392472918, 0.0422659225683851, 1.76750920306809, -1.83080091583248, 
-1.67631781471539, 0.141684315423262, -0.037335616671447, 0.0302622321090737, 
-0.663331931093118, -2.7693022828813, -0.457064123251981, -0.89754642501301, 
-0.859542565224072, -0.284525647575999, 0.610394691205134, -0.166809460537309, 
-0.775415769172709, -0.671547152758156, 0.555967248397876, -0.586052283394743, 
-0.328672053868049, 0.273175060895119, -0.782100277670584, -1.84691127295849, 
0.365521260203279, -1.05554320552897, -0.715869041981198, -1.02212499718641, 
0.0970927870775068, -1.00010444646819, -0.66122032750152, -1.38454001949678, 
-0.95278049844218, -3.22150615629499, -0.822088745241296, -1.5610129128045, 
-0.17307688651603, -0.0764962152859718, -0.202093481334211, -0.864903210818493, 
-1.21932331548576, -0.442962707615657, 0.283325606849681, 0.115129515152379, 
-0.15995416560592, -0.199457006874093, -0.274379115174415, 1.3846968827891, 
-0.0426271821567068, 0.151382335570024, 0.161167359604848, 0.47619004540945, 
0.455631031841622, -0.612751132530562, -0.425278910978914, -0.0970052646165089, 
0.84839350572436, 0.715607439472506, 0.317575786023487, 0.355859397069525, 
-0.0366778439054223, 0.0997912135354507, -0.798636353340365, 
-0.215819136780878, -2.32046893048027, 0.116769748852453, 1.01666236222077, 
0.366390963849509, 0.145690697401272, 0.275942554555666, 0.323694439707417, 
-1.24875401110192, -0.229866597193192, -0.29668747830422, 0.131380591586841, 
0.708984470261744, 0.204756346814875, 0.175560750020143, -0.0306839077915411, 
0.321402870776047, 0.387110851365488, -1.22474379689327, 0.542617219816264, 
0.127502799598867, -1.31326620969277, 2.10635579409059, 0.326494111960913, 
-0.647700742305277, 0.59282079718962, 0.593699342279841, -0.271478659532023, 
0.34642703244378, -3.5791670095864, 0.292367726700626, 1.83708425320783, 
2.65960159929184, 0.651274510954518, -0.80450273126019, 0.326652405787717, 
0.242419589211421, -0.472244667245188, -0.246746119559149, -1.56398857807941, 
0.108713919635715, -0.532773520045668, -0.868734012870849, -0.264641438655683, 
0.204584107815826, -0.811696322379356, -0.558800174643439, -0.821423450074442, 
0.300794013742798, 0.29538739239405, 0.531623237631474, -0.481245829388619, 
-1.3698659897382, -0.515403870174806, 0.0542381315186367, -0.980994348113757, 
-0.656596147489169, 0.158133421239846, -0.152913245668669, -0.530995562958239, 
-0.969585259632229, -0.280746910999435, -0.847975102666338, -1.99421546937751, 
-0.401150062235106, 1.1156370170379, -0.0318240120604938, 1.08564874287349, 
-0.970343955024404, -1.36457456140546, 1.50504140725489, -0.62199594835682, 
-0.0275169172475254, -0.598611778124466, -0.427500698672477, 
-0.796646075597659, -1.29130275814775, -0.402706687830936, -0.955070314668985, 
0.409044307110497, 0.564269549526804, 0.126493195404622, -0.933204167413361, 
-1.37920746691478, -0.119823925469444, 0.825540145742599, 0.439415346659916, 
0.767151881599766, 0.617809135142626, 0.786398677606117, 0.0853487077914039, 
6.64235069078746, -0.156225424757929, -0.841868504624207, 1.42356584437276, 
0.3574682543189, -0.558242092946721, 0.109086742467567, 0.33425623991402, 
-1.47539999650695, -0.166693648788682, -0.869181303454953, -0.442930901224277, 
-0.448499935538203, 0.535092220830789, 0.180537958348835, 0.722239731912208, 
-0.754008307284997, -0.701490499383809, -0.433109271953444, 0.296574511425243, 
0.217429875340291, -0.442229344404338, 0.392625503250019, 1.06272943234038, 
0.293314143989089, -0.435545494153456, 0.754180027226978, 0.046255393762978, 
0.266395923767727, -0.00552050303919737, -0.640780489294955, 
2.87692013888737, -0.423375261922831, 0.846460490069573, -0.798377105479765, 
0.712852800245066, -0.367539013049867, -0.555767802921039, 0.23756674176848, 
-1.45285591949477, -1.06900311056121, -0.588614382492808, -0.873460558263684, 
0.119040834220366, -0.340149092347137, -1.53974921049159, 0.806398331629408, 
-0.482502805680004, -0.117994198544067, -0.732230112161252, 0.810370036046539, 
-1.45458585454629, 1.11554843561855, -0.922518340938414, -1.06369187308966, 
0.611481353156709, -1.63573522655924, 0.490790743448968, 0.767213234083265, 
-0.0435341789344794, 0.47797749212528, -1.11112659432776, -3.19447068325189, 
-1.4192344734026, -0.338693729885628, 0.486585127354188, -1.09525832458381, 
1.34116625375179, -0.117764117861981, 0.390012350071195, -1.0940941904071, 
1.29199569392727, 0.15273617780911, 0.552838607409519, -0.428437252212137, 
0.34206886323636, -0.429157103248741, 1.17305094819634, -0.508055574727057, 
-0.713371355085498, -0.28803693317189, -0.156390882634694, -1.33147199936701, 
-0.320167296359896, 1.00855182134811, -0.607851544913146, -0.153734358866458, 
-0.658185676753111, 0.246660242854173, 0.310977913576119, 0.900872841420158, 
-0.240495399426947, -0.0655979516879856, -2.8460474065984, -1.12668346890064, 
-0.546985018471819, 0.585996277395695, 0.177937479717276, -0.316105666664555, 
-0.281151261651963, 0.243481668563085, 1.11082363882, 1.88130119941073, 
-1.84649781515366, 0.464193675874524, -0.823804816150074, 1.94540604936848, 
0.0280840848728396, 0.231679289522484, -0.250610443866161, 0.521614978793147, 
1.65842927215871, 0.680868049871175, 0.480679211930455, -0.693672788659832, 
-0.763165100815216, 0.943123346747897, -1.87552291774915, 0.55144168389167, 
0.874324349917633, -0.189350197007075, 0.665274361595497, 0.506542225524301, 
-0.841436561457624, -1.35414047638856, 0.542083798938379, -2.08762856684976, 
-2.5063666675092, -0.00230677749312895, 0.430972829755871, -0.722222313426082, 
-0.619892287127266, 1.00129774227093, 0.359530392472297, 0.668093459014304, 
-0.400410984201917, 1.30977033035771, 0.336416249787795, -0.512470999369037, 
-0.198873444401907, 0.0217980561091519, -0.249951574589179, 0.590433235123483, 
-0.260170455788601, 1.7584309627282, -0.375875914520911, -0.191636228528841, 
-1.03150687822392, 0.130282528960245, 0.555811828987973, 0.117296501811963, 
0.149990818181864, 0.592892921074033, -0.174302183424261, -0.686191424579342, 
0.160118286518273, -1.08772793560451, 0.120866900291307, 0.936014587571316, 
-0.278311585784964, -0.941733312082888, -0.720597641799457, -0.34818645632972, 
0.0199625346005445, -0.314686710794625, 1.26338480774637, -0.570592779045024, 
1.57782154867356, 0.180976730862155, -0.854348850104097, 0.235433124756456, 
0.414858822935891, -0.299341079927982, -0.049271604210566, -0.878106523646231, 
-1.60976870984025, 0.0335892828425611, 0.830095157310365, -0.828395050986123, 
-1.05532504777747, 0.580551738246698, 1.00830931876762, -1.11065604949888, 
0.249104859008845, -1.15600659568837, 0.252468047144346, -0.360939827385816, 
-0.156896915887785, 0.6851466890266, -0.75886754148306, -0.66261811953438, 
1.63202138978116, 0.626882668155545, 0.258867875954292, -0.364178427781065, 
-1.04585872411618, 0.392283608259446, 0.852512515199975, 0.379924777443807, 
-1.86122179585024, 0.321375331947286, 0.440672838112249, -0.315382788837317, 
-0.0738625172589425, -1.16289072646973, 0.260709898669302, 1.04460143561359, 
0.171667024625527, -0.649178796048495, 1.08727948446283, 0.634268489391998, 
-0.0167644116322577, -1.45599311147136, 1.13183993375001, -0.51541088564475, 
0.14763578707986, 0.552729977269933, -0.763869704842474, 0.647463451866385, 
-0.928560829659591, 0.593043039578427, 0.0140407841382943, -1.01218608670856, 
0.269466482407932, 0.135874761217233, 0.141140117854586, 0.737913701275055, 
-0.174146425209965, -0.666776503248916, 0.10815736707925, -0.527935103290255, 
0.678067691999966, -1.39312961474877, -0.229825553676196, 0.16111123155173, 
0.216750917630884, -0.119490721821283, -0.580192149989033, 0.254574088987495, 
-0.204241269262276, -0.264508819611123, 0.222539782652963, -0.0635615219637278, 
-0.141178613160492, -0.266787236392364, -0.680857958510378, 0.615514046716319, 
-0.183070104599357, -0.602121676174247, 0.588041821584801, 0.496512587191022, 
-0.487907661095576, -1.33472947669804, -0.131729846493613, -0.359023345548265, 
0.51921394506053, 1.30831264574029, 1.02400215439815, -0.0879250475394652, 
-1.67295454470174, 0.153277254494048, 0.67001874342427, -1.02417810458206, 
0.235672246710328, -0.433308736366523, -0.110336255453464, 0.52630707672955, 
0.369200105632282, 0.513344356504935, -0.713675427691835, 0.567602227211133, 
-0.387086245637884, 0.932424801858216, 0.823954232922268, 0.383732674015659, 
-0.850199729303084, 0.0630413234280749, 0.0379051497571018, -0.790296899065086, 
0.0743127394995666, 0.235214602307558, 0.649711296853074, 1.15533057826535, 
-0.318309525730773, -0.519696404856586, -0.74427992594206, -0.0286738998004873, 
-0.546442830642052, -1.6492054027209, 0.240607753705106, 0.115737129451381, 
-0.528268638112373, -0.888781184933658, -0.476549903232149, 0.0937927136072194, 
0.534420395584278, -0.910003370613534, -1.21950819991097, 0.131173946652847, 
0.214935797365443, 0.854110420853365, 1.41252798587606, 0.955339359109126, 
0.200740426852921, 0.0750317271864093, -0.417599085120641, -0.799917287574853, 
0.269224314920562, 0.576389617976715, -0.0327373585643401, 0.0390195727152535, 
-0.0329366507294666, 0.981910873510282, -0.129931662818271, 1.38812283791732, 
-0.152228180821042, 0.0630215125181372, -0.0783177537963518, 
0.146042700588527, 0.35824433503178, -0.721229016722985, 0.536496428402871, 
-0.0326667402960762, 1.07376646706236, -0.126443060841126, -0.345515051234042, 
-0.115154840090553, 1.25206489473033, 0.889169710890936, -0.00330232191616354, 
-0.382077121743593, 0.998558701854853, -1.24241497232365, -0.250172117249413, 
0.328657907002524, 0.259299426694801, 0.739307720149481, -0.512427129229101, 
1.26732563733019, -0.100423559508707, 0.743831592231214, -0.20454424794269, 
0.0557984888821937, -1.9729597557325, 0.358410870779359, 1.17562810161854, 
-1.06919856344923, -0.51738409752618, -0.226443970602416, -0.394431707721976, 
-0.756798745303141, -1.00090251710382, 0.102062298784794, -0.555888811786037, 
-0.407926408318461, -0.155638863379262, -0.0763541171341232, 
0.192098353230333, 0.213304045631687, -0.369732182115218, -0.247080926475528, 
0.605851851343557, 0.0730178630674068, -1.11704303478944, 0.71316772873599, 
0.0106997749644124, 0.288739518667285, -0.238220922505588, -0.655424947545393, 
0.169998588195272, -0.264996326342008, 0.0101104404283547, -0.538307438546981, 
-0.638922602527902, -0.543103941818463, -0.00268477861722443, 
0.196480695777593, -0.0934733718833296, -0.370156093872478, 0.317309036863657, 
0.162323116633769, -0.195856811080953, 0.0118465240738551, -0.47437080810479, 
-0.0888546686845153, 0.0711555375515627, -0.132465928063116, 
0.679027349738989, -0.545179510316495, -0.805016378855451, -0.296417570426428, 
-0.139601276525931, -0.360905817708512, -0.340349137034009, -0.140975756410744, 
-0.385725669196632, 0.288501032858428, 0.356277951921106, 0.0260045490243491, 
0.121811467433554, 0.0291818845270477, -0.439239567293903, -0.179945585950185, 
-0.229281025331001, -0.375717464582555, 0.00344918105215139, 
0.069734719113975, 0.317602238998977, -0.454321550778759, 0.29847417731676, 
-0.021468436052064, -0.315382836439025, 1.11018231545639, -0.244671716218335, 
-0.263414019620676, 0.483317149473267, 0.412997812120117, -0.259190788457119, 
0.359099226786128, -0.175159168915026, 0.455490721008287, 0.163455774506316, 
-0.319203483286883, 0.0611526623917361, 0.0640517100884266, 0.840344262733369, 
-0.95294753632299, 0.683822581867665, -0.233986129575517, 0.777218946787389, 
-0.500479617191879, 0.136848760062882, -0.407877198099762, -0.19732257220413, 
-0.435255635643588, 0.440261837114878, 1.1270846826665, 0.717849339951553, 
-0.0980032704643946, -0.357673934469258, 0.127662283060104, 0.317043466121087, 
-1.078244550306, -0.594701613078307, 0.729850144676152, 0.873651523204338, 
0.284646932771903, -0.295283276846473, 0.440157992584754, 0.284102719740322, 
0.277277090218861, -0.150477846061782, -0.399380400143252, -0.298090851422459, 
0.403798195610855, 1.37015626747023, -0.324342530965946, 0.0626550650233058, 
0.4074260752652, -0.648986609572797, 0.186744981339739, 0.214441450607226, 
0.253096562519015, -0.0553780759002651, 0.0905088379177629, -0.0615039073305219, 
0.631226808777433, 0.410660147446261, 0.462948422959244, 0.744853131414797, 
-0.271321182126354, -0.451694408434318, -0.0104329636960199, 
-0.286124704858265, -0.19469924921255, 0.160522960256927, 0.227437345929682, 
-0.307992014464715, -0.212673902518795, -0.418853432572189, 0.105913725192086, 
-0.0197263325375936, -0.239472538093181, 0.0603681220958378, 
-0.40984128823762, -0.818624502848709, -0.535348990929691, -0.111978037083798, 
0.27286738269136, 0.629367675790121, -0.207199285893202, 0.508486725310312, 
-0.365881102311964, 0.483538898441662, -0.381618759347365, 0.047640885484573, 
0.462241790235106, -1.95136253886644, -0.16278689149206, -0.956969105509265, 
-0.10381456547379, -0.101113651007771, -0.180394794471561, -0.250635726631332, 
0.503296248213897, 0.181902839299538, -0.496900643692432, -0.00475297803985831, 
-0.937296704351403, -0.216357209312804, -0.42849641852968, 0.174026490939544, 
-0.0503728394663138, 0.0234120014324011, 0.148175212620992, -0.336709534672212, 
-1.26512833775045, 0.202025916545275, -0.125271034853999, -0.230363529742838, 
-0.599179386176199, 0.139129524037646, 0.00274208599164002, -0.37878696970184, 
-0.186556022830407, -0.184869659974987, -0.201180354969695, -0.29844448094361, 
0.309535056164222, -0.44520015108045, -0.765182247036765, -0.768615607156983, 
0.139861562982969, -0.030029359320904, -0.177843163255058, -0.0886368851327863, 
-0.444990535557871, 0.871826083873028, -0.266925314508773, 0.707412418259676, 
-0.727154926274436, 0.217812385322079, -0.336296800298622, -0.332675162591923, 
0.421706017488162, -0.221523709622854, -0.0951968308244063, -1.2518186451405, 
0.429709742491969, -0.105110016673238, -0.262031770977076, 0.330767463399627, 
-0.594507130834354, -0.221992973095275, 0.0527914332426134, -0.12985181189722, 
0.155613650805941, -0.158458191096041, 0.287930673284778, 0.452794418735577, 
0.613313268515672, 0.763450659151635, -0.185498649528809, -0.334197094289102, 
0.0834544511154684, -0.314142292520295, 0.417420700869303, 0.374654393382433, 
-0.266592906085646, -0.46098322553959, 0.123139841423927, 0.424594749209926, 
0.0898389552615249, -0.0509777671696602, -0.26754854215441, -0.299728308058805, 
0.409795078598667, -0.272994749281182, 0.272156753674245, 0.073627424339621, 
-2.0521440612778, 0.567280229480757, 0.184118762054162, 0.0886856389125722, 
-0.0923392612183611, -0.294204260085171, 0.336036572476455, -0.307261538019663, 
0.459013440469413, 0.0870836603276016, 0.0929484672763471, -1.62261723051205, 
-0.28102872290382, 0.426934189016944, 0.110969550724112, 0.126798818983111, 
0.0688856716514336, -0.249760216489928, -0.35767514482227, -0.118413230310546, 
-0.50785625183864, 0.386074810013147, 0.0331133777221076, -0.012683234674175, 
-0.461015384480039, 0.0688713949385474, -0.124977176787765, 0.0786312259371853, 
-0.387671143200746, -0.287638924052297, -0.406942162530766, 1.563553241559, 
0.0907136532204201, 0.014485283864444, 0.00233722231866624, -0.38595024337687, 
-0.0313546003714709, 0.0170743197780638, -0.37741849720534, 0.178098936656919, 
-0.0813765683953077, -0.150308698314102, 1.74610277205502, 0.305343597625825, 
-0.036839070339424), dim = 31:30, dimnames = list(c("Patient1_001_100", 
"Patient1_001_101", "Patient1_001_102", "Patient1_001_103", "Patient1_001_104", 
"Patient1_001_105", "Patient1_001_106", "Patient1_001_107", "Patient1_001_108", 
"Patient1_001_109", "Patient1_001_110", "Patient1_001_111", "Patient1_001_112", 
"Patient1_001_113", "Patient1_001_114", "Patient1_001_115", "Patient1_001_116", 
"Patient1_001_117", "Patient1_001_118", "Patient1_001_119", "Patient1_001_120", 
"Patient1_001_121", "Patient1_001_122", "Patient1_001_123", "Patient1_001_124", 
"Patient1_001_125", "Patient1_001_126", "Patient1_001_127", "Patient1_001_128", 
"Patient1_001_129", "Patient1_001_130"), c("PC_1", "PC_2", "PC_3", 
"PC_4", "PC_5", "PC_6", "PC_7", "PC_8", "PC_9", "PC_10", "PC_11", 
"PC_12", "PC_13", "PC_14", "PC_15", "PC_16", "PC_17", "PC_18", 
"PC_19", "PC_20", "PC_21", "PC_22", "PC_23", "PC_24", "PC_25", 
"PC_26", "PC_27", "PC_28", "PC_29", "PC_30"))))

expect_equal(dim(reducedDim(spe, "UMAP_seurat")), c(47794L, 2L))

expect_equal(head(reducedDim(spe, "UMAP_seurat"), n = 10),
             structure(c(-6.30726911836122, -5.97889663987611, -5.98339369111512, 
2.75099227613952, -5.62836410813783, -5.26551582627748, 2.85443899817016, 
-0.790762327246409, -6.3448395948932, -5.96977903657411, 1.51378366599094, 
2.16235563406956, 2.33012888083469, 0.331438886618728, 0.39500845471632, 
1.24023279795658, 0.383692468202228, -5.11004379143704, 1.2174413527013, 
2.36532375464451), dim = c(10L, 2L), dimnames = list(c("Patient1_001_1", 
"Patient1_001_2", "Patient1_001_3", "Patient1_001_4", "Patient1_001_5", 
"Patient1_001_6", "Patient1_001_7", "Patient1_001_8", "Patient1_001_9", 
"Patient1_001_10"), c("UMAP1", "UMAP2"))))

expect_equal(reducedDim(spe, "UMAP_seurat")[100:130,],
             structure(c(5.77337835020568, -4.17676164918397, -4.01313950829957, 
-6.74035742097352, -6.05311729722474, 5.83025167173888, -7.15657570176576, 
-0.428575656943064, -5.99176122956727, -7.95665314012025, -5.68182565980409, 
-7.62292768769715, -7.54737856202577, -6.25049783997987, -3.4662242155597, 
2.68279121107604, -3.08191706948731, 2.65005705542113, -0.954571865133982, 
5.16357133574035, -6.99033214860414, -5.82851173692201, 1.0260613936856, 
-3.26752879434083, -3.17167403512452, -1.2152773361728, -4.17144682221864, 
3.9124436158612, 4.61771915144469, 5.39934537596251, 1.57971797174956, 
5.10499260077488, -3.28388574471462, -3.3660302435397, 1.93100747714054, 
2.30516788611423, 5.12336275229465, 0.800875159597511, -2.81425145020474, 
2.32763621459019, 0.211867811775322, 0.286723450210432, 0.671634914970512, 
1.27783951411259, 2.24360880503666, -4.65335109581936, -0.146418092155342, 
-1.78862550606716, 2.7857739652158, -4.59741094460476, -2.00383737435329, 
-0.222590414190178, 1.81503948817265, -2.15035632004726, -0.542243627214318, 
-4.96107175698269, -0.944236901903038, 3.06204816946995, 1.69991299757969, 
-1.63105156769741, 4.9632961476804, -1.78220250954617), dim = c(31L, 
2L), dimnames = list(c("Patient1_001_100", "Patient1_001_101", 
"Patient1_001_102", "Patient1_001_103", "Patient1_001_104", "Patient1_001_105", 
"Patient1_001_106", "Patient1_001_107", "Patient1_001_108", "Patient1_001_109", 
"Patient1_001_110", "Patient1_001_111", "Patient1_001_112", "Patient1_001_113", 
"Patient1_001_114", "Patient1_001_115", "Patient1_001_116", "Patient1_001_117", 
"Patient1_001_118", "Patient1_001_119", "Patient1_001_120", "Patient1_001_121", 
"Patient1_001_122", "Patient1_001_123", "Patient1_001_124", "Patient1_001_125", 
"Patient1_001_126", "Patient1_001_127", "Patient1_001_128", "Patient1_001_129", 
"Patient1_001_130"), c("UMAP1", "UMAP2"))))
    
    
})

```

## Session Info

<details>
   <summary>SessionInfo</summary>
   
```{r, echo = FALSE}
sessionInfo()
```
</details>