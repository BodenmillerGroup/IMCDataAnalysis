# Batch effect correction

In Section \@ref(cell-quality) we observed staining/expression differences
betweem the individual samples. This can arise due to technical (e.g.,
differences in sample processing) as well as biological (e.g. differential
expression between patients) reasons. However, the combination of these effects
hinders cell phenotyping via clustering as highlighted in Section \@ref(clustering).

To correct for differences between the samples, we can use computational strategies
developed for correcting batch effects in single-cell RNA sequencing data.
The `r BiocStyle::Biocpkg("batchelor")` package offers a number of approaches
to correct for such batch effects. We will use the `fastMNN` function while
supplying the patient information as batch vector.

Of note: the correction approach presented here aims at removing any differences
between samples. This will also remove biological samples between the patients.

## Read data

First, we will read in the `SpatialExperiment` object containing the single-cell
data.

```{r read-data-batch-correction, message=FALSE}
spe <- readRDS("data/spe.rds")
```

## fastMNN correction

### Perform sample correction

```{r batch-correction-fastMNN, message=FALSE}
library(batchelor)
set.seed(220228)
out <- fastMNN(spe, batch = spe$patient_id, 
               auto.merge = TRUE, correct.all = TRUE,
               subset.row = rowData(spe)$use_channel,
               assay.type = "exprs")
```

### Quality control on correction results

```{r}
merge_info <- metadata(out)$merge.info 

# Next, we will look at the batch.size argument - the raltive magnitute of the batch effect
DataFrame(left = merge_info$left,
          right = merge_info$right,
          batch.size = merge_info$batch.size,
          max_lost_var = rowMax(merge_info$lost.var))

# Transfer the correction results to the main sce object
assay(spe, "corrected") <- assay(out, "corrected")
```

### Visualization

```{r dimred-batch-correction-fastMNN, message=FALSE}
library(scater)

set.seed(220228)
spe <- runUMAP(spe, exprs_values = "corrected", name = "UMAP_mnnCorrected") 
spe <- runTSNE(spe, exprs_values = "corrected", name = "TSNE_mnnCorrected") 
```

```{r visualizing-batch-correction-fastMNN, message=FALSE}
library(patchwork)
library(dittoSeq)
library(viridis)

# visualize patient id 
p1 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP before correction")
p2 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP_harmony", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP after correction")

p1 + p2
```

Visualize markers

```{r, warning=FALSE}
p1 <- dittoDimPlot(spe, var = "Ecad", reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "Ecad") +
    ggtitle("E-Cadherin expression before correction")
p2 <- dittoDimPlot(spe, var = "Ecad", reduction.use = "UMAP_harmony", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "Ecad") +
    ggtitle("E-Cadherin expression after correction")

p1 + p2

p1 <- dittoDimPlot(spe, var = "CD45RO", reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "CD45RO") +
    ggtitle("CD45RO expression before correction")
p2 <- dittoDimPlot(spe, var = "CD45RO", reduction.use = "UMAP_harmony", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "CD45RO") +
    ggtitle("CD45RO expression after correction")

p1 + p2

p1 <- dittoDimPlot(spe, var = "CD20", reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "Ecad") +
    ggtitle("CD20 expression before correction")
p2 <- dittoDimPlot(spe, var = "CD20", reduction.use = "UMAP_harmony", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "CD45RO") +
    ggtitle("CD20 expression after correction")

p1 + p2

p1 <- dittoDimPlot(spe, var = "CD3", reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "Ecad") +
    ggtitle("CD3 expression before correction")
p2 <- dittoDimPlot(spe, var = "CD3", reduction.use = "UMAP_harmony", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "CD45RO") +
    ggtitle("CD3 expression after correction")

p1 + p2

p1 <- dittoDimPlot(spe, var = "FOXP3", reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "FOXP3") +
    ggtitle("FOXP3 expression before correction")
p2 <- dittoDimPlot(spe, var = "FOXP3", reduction.use = "UMAP_harmony", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "FOXP3") +
    ggtitle("FOXP3 expression after correction")

p1 + p2
```

## harmony correction

```{r batch-correction-harmony, message=FALSE}
library(harmony)

mat <- t(assay(spe, "exprs")[rowData(spe)$use_channel,])
set.seed(220228)
harmony_embeddings <- HarmonyMatrix(
    mat, spe$patient_id, do_pca = TRUE, verbose=TRUE
)

reducedDim(spe, "harmony") <- harmony_embeddings
```

### Visualization

```{r dimred-batch-correction-harmony, message=FALSE}
library(scater)

set.seed(220228)
spe <- runUMAP(spe, exprs_values = "corrected", name = "UMAP_mnnCorrected") 
spe <- runTSNE(spe, exprs_values = "corrected", name = "TSNE_mnnCorrected") 
```

```{r visualizing-batch-correction-harmony, message=FALSE}
library(patchwork)
library(dittoSeq)
library(viridis)

# visualize patient id 
p1 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP before correction")
p2 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP_harmony", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP after correction")

p1 + p2
```

Visualize markers

```{r, warning=FALSE}
p1 <- dittoDimPlot(spe, var = "Ecad", reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "Ecad") +
    ggtitle("E-Cadherin expression before correction")
p2 <- dittoDimPlot(spe, var = "Ecad", reduction.use = "UMAP_harmony", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "Ecad") +
    ggtitle("E-Cadherin expression after correction")

p1 + p2

p1 <- dittoDimPlot(spe, var = "CD45RO", reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "CD45RO") +
    ggtitle("CD45RO expression before correction")
p2 <- dittoDimPlot(spe, var = "CD45RO", reduction.use = "UMAP_harmony", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "CD45RO") +
    ggtitle("CD45RO expression after correction")

p1 + p2

p1 <- dittoDimPlot(spe, var = "CD20", reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "Ecad") +
    ggtitle("CD20 expression before correction")
p2 <- dittoDimPlot(spe, var = "CD20", reduction.use = "UMAP_harmony", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "CD45RO") +
    ggtitle("CD20 expression after correction")

p1 + p2

p1 <- dittoDimPlot(spe, var = "CD3", reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "Ecad") +
    ggtitle("CD3 expression before correction")
p2 <- dittoDimPlot(spe, var = "CD3", reduction.use = "UMAP_harmony", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "CD45RO") +
    ggtitle("CD3 expression after correction")

p1 + p2

p1 <- dittoDimPlot(spe, var = "FOXP3", reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "FOXP3") +
    ggtitle("FOXP3 expression before correction")
p2 <- dittoDimPlot(spe, var = "FOXP3", reduction.use = "UMAP_harmony", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "FOXP3") +
    ggtitle("FOXP3 expression after correction")

p1 + p2
```

## Seurat correction

```{r, message=FALSE}
library(Seurat)
library(SeuratObject)
seurat_obj <- as.Seurat(spe, counts = "counts", data = "exprs")
seurat_obj <- AddMetaData(seurat_obj, as.data.frame(colData(spe)))

seurat.list <- SplitObject(seurat_obj, split.by = "patient_id")

anchors <- FindIntegrationAnchors(object.list = seurat.list, anchor.features = rownames(spe)[rowData(spe)$use_channel])

combined <- IntegrateData(anchorset = anchors)

DefaultAssay(combined) <- "integrated"

# Run the standard workflow for visualization and clustering
combined <- ScaleData(combined, verbose = FALSE)
combined <- RunPCA(combined, npcs = 30, verbose = FALSE)
```

### Visualization

```{r dimred-batch-correction-harmony, message=FALSE}
library(scater)

reducedDim(spe, "seurat_integrated") <- combined@reductions$pca@cell.embeddings

set.seed(220228)
spe <- runUMAP(spe, dimred = "seurat_integrated", name = "UMAP_seurat") 
spe <- runTSNE(spe, dimred = "seurat_integrated", name = "TSNE_seurat") 
```

```{r visualizing-batch-correction-harmony, message=FALSE}
library(patchwork)
library(dittoSeq)
library(viridis)

# visualize patient id 
p1 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP before correction")
p2 <- dittoDimPlot(spe, var = "patient_id", 
                   reduction.use = "UMAP_seurat", size = 0.2) + 
    scale_color_manual(values = metadata(spe)$color_vectors$patient_id) +
    ggtitle("Patient ID on UMAP after correction")

p1 + p2
```

Visualize markers

```{r, warning=FALSE}
p1 <- dittoDimPlot(spe, var = "Ecad", reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "Ecad") +
    ggtitle("E-Cadherin expression before correction")
p2 <- dittoDimPlot(spe, var = "Ecad", reduction.use = "UMAP_seurat", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "Ecad") +
    ggtitle("E-Cadherin expression after correction")

p1 + p2

p1 <- dittoDimPlot(spe, var = "CD45RO", reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "CD45RO") +
    ggtitle("CD45RO expression before correction")
p2 <- dittoDimPlot(spe, var = "CD45RO", reduction.use = "UMAP_seurat", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "CD45RO") +
    ggtitle("CD45RO expression after correction")

p1 + p2

p1 <- dittoDimPlot(spe, var = "CD20", reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "Ecad") +
    ggtitle("CD20 expression before correction")
p2 <- dittoDimPlot(spe, var = "CD20", reduction.use = "UMAP_seurat", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "CD45RO") +
    ggtitle("CD20 expression after correction")

p1 + p2

p1 <- dittoDimPlot(spe, var = "CD3", reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "Ecad") +
    ggtitle("CD3 expression before correction")
p2 <- dittoDimPlot(spe, var = "CD3", reduction.use = "UMAP_seurat", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "CD45RO") +
    ggtitle("CD3 expression after correction")

p1 + p2

p1 <- dittoDimPlot(spe, var = "FOXP3", reduction.use = "UMAP", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "FOXP3") +
    ggtitle("FOXP3 expression before correction")
p2 <- dittoDimPlot(spe, var = "FOXP3", reduction.use = "UMAP_seurat", 
                   assay = "exprs", size = 0.2) +
    scale_color_viridis(name = "FOXP3") +
    ggtitle("FOXP3 expression after correction")

p1 + p2
```

## Save objects

The modified `SpatialExperiment` object is saved for further downstream analysis.

```{r save-objects-quality-control}
saveRDS(spe, "data/spe.rds")
```

## Session Info

<details>
   <summary>SessionInfo</summary>
   
```{r, echo = FALSE}
sessionInfo()
```
</details>