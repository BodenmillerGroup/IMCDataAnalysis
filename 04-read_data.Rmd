# Read in the data {#read-data}

This section describes how to read in single-cell data and images into `R`
*after* image processing and segmentation (see Section \@ref(processing)).

To highlight examples for IMC data analyses, we provide already processed data at: TODO
This data has already been downloaded in Section \@ref(download-data) and can 
be accessed in the folder `data`.

We use the [imcRtools](https://github.com/BodenmillerGroup/imcRtools) package to
read in single-cell data extracted using the `steinbock` framework or the IMC
Segmentation Pipeline. Both image processing approaches also generate
multi-channel images and segmentation masks that can be read into `R` using the
[cytomapper](https://github.com/BodenmillerGroup/cytomapper) package.

```{r, message=FALSE}
library(imcRtools)
library(cytomapper)
```

## Read in single-cell information

For single-cell data analysis in `R` the
[SingleCellExperiment](https://bioconductor.org/packages/release/bioc/html/SingleCellExperiment.html)
[@Amezquita2019] data container is commonly used within the Bioconductor
framework. It allows standardized access to (i) expression data, (ii) cellular
metadata (e.g. cell type), (iii) feature metadata (e.g. marker name) and (iv)
experiment-wide metadata. For an in-depth introduction to the `SingleCellExperiment`
container, please refer to the [SingleCellExperiment class](https://bioconductor.org/books/3.14/OSCA.intro/the-singlecellexperiment-class.html).

The [SpatialExperiment](https://bioconductor.org/packages/release/bioc/html/SingleCellExperiment.html)
class [@Righelli2021] is an extension of the `SingleCellExperiment` class. It
was developed to store spatial data in addition to single-cell data and an
extended introduction is accessible
[here](https://bioconductor.org/packages/release/bioc/vignettes/SpatialExperiment/inst/doc/SpatialExperiment.html).

To read in single-cell data generated by the `steinbock` framework or the IMC
Segmentation Pipeline, the `imcRtools` package provides the `read_steinbock` and
`read_cpout` function, respectively. By default, the data is read into a
`SpatialExperiment` object; however, data can be read in as a
`SingleCellExperiment` object by setting `return_as = "sce"`. All functions
presented in this book are applicable to both data containers.

### steinbock generated data

The [steinbock]() framework was used to process and segment IMC raw data available [here]().
In Section \@ref(download-data), the processed data was downloaded from [here]() and
moved to the `data/steinbock` folder. 

The `read_steinbock` function provided by `imcRtools` can now be used to read in
`steinbock` generated data. For more information, please refer to
`?read_steinbock`.

```{r read-steinbock}
spe <- read_steinbock("data/steinbock/")
spe
```

By default, single-cell data is read in as `SpatialExperiment` object. 
The summarized pixel intensities per channel and cell (here mean intensity) are
stored in the `counts` slot. Columns represent cells and rows represent channels.

```{r counts}
counts(spe)[1:5,1:5]
```

Metadata associated to individual cells are stored in the `colData` slot. After
initial image processing, these metadata include the numeric identifier (`ObjectNumber`),
the area, and morphological features of each cell. In addition, `sample_id` stores
the image name from which each cell was extracted and the width and height of the
corresponding images are stored.

```{r colData}
head(colData(spe))
```

The main difference between the `SpatialExperiment` and the
`SingleCellExperiment` data container in the current setting is the way spatial
locations of all cells are stored. For the `SingleCellExperiment` container, the
locations are stored in the `colData` slot while the `SpatialExperiment`
container stores them in the `spatialCoords` slot:

```{r spatialCoords}
head(spatialCoords(spe))
```

The _spatial object graphs_ generated by steinbock (see Section
\@ref{feature-extraction}) are read into a `colPair` slot of the
`SpatialExperiment` (or `SingleCellExperiment`) object. Cell-cell interactions
(cells in close spatial proximity) are represented as "edge list" (stored as
`SelfHits` object). Here, the left side represents the column indeces of the
"from" cells and the right side represents the column indicies of the "to"
cells. For visualization of the _spatial object graphs_, please refer to
Section \@ref{spatial-viz}.

```{r colPair}
colPair(spe, "neighborhood")
```

Finally, metadata regarding the channels are stored in the `rowData` slot. This
information is extracted from the `panel.csv` file. Channels are ordered by
isotope mass and therefore match the channel order of the multi-channel images
(see Section \@ref{read-images}).

```{r rowData}
head(rowData(spe))
```

### IMC Segmentation Pipeline generated data

**This section is under development**

## Single-cell processing

After reading in the single-cell data, few further processing steps need to be
taken.

**Add additional metadata**

We can set the `colnames` of the object to generate unique identifiers per cell:

```{r set-colnames}
colnames(spe) <- paste0(spe$sample_id, "_", spe$ObjectNumber)
```

It is also often the case that sample-specific metadata are available externally.
For the current data, we need to link the cancer type (also referred to as "Indication")
to each sample. This metadata is availabel as external excel file:

```{r add-indication}
library(openxlsx)
library(stringr)
meta <- read.xlsx("data/sample_metadata.xlsx")

spe$patient_id <- str_extract_all(spe$sample_id, "[0-9]+", simplify = TRUE)[,2]
spe$indication <- meta$Indication[match(spe$patient_id, meta$Sample.ID)]
```

**Transform counts**

The distribution of expression counts across cells is often observed to be
skewed towards the right side meaning lots of cells display low counts and few
cells have high counts. To avoid analysis biases from these high-expressing
cells, the expression counts are commonly transformed or clipped.

Here, we perform counts transformation using an inverse hyperbolic sine
function. This transformation is commonly applied to [flow cytometry
data](https://support.cytobank.org/hc/en-us/articles/206148057-About-the-Arcsinh-transform).
The `cofactor` here defines the expression range on which no scaling is
performed. While the `cofactor` for CyTOF data is often set to `5`, IMC data
usually display much lower counts. We therefore apply a `cofactor` of `1`.

However, other transformations such as `log(counts(spe) + 0.01)` should be
tested when analysing IMC data.

```{r transform-counts, message=FALSE}
library(dittoSeq)
dittoRidgePlot(spe, var = "CD3", group.by = "patient_id", assay = "counts")
assay(spe, "exprs") <- asinh(counts(spe)/1)
dittoRidgePlot(spe, var = "CD3", group.by = "patient_id", assay = "exprs")
```

**Define interesting channels**

For downstream analysis such as visualization, dimensionality reduction and
clustering, only a subset of markers should be used. As convenience,
we can store an additional entry in the `rowData` slot that specifies the 
markers of interest. Here, we deselect the nuclear markers and keep all other
biological targets.

```{r select-features}
rowData(spe)$use_channel <- !grepl("DNA|Histone", rownames(spe))
```

## Read in images {#read-images}

The `cytomapper` package allows multi-channel image handling and visualization
within the Bioconductor framework. The most common data format for multi-channel
images or segmentation masks is the TIFF file format, which is used by `steinbock`
to save images. 

Here, we will read in multi-channel images and segmentation masks into a
[CytoImageList](https://www.bioconductor.org/packages/release/bioc/vignettes/cytomapper/inst/doc/cytomapper.html#5_The_CytoImageList_object)
data container. It allows storing multiple multi-channel images and requires
matched channels across all images within the object.

The `loadImages` function is used to read in processed multi-channel images and
their corresponding segmentation masks as generated by `steinbock`. The
multi-channel images are saved as 32-bit images while the segmentation masks are
saved as 16-bit images. To correctly scale pixel values of the segmentation
masks when readin them in set `as.is = TRUE`.

```{r read-images}
images <- loadImages("data/steinbock/img/")
masks <- loadImages("data/steinbock/masks_deepcell/", as.is = TRUE)
```

In the case of multi-channel images, it is beneficial to set the `channelNames`
for easy visualization. Using the `steinbock` framework, the channel order of the
single-cell data matches the channel order of the multi-channel images. However,
it is recommended to make sure that the channel order is known.

```{r set-channelNames}
channelNames(images) <- rownames(spe)
images
```

For visualization shown in Section \@ref(image-visualization) we will need to
add additional metadata to the `elementMetadata` slot of the `CytoImageList`
objects. This slot is easily accessible using the `mcols` function.

Here, we will save the matched `sample_id`, `patient_id` and `indication`
information within the `elementMetadata` slot of the multi-channel images and
segmentation masks objects. It is crucial that the order of the images in 
both `CytoImageList` objects is the same.

```{r add-metadata}
all.equal(names(images), names(masks))
patient_id <- str_extract_all(names(images), "[0-9]+", simplify = TRUE)[,2]
indication <- meta$Indication[match(patient_id, meta$Sample.ID)] 

mcols(images) <- mcols(masks) <- DataFrame(sample_id = names(images),
                                           patient_id = patient_id,
                                           indication = indication)
```

## Save objects

Finally, the generated data objects can be saved for further downstream 
processing and analysis.

```{r save-objects-read-data}
saveRDS(spe, "data/spe.rds")
saveRDS(images, "data/images.rds")
saveRDS(masks, "data/masks.rds")
```

```{r integration-test-read-single-cell, include = FALSE}
library(testthat)
expect_equal(names(colData(spe)), c("sample_id", "ObjectNumber", "area", "major_axis_length", "minor_axis_length", 
"eccentricity", "width_px", "height_px", "patient_id", "indication"))
expect_equal(colData(spe)[1:5, ], new("DFrame", rownames = c("IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_1", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_2", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_3", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_4", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_5"
), nrows = 5L, listData = list(sample_id = c("IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005"
), ObjectNumber = c(1, 2, 3, 4, 5), area = c(17, 43, 74, 75, 
81), major_axis_length = c(5.99503935642884, 8.33748234884938, 
16.6045165534255, 12.0832233631806, 14.168552066086), minor_axis_length = c(4.34386828715882, 
6.75225385782443, 6.30935228860088, 8.3830716884245, 8.33980763911577
), eccentricity = c(0.689193741008381, 0.586613199576988, 0.924995491948203, 
0.720189151539309, 0.808414248873576), width_px = c(600, 600, 
600, 600, 600), height_px = c(600, 600, 600, 600, 600), patient_id = c("10043241", 
"10043241", "10043241", "10043241", "10043241"), indication = c("CRC", 
"CRC", "CRC", "CRC", "CRC")), elementType = "ANY", elementMetadata = NULL, 
    metadata = list()))
expect_equal(names(rowData(spe)), c("channel", "name", "keep", "ilastik", "deepcell", "Tube.Number", 
"Target", "Antibody.Clone", "Stock.Concentration", "Final.Concentration...Dilution", 
"uL.to.add", "tumorMask", "use_channel"))
expect_equal(rowData(spe)[1:5,], new("DFrame", rownames = c("MPO", "HistoneH3", "SMA", "CD16", 
"CD38"), nrows = 5L, listData = list(channel = c("Y89", "In113", 
"In115", "Pr141", "Nd142"), name = c("MPO", "HistoneH3", "SMA", 
"CD16", "CD38"), keep = c(1, 1, 1, 1, 1), ilastik = c(NA, 1, 
NA, NA, NA), deepcell = c(NA, 1, NA, NA, NA), Tube.Number = c(2101, 
2113, 1914, 2079, 2095), Target = c("Myeloperoxidase MPO", "Histone H3", 
"SMA", "CD16", "CD38"), Antibody.Clone = c("Polyclonal MPO", 
"D1H2", "1A4", "EPR16784", "EPR4106"), Stock.Concentration = c(500, 
500, 500, 500, 500), Final.Concentration...Dilution = c("4 ug/mL", 
"1 ug/mL", "0.25 ug/mL", "5 ug/mL", "2.5 ug/mL"), uL.to.add = c("0.8", 
"0.2", "0.05", "1", "0.5"), tumorMask = c(0, 1, 1, 0, 0), use_channel = c(TRUE, 
FALSE, TRUE, TRUE, TRUE)), elementType = "ANY", elementMetadata = NULL, 
    metadata = list()))
expect_equal(rownames(spe), c("MPO", "HistoneH3", "SMA", "CD16", "CD38", "HLADR", "CD27", 
"CD15", "CD45RA", "CD163", "B2M", "CD20", "CD68", "Ido1", "CD3", 
"LAG3 / LAG33", "CD11c", "PD1", "PDGFRb", "CD7", "GrzB", "PDL1", 
"TCF7", "CD45RO", "FOXP3", "ICOS", "CD8a", "CarbonicAnhydrase", 
"CD33", "Ki67", "VISTA", "CD40", "CD4", "CD14", "Ecad", "CD303", 
"CD206", "cleavedPARP", "DNA1", "DNA2"))
expect_equal(colnames(spe)[100:150], c("IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_100", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_101", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_102", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_103", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_104", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_105", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_106", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_107", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_108", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_109", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_110", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_111", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_112", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_113", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_114", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_115", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_116", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_117", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_118", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_119", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_120", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_121", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_122", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_123", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_124", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_125", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_126", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_127", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_128", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_129", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_130", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_131", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_132", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_133", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_134", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_135", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_136", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_137", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_138", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_139", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_140", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_141", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_142", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_143", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_144", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_145", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_146", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_147", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_148", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_149", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005_150"
))
expect_equal(assayNames(spe), c("counts", "exprs"))
expect_equal(as.vector(counts(spe)[1:5, 1:5]), c(0.294117647058824, 38.610343652613, 3.37972688674927, 0.83533733031329, 
0.661199078840368, 0.794980839241383, 14.2380151970442, 1.24058909055799, 
1.52552111273588, 1.4580024563989, 0.187595377097259, 17.1533746799907, 
2.00441972951631, 0.422267678621653, 0.611109371120865, 0.214944005012512, 
9.71690032164256, 1.32428938945134, 0.200534693400065, 0.777516609032949, 
0.36745822282485, 9.7725715526828, 1.57636853132719, 0.157719498799171, 
0.359395637924289))
expect_equal(as.vector(assay(spe, "exprs")[1:5, 1:5]), c(0.29003423688408, 4.34683504908904, 1.93214313608063, 0.760024891807258, 
0.620590070346709, 0.728744150307818, 3.35029364112523, 1.04170054183177, 
1.2088369158893, 1.17123910917697, 0.186512135356337, 3.53619067989927, 
1.44561029293216, 0.410630119754741, 0.578327732206083, 0.213322395761263, 
2.96965119238793, 1.0931741196413, 0.199214393387259, 0.715015255287847, 
0.35965430089227, 2.97533431637183, 1.23639178259819, 0.157072821505816, 
0.352076638841486))
expect_equal(colPairNames(spe), "neighborhood")
expect_equal(colPair(spe)[1:5,], new("SelfHits", from = c(1L, 1L, 2L, 2L, 2L), to = c(2L, 50L, 
1L, 3L, 50L), nLnode = 42436L, nRnode = 42436L, elementMetadata = NULL, 
    metadata = list()))
expect_equal(spatialCoords(spe)[1:5,], structure(c(2, 7.44186046511628, 17.8783783783784, 30.7333333333333, 
39.6296296296296, 1.52941176470588, 2.51162790697674, 2.14864864864865, 
3.89333333333333, 3.1358024691358), .Dim = c(5L, 2L), .Dimnames = list(
    c("1", "2", "3", "4", "5"), c("Pos_X", "Pos_Y"))))
```

```{r integration-test-read-images, include = FALSE}
expect_equal(names(images)[1:5], c("IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_006", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_007", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_008", 
"IMMUcan_WFLOW_Batch20210304_10062168-SPECT-VAR-TIS-01-IMC-01_001"
))
expect_s4_class(images, "CytoImageList")
expect_equal(mcols(images), new("DFrame", rownames = c("IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_006", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_007", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_008", 
"IMMUcan_WFLOW_Batch20210304_10062168-SPECT-VAR-TIS-01-IMC-01_001", 
"IMMUcan_WFLOW_Batch20210304_10062168-SPECT-VAR-TIS-01-IMC-01_002", 
"IMMUcan_WFLOW_Batch20210304_10062168-SPECT-VAR-TIS-01-IMC-01_003", 
"IMMUcan_WFLOW_Batch20210304_10066654-SPECT-VAR-TIS-01-IMC-01_001", 
"IMMUcan_WFLOW_Batch20210304_10066654-SPECT-VAR-TIS-01-IMC-01_002", 
"IMMUcan_WFLOW_Batch20210304_10066654-SPECT-VAR-TIS-01-IMC-01_003", 
"IMMUcan_WFLOW_Batch20210304_10066654-SPECT-VAR-TIS-01-IMC-01_004", 
"IMMUcan_WFLOW_Batch20210304_10069606-SPECT-VAR-TIS-01-IMC-01_001", 
"IMMUcan_WFLOW_Batch20210304_10069606-SPECT-VAR-TIS-01-IMC-01_002", 
"IMMUcan_WFLOW_Batch20210304_10069606-SPECT-VAR-TIS-01-IMC-01_003"
), nrows = 14L, listData = list(sample_id = c("IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_006", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_007", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_008", 
"IMMUcan_WFLOW_Batch20210304_10062168-SPECT-VAR-TIS-01-IMC-01_001", 
"IMMUcan_WFLOW_Batch20210304_10062168-SPECT-VAR-TIS-01-IMC-01_002", 
"IMMUcan_WFLOW_Batch20210304_10062168-SPECT-VAR-TIS-01-IMC-01_003", 
"IMMUcan_WFLOW_Batch20210304_10066654-SPECT-VAR-TIS-01-IMC-01_001", 
"IMMUcan_WFLOW_Batch20210304_10066654-SPECT-VAR-TIS-01-IMC-01_002", 
"IMMUcan_WFLOW_Batch20210304_10066654-SPECT-VAR-TIS-01-IMC-01_003", 
"IMMUcan_WFLOW_Batch20210304_10066654-SPECT-VAR-TIS-01-IMC-01_004", 
"IMMUcan_WFLOW_Batch20210304_10069606-SPECT-VAR-TIS-01-IMC-01_001", 
"IMMUcan_WFLOW_Batch20210304_10069606-SPECT-VAR-TIS-01-IMC-01_002", 
"IMMUcan_WFLOW_Batch20210304_10069606-SPECT-VAR-TIS-01-IMC-01_003"
), patient_id = c("10043241", "10043241", "10043241", "10043241", 
"10062168", "10062168", "10062168", "10066654", "10066654", "10066654", 
"10066654", "10069606", "10069606", "10069606"), indication = c("CRC", 
"CRC", "CRC", "CRC", "NSCLC", "NSCLC", "NSCLC", "BCC", "BCC", 
"BCC", "BCC", "SCCHN", "SCCHN", "SCCHN")), elementType = "ANY", 
    elementMetadata = NULL, metadata = list()))
expect_equal(as.array(images$`IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005`)[1:5,1:5,1:2],
             structure(c(0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 
0, 0, 1, 0, 1, 0, 0, 1, 61.1953201293945, 111.080352783203, 82.0671005249023, 
46.5202293395996, 17.5367813110352, 38.0119972229004, 21.508228302002, 
44.4682121276855, 27.0475578308105, 24.2778911590576, 53.9485282897949, 
43.3793754577637, 25.9022426605225, 20.3622779846191, 9.16940975189209, 
47.6674461364746, 26.7042827606201, 22.304536819458, 19.7645721435547, 
12.3959255218506, 46.8647727966309, 27.3318157196045, 18.4485740661621, 
8.25570583343506, 13.0228233337402), .Dim = c(5L, 5L, 2L), .Dimnames = list(
    NULL, NULL, c("MPO", "HistoneH3"))))
```

```{r integration-test-read-masks, include = FALSE}
expect_equal(names(masks)[1:5], c("IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_006", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_007", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_008", 
"IMMUcan_WFLOW_Batch20210304_10062168-SPECT-VAR-TIS-01-IMC-01_001"
))
expect_s4_class(masks, "CytoImageList")
expect_equal(mcols(masks), new("DFrame", rownames = c("IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_006", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_007", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_008", 
"IMMUcan_WFLOW_Batch20210304_10062168-SPECT-VAR-TIS-01-IMC-01_001", 
"IMMUcan_WFLOW_Batch20210304_10062168-SPECT-VAR-TIS-01-IMC-01_002", 
"IMMUcan_WFLOW_Batch20210304_10062168-SPECT-VAR-TIS-01-IMC-01_003", 
"IMMUcan_WFLOW_Batch20210304_10066654-SPECT-VAR-TIS-01-IMC-01_001", 
"IMMUcan_WFLOW_Batch20210304_10066654-SPECT-VAR-TIS-01-IMC-01_002", 
"IMMUcan_WFLOW_Batch20210304_10066654-SPECT-VAR-TIS-01-IMC-01_003", 
"IMMUcan_WFLOW_Batch20210304_10066654-SPECT-VAR-TIS-01-IMC-01_004", 
"IMMUcan_WFLOW_Batch20210304_10069606-SPECT-VAR-TIS-01-IMC-01_001", 
"IMMUcan_WFLOW_Batch20210304_10069606-SPECT-VAR-TIS-01-IMC-01_002", 
"IMMUcan_WFLOW_Batch20210304_10069606-SPECT-VAR-TIS-01-IMC-01_003"
), nrows = 14L, listData = list(sample_id = c("IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_006", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_007", 
"IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_008", 
"IMMUcan_WFLOW_Batch20210304_10062168-SPECT-VAR-TIS-01-IMC-01_001", 
"IMMUcan_WFLOW_Batch20210304_10062168-SPECT-VAR-TIS-01-IMC-01_002", 
"IMMUcan_WFLOW_Batch20210304_10062168-SPECT-VAR-TIS-01-IMC-01_003", 
"IMMUcan_WFLOW_Batch20210304_10066654-SPECT-VAR-TIS-01-IMC-01_001", 
"IMMUcan_WFLOW_Batch20210304_10066654-SPECT-VAR-TIS-01-IMC-01_002", 
"IMMUcan_WFLOW_Batch20210304_10066654-SPECT-VAR-TIS-01-IMC-01_003", 
"IMMUcan_WFLOW_Batch20210304_10066654-SPECT-VAR-TIS-01-IMC-01_004", 
"IMMUcan_WFLOW_Batch20210304_10069606-SPECT-VAR-TIS-01-IMC-01_001", 
"IMMUcan_WFLOW_Batch20210304_10069606-SPECT-VAR-TIS-01-IMC-01_002", 
"IMMUcan_WFLOW_Batch20210304_10069606-SPECT-VAR-TIS-01-IMC-01_003"
), patient_id = c("10043241", "10043241", "10043241", "10043241", 
"10062168", "10062168", "10062168", "10066654", "10066654", "10066654", 
"10066654", "10069606", "10069606", "10069606"), indication = c("CRC", 
"CRC", "CRC", "CRC", "NSCLC", "NSCLC", "NSCLC", "BCC", "BCC", 
"BCC", "BCC", "SCCHN", "SCCHN", "SCCHN")), elementType = "ANY", 
    elementMetadata = NULL, metadata = list()))
expect_equal(as.array(masks$`IMMUcan_WFLOW_Batch20210304_10043241-GI-VAR-TIS-UNST-03_005`)[1:5,1:5],
             structure(c(0L, 11L, 11L, 11L, 11L, 11L, 11L, 11L, 11L, 11L, 
11L, 11L, 11L, 11L, 11L, 11L, 11L, 11L, 11L, 11L, 11L, 11L, 11L, 
11L, 11L), .Dim = c(5L, 5L)))
```

## Session Info

<details>
   <summary>SessionInfo</summary>
   
```{r, echo = FALSE}
sessionInfo()
```
</details>

