---
title: "Spatial analysis"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

This script highlights the usability of imcRtools to perform spatial data
analysis.

For this, we will use a publicly available dataset provided by the 
[imcdatasets](https://bioconductor.org/packages/release/data/experiment/html/imcdatasets.html) 
R/Bioconductor package:

```{r load-libraries, message=FALSE, warning=FALSE}
library(imcdatasets)
library(imcRtools)
```

Here, we will read in the `SingleCellExperiment` object provided in the 

```{r read-data}
sce <- DamondPancreas2019_sce()
```

## Build spatial graph

The `SingleCellExperiment` object does not contain an interaction graph.
For this, we will build one from scratch.
For simplicity, we will build a graph based on the 10 nearest neighbors in 
2 dimensions.

```{r build-graph}
sce <- buildSpatialGraph(sce, img_id = "ImageNumber", 
                         type = "knn", k = 10)
```

## Aggregate neighors and spatial clustering

Here, we will aggregate the celltype information of each cells neighborhood.

```{r aggregate-neighbors}
sce <- aggregateNeighbors(sce, colPairName = "knn_interaction_graph",
                          aggregate_by = "metadata", count_by = "CellType",
                          proportions = TRUE)
sce$aggregatedNeighbors
```

We can now use this information to cluster across all cells. 

```{r cluster-cells, message=FALSE}
library(ggplot2)
library(pheatmap)

set.seed(123)
cur_res <- kmeans(sce$aggregatedNeighbors, centers = 10)
sce$clustered_neighborhood <- as.character(cur_res$cluster)

# Color clusters by similar cell-types
pheatmap(proportions(x = table(sce$clustered_neighborhood, sce$CellType), 
                     margin = 2))
```

And visualize the patches on the tissue.

```{r visualize-patches, , fig.width=13, fig.height=10}
col_vector <- unique(sce$clustered_neighborhood)
names(col_vector) <- col_vector

col_vector["1"] <- "dark red"
col_vector["2"] <- "dodgerblue"
col_vector["3"] <- "darkolivegreen1"
col_vector["4"] <- "coral"
col_vector["5"] <- "brown2"
col_vector["6"] <- "darkolivegreen4"
col_vector["7"] <- "darkseagreen3"
col_vector["8"] <- "forestgreen"
col_vector["9"] <- "greenyellow"
col_vector["10"] <- "light blue"

cur_images <- sce[,sce$ImageFullName %in% c("G11_a0_full_clean.tiff",
                                            "G07_a0_full_clean.tiff",
                                            "G09_a0_full_clean.tiff")]

plotSpatial(cur_images, img_id = "ImageFullName", 
            node_color_by = "clustered_neighborhood", node_size_fix = 0.7)  +
  theme(text = element_text(size=20)) + 
  scale_color_manual(values = col_vector, name = "clust")
```

## Patch detection

As an alternative way of detecting tissue areas which contain cells of similar
types, the `patchDetection` function can be used.

Here, as a demonstration, we can apply this function to detect islet cells and
clusters of immune cells. 

First, we will detect all islets.

```{r patch-detection-islet, fig.width=10, fig.height=10}
cur_images <- patchDetection(cur_images, 
                      patch_cells = cur_images$CellType %in% c("alpha", "beta", "gamma", "delta"), 
                      colPairName = "knn_interaction_graph", 
                      name = "islets", 
                      min_patch_size = 5,
                      expand_by = 10,
                      img_id = "ImageNumber")

plotSpatial(cur_images, img_id = "ImageFullName", 
            node_color_by = "islets", node_size_fix = 0.7)  +
  theme(text = element_text(size=20),
        legend.position = "none") 
```

Next, we will detect aggregations of immune cells.

```{r patch-detection-immune, fig.width=10, fig.height=10}
cur_images <- patchDetection(cur_images, 
                      patch_cells = cur_images$CellType %in% c("otherimmune", "Tc", 
                                      "neutrophil", "Th", "macrophage", "naiveTc", "B"), 
                      colPairName = "knn_interaction_graph", 
                      name = "immune",
                      img_id = "ImageNumber",
                      min_patch_size = 4)

plotSpatial(cur_images, img_id = "ImageFullName", 
            node_color_by = "immune", node_size_fix = 0.7)  +
  theme(text = element_text(size=20),
        legend.position = "none")
```

## Spatial interaction testing

Finally, we will test if certain cell-types interact more or less frequently 
compared to what would be expected from a random distribution. For this, the 
`testInteractions` function can be used.

```{r test-interactions, message=FALSE, fig.width=15, fig.height=5}
library(BiocParallel)
library(tidyverse)
library(viridis)
cur_out <- testInteractions(sce, group_by = "ImageFullName",
                            colPairName = "knn_interaction_graph", 
                            label = "CellType", method = "classic", 
                            BPPARAM = MulticoreParam(RNGseed = 123))

cur_df <- cur_out %>% as_tibble() %>%
  filter(group_by %in% c("G11_a0_full_clean.tiff",
                         "G07_a0_full_clean.tiff",
                         "G09_a0_full_clean.tiff"))


ggplot(cur_df) +
    geom_tile(aes(from_label, to_label, fill = ct)) +
    geom_text(aes(from_label, to_label, label = ifelse(sigval == 1 | sigval == -1, "*", ""), 
                  color = as.character(sigval)), size = 5) +
    facet_wrap(~ group_by) + 
    scale_fill_gradientn(colours = viridis(100), name = "count") +
    scale_colour_manual(values = c("1" = "green", "-1" = "red", "0" = "black"), 
                        labels = c("interaction", "avoidance", "none"), name = "sig")  +
    theme(panel.background = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1),
          text = element_text(size=18))
```
