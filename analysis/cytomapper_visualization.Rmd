---
title: "cytomapper_visualization"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Visualization of segmentation results 

Here, we will highlight the use of cytomapper to visualize mutlichannel 
images and outline segmented cells on composite images.

For this, we will use a publicly available dataset provided by the 
[imcdatasets](https://bioconductor.org/packages/release/data/experiment/html/imcdatasets.html) 
R/Bioconductor package:

```{r load-libraries, message=FALSE, warning=FALSE}
library(cytomapper)
library(imcdatasets)
```

Next, we will read in the multichannel images and segmentation masks:

```{r read-data}
masks <- DamondPancreas2019_masks()
images <- DamondPancreas2019_images()
```

We can now visualize example images in form of composites.

```{r composites}
# Select the 3 largest images
cur_size <- unlist(lapply(images, function(x){dim(x)[1] * dim(x)[2]}))
cur_images <- images[order(cur_size, decreasing = TRUE)[1:3]]
plotPixels(cur_images, 
           colour_by = c("H3", "CDH", "CD99"), 
           bcg = list(H3 = c(0, 10, 1),
                      CDH = c(0, 5, 1),
                      CD99 = c(0, 5, 1)),
           colour = list(H3 = c("black", "blue"),
                        CDH = c("black", "green"),
                        CD99 = c("black", "red")),
           image_title = NULL,
           scale_bar = list(frame = 3))

plotPixels(cur_images, 
           colour_by = c("H3", "CDH", "CD99"), 
           bcg = list(H3 = c(0, 10, 1),
                      CDH = c(0, 5, 1),
                      CD99 = c(0, 5, 1)),
           colour = list(H3 = c("black", "blue"),
                        CDH = c("black", "green"),
                        CD99 = c("black", "red")),
           image_title = NULL,
           scale_bar = list(frame = 3),
           save_plot = list(filename = "~/switchdrive/Institution/IMCWorkflow/biorxiv_submission/Figures/Figure_3/composite.png",
                            scale = 2))
```

And outline the segmented cells:

```{r composites-masks}
cur_masks <- masks[order(cur_size, decreasing = TRUE)[1:3]]
plotPixels(cur_images, 
           mask = cur_masks,
           img_id = "ImageName",
           colour_by = c("H3", "CDH", "CD99"), 
           bcg = list(H3 = c(0, 10, 1),
                      CDH = c(0, 5, 1),
                      CD99 = c(0, 5, 1)),
           colour = list(H3 = c("black", "blue"),
                        CDH = c("black", "green"),
                        CD99 = c("black", "red")),
           image_title = NULL,
           legend = NULL,
           scale_bar = list(frame = 3))

plotPixels(cur_images, 
           mask = cur_masks,
           img_id = "ImageName",
           colour_by = c("H3", "CDH", "CD99"), 
           bcg = list(H3 = c(0, 10, 1),
                      CDH = c(0, 5, 1),
                      CD99 = c(0, 5, 1)),
           colour = list(H3 = c("black", "blue"),
                        CDH = c("black", "green"),
                        CD99 = c("black", "red")),
           image_title = NULL,
           legend = NULL,
           scale_bar = list(frame = 3),
           save_plot = list(filename = "~/switchdrive/Institution/IMCWorkflow/biorxiv_submission/Figures/Figure_3/composite_masks.png",
                            scale = 2))
```

