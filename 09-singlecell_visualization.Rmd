# Single cell visualization {#single-cell-visualization}

The following section describes typical approaches on how to visualize single-cell data. 

This chapter is divided into three parts. Section \@ref(cell-type-level) will highlight 
visualization approaches downstream of our cell type classification from Section \@ref(classification). 
We will then focus on visualization methods that relate single-cell data to the 
sample level in Section \@ref(sample-level). Lastly, Section \@ref(cell-type-level) 
will provide a more customized example on how to integrate various single-cell and 
sample metadata into one heatmap using the [ComplexHeatmap](https://bioconductor.org/packages/release/bioc/html/ComplexHeatmap.html) package. 

Visualization functions from popular R packages in single-cell research such as [scater](https://bioconductor.org/packages/release/bioc/html/scater.html), [DittoSeq](https://bioconductor.org/packages/release/bioc/html/dittoSeq.html) and [CATALYST](https://bioconductor.org/packages/release/bioc/html/CATALYST.html) will be utilized. 
We will recycle methods and functions that we have seen in previous sections, 
while also introducing new ones.

Please note that this chapter aims to provide an overview on **common** 
visualization options and should be seen as a stepping-stone.
However, many more options exist and the user should customize the 
visualization according to the biological question at hand.  

## Load data

First, we will read in the previously generated `SpatialExperiment` object. 

```{r read-data-batch-correction, message=FALSE}
spe <- readRDS("data/spe.rds")
```

For visualization purposes, we will define markers that were used for cell type classification and markers that can indicate a specific cell state (e.g. Ki67).

```{r}
# Define cell_type_markers 
type_markers <- c("Ecad", "CD45RO", "CD20", "CD3", "FOXP3", "CD206", "MPO", "SMA","CD8a","CD4","HLADR","CD15","CD38","PDGFRb")

# Define cell_state_markers 
state_markers <- c("CarbonicAnhydrase","Ki67","PD1","GrzB","PDL1","ICOS","TCF7","VISTA")

# Add to spe
rowData(spe)$type_markers <- rownames(spe) %in% type_markers
rowData(spe)$state_markers <- rownames(spe) %in% state_markers
```

## Cell-type level {#cell-type-level}

In the first section of this chapter, the grouping-level for the visualization 
approaches will be the cell type classification from Section \@ref(classification). 
Other grouping levels (e.g. cluster assignments from Section \@ref(clustering)) 
are possible and the user should adjust depending on the chosen analysis workflow. 

### Dimensionality reduction visualization 

As seen before, we can visualize single-cells in low-dimensional space. Often 
used non-linear methods for dimensionality reduction are tSNE and UMAP, which 
aim to preserve the distances between each cell and its neighbors in the 
high-dimensional space. 

Interpreting these plots is not trivial, but local neighborhoods in the plot can 
suggest similarity in expression for given cells. See [Orchestrating Single-Cell Analysis with Bioconductor](https://bioconductor.org/books/release/OSCA/) for more details.

Here, we will use `dittoDimPlot` from [DittoSeq](https://bioconductor.org/packages/release/bioc/html/dittoSeq.html) and
`plotReducedDim` from [scater](https://bioconductor.org/packages/release/bioc/html/scater.html)
to visualize the fastMNN-corrected UMAP colored by cell type and expression, 
respectively. 

Both functions are highly flexible and return `ggplot` objects which
can be further modified.

```{r umap}
library(patchwork)
library(cowplot)
library(scater)
library(ggplot2)
library(viridis)
library(dittoSeq)

## UMAP colored by cell type and expression - dittoDimPlot+
p1 <- dittoDimPlot(spe, var = "celltype", 
             reduction.use = "UMAP_mnnCorrected", size = 0.2,
             do.label = TRUE) +
  scale_color_manual(values = metadata(spe)$color_vectors$celltype)+
  theme(legend.title = element_blank()) +
  ggtitle("Classification cell labels on UMAP, integrated cells")


p2 <- dittoDimPlot(spe, var = "Ecad", assay = "exprs",
             reduction.use = "UMAP_mnnCorrected", size = 0.2, colors = viridis(100),
             do.label = TRUE)+
    scale_color_viridis()
  
p1+p2

# UMAP colored by expression for all markers - plotReducedDim
plot_list  <- lapply(rownames(spe)[rowData(spe)$type_markers == TRUE], function(x){
                      p <- plotReducedDim(spe, dimred = "UMAP_mnnCorrected",
                                          colour_by = x,
                                          by_exprs_values = "exprs",
                                          point_size = 0.5)
                      return(p)
                    })

plot_grid(plotlist = plot_list)
```

### Heatmap visualization 

Next, it is often useful to visualize single-cell expression per cell type in form of a
heatmap. 


Here, 


Furthermore, we sub-sample the dataset to 2000 cells for ease of visualization
and overlay the cancer type and patient ID from which the cells were extracted.

```{r celltype heatmap, message=FALSE}
library(dittoSeq)
library(viridis)
cur_cells <- sample(seq_len(ncol(spe)), 4000)

#Heatmap visualization - DittoHeatmap
dittoHeatmap(spe[,cur_cells], genes = rownames(spe)[rowData(spe)$type_markers == TRUE],
             assay = "exprs", order.by = c("celltype"),
             cluster_cols = FALSE, scale = "none",
             heatmap.colors = viridis(100), annot.by = c("celltype","indication","patient_id"),
             annotation_colors = list(indication = metadata(spe)$color_vectors$indication,
                                      patient_id = metadata(spe)$color_vectors$patient_id,
                                      celltype = metadata(spe)$color_vectors$celltype)
             )
```

```{r celltype mean-expression-per-cluster, message=FALSE, fig.height=7}
library(scuttle)
## by cell type
celltype_mean <- aggregateAcrossCells(as(spe, "SingleCellExperiment"),  
                     ids = spe$celltype, 
                     statistics = "mean",
                     use.assay.type = "exprs", 
                     subset.row = rownames(spe)[rowData(spe)$type_markers == TRUE]
                     )

#No scaling
dittoHeatmap(celltype_mean,
             assay = "exprs", cluster_cols = TRUE, 
             scale = "none",
             heatmap.colors = viridis(100),
             annot.by = c("celltype","ncells"),
             annotation_colors = list(celltype = metadata(spe)$color_vectors$celltype,
                                      ncells = plasma(100)))

#Row-scaling
dittoHeatmap(celltype_mean,
             assay = "exprs", cluster_cols = TRUE, 
             scale = "row",
             heatmap.colors = viridis(100),
             annot.by = c("celltype","ncells"),
             annotation_colors = list(celltype = metadata(spe)$color_vectors$celltype,
                                      ncells = plasma(100)))

```

### Violin plot visualization

```{r celltype violin, message=FALSE}
#Violin Plot - plotExpression
plotExpression(spe[,cur_cells],features = rownames(spe)[rowData(spe)$type_markers == TRUE], x = "celltype", exprs_values = "exprs", colour_by = "celltype")+
    scale_color_manual(values = metadata(spe)$color_vectors$celltype)
```

### Scatter plot visualization 

```{r celltype scatter, message=FALSE}
#Scatter plot
dittoScatterPlot(spe, x.var = "CD3",y.var="CD20", assay.x = "exprs", assay.y = "exprs", color.var = "celltype")+
    scale_color_manual(values = metadata(spe)$color_vectors$celltype)+
    ggtitle("Scatterplot for CD3/CD20 labelled by celltype")
```

### Barplot visualization

```{r barplot celltype}
#by sample_id
dittoBarPlot(spe, var = "celltype", group.by = "sample_id")+
    scale_fill_manual(values = metadata(spe)$color_vectors$celltype)

#by patient_id
dittoBarPlot(spe, var = "celltype", group.by = "patient_id")+
    scale_fill_manual(values = metadata(spe)$color_vectors$celltype)
```

### CATALYST-based visualization 

```{r}
library(CATALYST)

#save spe in CATALYST-compatible object with renamed colData entries and new metadata information
spe_cat <- spe 

spe_cat$sample_id <- factor(spe$sample_id)
spe_cat$condition <- factor(spe$indication)
spe_cat$cluster_id <- factor(spe$celltype)

#add celltype information to metadata
metadata(spe_cat)$cluster_codes <- data.frame(celltype = factor(spe_cat$celltype))
```

#### Pseudobulk-level MDS plot

**pbMDS - Pseudobulk-level MDS plot**
A multi-dimensional scaling (MDS) plot on aggregated measurement values may be rendered with pbMDS. Such a plot will give a sense of similarities between cluster and/or samples in an unsupervised way and of key difference in expression before conducting any formal testing.

```{r celltype pbmds}
## pbMDS plot

# MDS pseudobulk by cell labels 
pbMDS(spe_cat, by = "cluster_id", features = rownames(spe_cat)[rowData(spe_cat)$type_markers == TRUE], label_by = "cluster_id", k="celltype")+
  scale_color_manual(values = metadata(spe_cat)$color_vectors$celltype)

# MDS pseudobulk by sample_id and cell labels
pbMDS(spe_cat, by = "both", features = rownames(spe_cat)[rowData(spe_cat)$type_markers == TRUE], k = "celltype", shape_by = "condition", size_by = TRUE)+
  scale_color_manual(values = metadata(spe_cat)$color_vectors$celltype)
```

#### Reduced dimension plot on CLR of proportions

**clrDR - Reducded dimension plot on CLR of proportions**
A dimensionality reduction plot on centered log-ratios (CLR) of sample/cluster proportions across clusters/samples can be rendered with clrDR. Here, we view each sample (cluster) as a vector of cluster (sample) proportions. Complementary to pbMDS, such a plot will give a sense of similarities between samples/clusters in terms of their composition.

For more details refer to CATALYST.

```{r celltype - clrDR}
## clrDR plot

#CLR on cluster proportions across samples
set.seed(22)

clrDR(spe_cat, dr = "PCA", by = "cluster_id", k = "celltype", arrow_col = "patient_id", point_pal = metadata(spe_cat)$color_vectors$celltype)+
  scale_color_manual(values = metadata(spe_cat)$color_vectors$patient_id)
```

#### Pseudobulk expression boxplot 

**plotPbExprs**
A combined boxplot and jitter of aggregated marker intensities can be generated via `plotPbExprs()`.

```{r celltype pbExprs}
plotPbExprs(spe_cat, k = "celltype", facet_by = "cluster_id", ncol = 4, features = rownames(spe_cat)[rowData(spe_cat)$type_markers == TRUE])+
    scale_color_manual(values = metadata(spe_cat)$color_vectors$indication)
```

## Sample-level {#sample-level}

### Dimensionality reduction visualization 

Furthermore, assessment of potential “batch effects” between samples


```{r umap}
library(patchwork)
library(cowplot)
library(scater)
library(ggplot2)
library(viridis)
library(dittoSeq)

## UMAP colored by cell type and expression - dittoDimPlot+
p1 <- dittoDimPlot(spe, var = "sample_id",
             reduction.use = "UMAP_mnnCorrected", size = 0.2, colors = viridis(100),
             do.label = TRUE)+
    scale_color_manual(values = metadata(spe)$color_vectors$sample_id)+
  theme(legend.title = element_blank()) +
  ggtitle("Sample ID")

p2 <- dittoDimPlot(spe, var = "patient_id", 
             reduction.use = "UMAP_mnnCorrected", size = 0.2,
             do.label = TRUE) +
  scale_color_manual(values = metadata(spe)$color_vectors$patient_id)+
  theme(legend.title = element_blank()) +
  ggtitle("Patient ID")

p1+p2
```

### Heatmap visualization 

```{r patient heatmap}
#Heatmap visualization - DittoHeatmap
dittoHeatmap(spe[,cur_cells], genes = rownames(spe)[rowData(spe)$type_markers == TRUE],
             assay = "exprs", order.by = c("patient_id","sample_id"),
             cluster_cols = FALSE, scale = "none",
             heatmap.colors = viridis(100), annot.by = c("celltype","indication","patient_id","sample_id"),
             annotation_colors = list(celltype = metadata(spe)$color_vectors$celltype,
                                      indication = metadata(spe)$color_vectors$indication,
                                      patient_id = metadata(spe)$color_vectors$patient_id,
                                      sample_id = metadata(spe)$color_vectors$sample_id
                                      )
             )

```

```{r celltype mean-expression-per-cluster, message=FALSE, fig.height=7}
library(scuttle)
#by patient_id
patient_mean <- aggregateAcrossCells(as(spe, "SingleCellExperiment"),  
                     ids = spe$patient_id, 
                     statistics = "mean",
                     use.assay.type = "exprs", 
                     subset.row = rownames(spe)[rowData(spe)$type_markers == TRUE]
                     )

#No scaling
dittoHeatmap(patient_mean,
             assay = "exprs", cluster_cols = TRUE, 
             scale = "none",
             heatmap.colors = viridis(100),
             annot.by = c("patient_id","ncells"),
             annotation_colors = list(patient_id = metadata(spe)$color_vectors$patient_id,
                                      ncells = plasma(100)))

#Row-scaling
dittoHeatmap(patient_mean,
             assay = "exprs", cluster_cols = TRUE, 
             scale = "row",
             heatmap.colors = viridis(100),
             annot.by = c("patient_id","ncells"),
             annotation_colors = list(patient_id = metadata(spe)$color_vectors$patient_id,
                                      ncells = plasma(100)))

```

### Barplot visualization

```{r barplot patient}
dittoBarPlot(spe, var = "patient_id", group.by = "celltype")+
    scale_fill_manual(values = metadata(spe)$color_vectors$patient_id)

dittoBarPlot(spe, var = "sample_id", group.by = "celltype")+
    scale_fill_manual(values = metadata(spe)$color_vectors$sample_id)
```

### CATALYST-based visualization 

#### Pseudobulk-level MDS plot

```{r patient-pbmds}
## pbMDS plot

# MDS pseudobulk by sample_id 
pbMDS(spe_cat, by = "sample_id", color_by = "patient_id", features = rownames(spe_cat)[rowData(spe_cat)$type_markers == TRUE])+
  scale_color_manual(values = metadata(spe_cat)$color_vectors$patient_id)
```

#### Reduced dimension plot on CLR of proportions 

```{r patient-clrDR}
## clrDR plot

#CLR on sample proportions across clusters
set.seed(22)
clrDR(spe_cat, dr = "PCA", by = "sample_id", point_col = "patient_id",k = "celltype", point_pal = metadata(spe_cat)$color_vectors$patient_id)+
  scale_color_manual(values = metadata(spe_cat)$color_vectors$celltype)

clrDR(spe_cat, dr = "PCA", by = "sample_id", point_col = "sample_id",k = "celltype", point_pal = metadata(spe_cat)$color_vectors$sample_id)+
  scale_color_manual(values = metadata(spe_cat)$color_vectors$celltype)
```

## Further examples {#rich-example}

### Publication-ready ComplexHeatmap 

Rich heatmap based on ComplexHeatmap that combines celltype and sample information. 

```{r}
library(ComplexHeatmap)
library(circlize)
library(tidyverse)

set.seed(22)

### 1. Heatmap bodies ###

# By celltype markers
celltype_mean <- aggregateAcrossCells(as(spe, "SingleCellExperiment"),  
                     ids = spe$celltype, 
                     statistics = "mean",
                     use.assay.type = "exprs", 
                     subset.row = rownames(spe)[rowData(spe)$type_markers == TRUE]
                     )

# By cellstate markers
cellstate_mean <- aggregateAcrossCells(as(spe, "SingleCellExperiment"),  
                     ids = spe$celltype, 
                     statistics = "mean",
                     use.assay.type = "exprs", 
                     subset.row = rownames(spe)[rowData(spe)$state_markers == TRUE]
                     )

# Heatmap body color 
col_exprs <- colorRamp2(c(0,1,2,3,4), c("#440154FF","#3B518BFF","#20938CFF","#6ACD5AFF","#FDE725FF"))


### 2. Heatmap annotation ###

### 2.1  Metadata features

anno <- colData(celltype_mean) %>% as.data.frame %>% select(celltype, ncells)

# Proportion of indication per celltype
indication <- colData(spe) %>% as.data.frame() %>% select(celltype,indication) %>% group_by(celltype) %>% table() %>% as.data.frame
indication <- indication %>% group_by(celltype) %>% mutate(fra = Freq/sum(Freq)) 
indication <- indication %>% select(-Freq) %>% pivot_wider(id_cols = celltype,names_from = indication,values_from = fra) %>% column_to_rownames("celltype")

# Number of contributing samples per celltype
cluster_PID <- colData(spe) %>% as.data.frame() %>% select(celltype,patient_id) %>% group_by(celltype) %>% table() %>% as.data.frame
n_PID <- cluster_PID %>% filter(Freq>0) %>% group_by(celltype) %>% count(name = "n_PID") %>% column_to_rownames("celltype")

# Create two HeatmapAnnotation objects
ha_anno <- HeatmapAnnotation(celltype = anno$celltype,
                            border = TRUE, 
                            gap = unit(1,"mm"),
                            col = list(celltype = metadata(spe)$color_vectors$celltype),
                            which = "row")
    
ha_meta <- HeatmapAnnotation(n_cells = anno_barplot(anno$ncells, width = unit(10, "mm")),
                            n_PID = anno_barplot(n_PID, width = unit(10, "mm")),
                            indication = anno_barplot(indication,width = unit(10, "mm"),gp = gpar(fill = metadata(spe)$color_vectors$indication)),
                            border = TRUE, 
                            annotation_name_rot = 90,
                            gap = unit(1,"mm"),
                            which = "row")

### 2.2 Spatial features

# Add number of neighbors to spe object (saved in ColPair)
n_neighbors <- colPair(spe) %>% as.data.frame %>% group_by(from) %>% dplyr::count() %>% arrange(desc(n))
spe$n_neighbors <- n_neighbors$n[match(seq_along(colnames(spe)),n_neighbors$from)]
spe$n_neighbors <- spe$n_neighbors %>% replace_na(0)

# Select spatial features and average over celltypes
spatial <- colData(spe) %>% as.data.frame %>% select(area,celltype,n_neighbors)
spatial <- spatial %>% select(-celltype) %>% aggregate(by = list(celltype = spatial$celltype), FUN = mean) %>% column_to_rownames("celltype")

# Create HeatmapAnnotation object
ha_spatial <- HeatmapAnnotation(
    area = spatial$area,
    n_neighbors = spatial$n_neighbors,
    border = TRUE,
    gap = unit(1,"mm"),
    which = "row")


### 3. Plot rich heatmap ###

# Create HeatmapList object
h <- Heatmap(t(assay(celltype_mean, "exprs")),
        column_title = "type_markers",
        col = col_exprs,
        name= "mean exprs",
        show_row_names = TRUE, 
        show_column_names = TRUE)+
    Heatmap(t(assay(cellstate_mean, "exprs")),
        column_title = "state_markers",
        col = col_exprs,
        name= "mean exprs",
        show_row_names = TRUE,
        show_column_names = TRUE)+
    ha_anno+
    ha_spatial+
    ha_meta

# Add customized legend for anno_barplot()
lgd <- Legend(title = "indication", at = colnames(indication), legend_gp = gpar(fill = metadata(spe)$color_vectors$indication))
             
# Plot
draw(h,annotation_legend_list = list(lgd))
```

## Session Info
   
```{r, echo = FALSE}
sessionInfo()
```


